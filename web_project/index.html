<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  
  <title>íƒë‚˜ëŠ”í”¼ì í™”ì„±ë‚¨ì–‘ì </title>
  
  <style>
    /* ================================================================
       [ë””ìì¸ 100% ì›ë³¸ ìœ ì§€] 
       ================================================================
    */
    :root{
      --bg: #f4f6f9; --panel: #ffffff; --panel2: #f8f9fa;
      --text: #2c3e50; --muted: #8395a7; --line: #dcdde1;
      --accent: #3498db; --good: #27ae60; --bad: #e74c3c; --warn: #f39c12;
      --shadow: 0 8px 20px rgba(0,0,0,0.08); --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{ 
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
      background: var(--bg); 
      color:var(--text); 
      min-height:100dvh;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none; touch-action: manipulation;
      padding-bottom: 20px;
    }
    input, textarea { -webkit-user-select: text; user-select: text; }

    header{ padding: 14px 18px 10px; position: sticky; top:0; background: rgba(255,255,255,.90); backdrop-filter: blur(10px); border-bottom: 1px solid var(--line); z-index:100; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1100px; margin:0 auto; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logoWrap{ display:flex; flex-direction:column; gap:4px; }
    .logo{ height: 34px; width: auto; display:block; object-fit: contain; cursor: pointer; }
    .right{ display:flex; align-items:flex-end; gap:12px; font-variant-numeric: tabular-nums; }
    .clockBlock{ text-align:right; }
    .clockBlock .time{ font-size:16px; font-weight:800; color: #2c3e50; }
    .clockBlock .date{ font-size:12px; color:var(--muted); margin-top:2px; }

    main{ max-width:1100px; margin:0 auto; padding: 14px 18px 30px; display:grid; gap:14px; }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .logo{ height: 30px; } }

    .card{ background: var(--panel); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }
    .card h2{ margin:0 0 10px; font-size: 16px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1 1 auto !important; }

    label{ font-size: 13px; color:var(--muted); display:block; margin: 4px 0 6px; }
    input, select{ width:100%; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 16px; outline:none; }
    input::placeholder{ color: #b2bec3; }
    input:focus, select:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }
    textarea{ width:100%; min-height: 120px; resize: vertical; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 15px; outline:none; }
    textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }

    .btn{ border:1px solid var(--line); background: #f1f2f6; color: var(--text); padding: 12px 14px; border-radius: 14px; font-size: 15px; font-weight: 800; cursor:pointer; user-select:none; transition: transform .05s ease; }
    .btn:active{ transform: scale(.98); }
    .btn.primary{ border-color: transparent; background: var(--accent); color: #fff; }
    .btn.good{ border-color: transparent; background: var(--good); color: #fff; }
    .btn.bad{ border-color: transparent; background: var(--bad); color: #fff; }
    .btn.warn{ border-color: transparent; background: var(--warn); color: #fff; }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 13px; font-weight: 900; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .split{ grid-template-columns: 1fr; } }
    .big-actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .big-actions .btn{ padding: 18px 14px; font-size: 18px; border-radius: 16px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border: 1px solid var(--line); border-radius: 999px; background: #f8f9fa; font-size: 13px; color: var(--muted); font-variant-numeric: tabular-nums; }
    .pill strong{ color:var(--text); }

    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius: 14px; border: 1px solid var(--line); background: #fff; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid var(--line); text-align:left; font-size: 14px; vertical-align: middle; }
    th{ color: var(--muted); font-weight: 900; background: #f1f2f6; }
    tr:last-child td{ border-bottom: none; }

    .tag{ display:inline-flex; align-items:center; justify-content:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 900; border: 1px solid var(--line); font-variant-numeric: tabular-nums; white-space: nowrap; }
    .tag.in{ border-color: transparent; color: #fff; background: var(--good); }
    .tag.out{ border-color: transparent; color: #fff; background: var(--bad); }
    .tag.open{ border-color: transparent; color: #fff; background: var(--warn); }
    .tag.juhyu { border-color: transparent; color: #d35400; background: rgba(230, 126, 34, 0.15); margin-top: 2px; width: 100%; }
    .tag.adj { border-color: var(--accent); color: var(--accent); background: rgba(52,152,219,0.1); margin-left:6px; font-size:11px; }

    .section{ display:none; }
    .section.active{ display:block; }

    .note{ margin-top:10px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: #2f3640; border: 1px solid #2f3640; border-radius: 14px; padding: 14px 18px; box-shadow: var(--shadow); font-size: 16px; color: #fff; display:none; z-index: 5000; max-width: 92vw; white-space: normal; overflow: hidden; text-overflow: clip; }
    .toast.show{ display:block; }
    .toast.danger{ background: var(--bad); border-color: var(--bad); color: #fff; }

    .modalOverlay{ position: fixed; inset:0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index: 1000; padding: 18px; backdrop-filter: blur(2px); }
    .modalOverlay.show{ display:flex; }
    .modal{ width: min(560px, 100%); border-radius: 18px; border: 1px solid var(--line); background: #fff; box-shadow: var(--shadow); padding: 14px; max-height: 85dvh; overflow-y:auto; padding-bottom: 50px; }
    .modal h3{ margin:0 0 6px; font-size: 16px; letter-spacing:.2px; }
    .modalActions{ display:flex; gap:10px; margin-top: 12px; justify-content:flex-end; flex-wrap:wrap; }
    .menuGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 12px; }
    @media (max-width: 520px){ .menuGrid{ grid-template-columns: 1fr; } }

    .countWrap{ display:flex; align-items:center; gap:14px; margin-top:12px; }
    .ring{ width:62px; height:62px; position:relative; flex:0 0 auto; }
    .ring svg{ width:62px; height:62px; display:block; }
    .ring .num{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:18px; }
    .ring .bg{ stroke: #f1f2f6; stroke-width: 8; fill: none; }
    .ring .fg{ stroke: var(--accent); stroke-width: 8; fill: none; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.15s linear; }
    .btn.cat-active{ border-color: transparent; background: var(--warn); color:#fff; }
    td.nameCell, th.nameCell { white-space: nowrap; word-break: keep-all; }
    
    .checkList{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .checkItem{ display:flex; align-items:flex-start; gap:10px; padding: 10px 10px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .checkItem input{ width:auto; margin-top:3px; }
    .checkItem .t{ font-weight: 900; font-size: 14px; }
    .admCLRow{ display:flex; gap:8px; align-items:center; padding: 8px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .admCLRow input{ flex: 1 1 auto; }
    .admCLRow .idx{ width: 28px; text-align:center; color: var(--muted); font-weight: 900; font-variant-numeric: tabular-nums; }
    
    /* ìì²´ ì—ë””í„° ìŠ¤íƒ€ì¼ */
    .editor-toolbar { display: flex; gap: 6px; padding: 8px; background: #f1f2f6; border-bottom: 1px solid #ced6e0; border-radius: 12px 12px 0 0; flex-wrap:wrap; }
    .editor-btn { 
      padding: 8px 12px; font-weight: 900; background: #fff; border: 1px solid #dcdde1; border-radius: 8px; cursor: pointer; font-size:14px; flex: 0 0 auto; 
      min-width: 40px; min-height: 40px; display:flex; align-items:center; justify-content:center;
    }
    .editor-btn:active { background: #e2e6ea; transform:scale(0.95); }
    .editor-content { min-height: 250px; max-height: 400px; overflow-y: auto; padding: 12px; border: 1px solid #ced6e0; border-top: none; border-radius: 0 0 12px 12px; outline: none; background: #fff; -webkit-user-select: text; user-select: text; white-space: pre-wrap; line-height: 1.5; font-size:16px; }
    .editor-content:focus { box-shadow: inset 0 0 0 2px rgba(52,152,219,.15); }
    .editor-content ul { padding-left: 20px; margin: 8px 0; }
    .editor-content li { list-style-type: disc; margin-bottom: 4px; }
    .editor-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 4px 0; }
    .editor-content table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    .editor-content td { border: 1px solid #dcdde1; padding: 8px; vertical-align: top; }

    /* Z-Index ë° íŒì—… ì„¤ì • */
    #adminMenuOverlay { z-index: 1000 !important; }
    #actionLogOverlay, #empEditOverlay, #logEditOverlay, #logAddOverlay { z-index: 2000 !important; }
    #noticeOverlay, #closeCheckOverlay, #outNoteOverlay, .toast { z-index: 5000 !important; }
    #pinOverlay { z-index: 9999 !important; }
    
    #sec-emp .grid{ grid-template-columns: 1fr !important; }
    #sec-emp .card{ border-radius: 22px; }
    #sec-emp h2{ font-size: 22px; }
    #sec-emp table{ min-width: 860px; }

    .calHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .calGrid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .calCellHeader{ text-align:center; font-weight:900; color:var(--muted); font-size:13px; padding-bottom:6px; }
    .calDay{ min-height: 80px; background: #fff; border: 1px solid var(--line); border-radius: 12px; padding: 6px 8px; display:flex; flex-direction:column; gap:4px; position:relative; }
    .calDay.empty{ background:none !important; border:none; }
    .calDay.today{ border-color: var(--accent); background: rgba(52,152,219,.05) !important; }
    .calNum{ font-size:14px; font-weight:800; color:var(--muted); }
    .calData{ margin-top: auto; text-align:right; }
    .calTime{ font-size: 13px; font-weight: 800; color: var(--text); display:block; }
    .calPay{ font-size: 11px; color: var(--good); font-weight: 700; display:block; margin-top:2px; }
    .calDay:hover{ background: #f8f9fa !important; }

    .totalWageBox { background: var(--panel2); border: 2px solid var(--accent); border-radius: 14px; padding: 16px; text-align:center; margin-bottom: 14px; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .totalWageLabel { color: var(--muted); font-size: 13px; font-weight: 800; }
    .totalWageValue { color: var(--text); font-size: 20px; font-weight: 900; }
    .totalWageDetail { color: var(--good); font-size: 13px; font-weight: 700; }
    
    #syncStatus { position:fixed; top:5px; right:5px; font-size:10px; color:#fff; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; z-index:9999; }
    #quickButtons { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    #quickButtons .btn { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 16px; }
    #quickButtons .btn .muted { font-size: 12px; font-weight: normal; }
    
    .date-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: #e3f2fd; color: var(--accent); border-radius: 20px; font-size: 13px; font-weight: 700; margin: 2px; }
    .date-pill button { background: none; border: none; color: var(--accent); font-weight: 900; font-size: 12px; cursor: pointer; padding: 0; }
  </style>
</head>

<body>
<div id="syncStatus">ì„œë²„ ì—°ê²° ì¤‘...</div>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap"><img id="logoImg" class="logo" alt="ê°€ê²Œ ë¡œê³ " src="tamnayo.png" /></div>
    </div>
    <div class="right">
      <div class="clockBlock"><div class="time" id="nowTime">--:--:--</div><div class="date" id="nowDate">----</div></div>
    </div>
  </div>
</header>

<main>
  <section class="section active" id="sec-att">
    <div class="grid">
      <div class="card">
        <h2>ì¶œê·¼ / í‡´ê·¼ ì°ê¸°</h2>
        <div class="split">
          <div><label>ì•Œë°” ì½”ë“œ (ìë™ ì…ë ¥)</label><input id="attCode" inputmode="numeric" autocomplete="off" placeholder="ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" maxlength="4" readonly /></div>
          <div><label>ì´ë¦„ (ìë™ í‘œì‹œ)</label><input id="attName" disabled placeholder="-" /></div>
        </div>
        <div class="big-actions"><button class="btn good" id="btnIn">ì¶œê·¼</button><button class="btn bad" id="btnOut">í‡´ê·¼</button></div>
        <div class="row" style="margin-top:10px;">
          <span class="pill">ìƒíƒœ: <strong id="attStatus">-</strong></span>
          <span class="pill">ë§ˆì§€ë§‰ ê¸°ë¡: <strong id="attLast">-</strong></span>
          <span class="spacer"></span>
          <button class="btn small" id="btnClearCode">ì§€ìš°ê¸°</button>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:12px;">
          <div style="flex:1 1 100%;">
            <div class="muted" style="font-size:13px; font-weight:900;">ë¹ ë¥¸ ì„ íƒ</div>
            <div id="quickButtons" style="margin-top:8px;"></div>
            <div class="note">
              â€¢ ë³¸ì¸ ì´ë¦„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì½”ë“œê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.<br/>
              â€¢ ì¶œí‡´ê·¼ ëˆ„ë½ ì‹œ <b>ì‚¬ì¥ë‹˜ê»˜ ë§ì”€í•´ì£¼ì„¸ìš”.</b>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>ìµœê·¼ ê¸°ë¡ (ìµœì‹  15ê°œ)</h2>
        <div style="overflow:auto; max-height: 520px;">
          <table>
            <thead><tr><th style="width:90px;">ìœ í˜•</th><th style="width:90px;">ì½”ë“œ</th><th class="nameCell">ì´ë¦„</th><th style="width:200px;">ì‹œê°„</th></tr></thead>
            <tbody id="recentTable"></tbody>
          </table>
        </div>
        <div class="note">ìµœê·¼ ê¸°ë¡ì€ ëˆ„ë½ ë°©ì§€ë¥¼ ìœ„í•œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-emp">
    <div class="card">
      <div class="row"><h2 style="margin:0;">ì•Œë°”ìƒ ê´€ë¦¬ (ê´€ë¦¬ì)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromEmp">â† ì¶œê·¼/í‡´ê·¼</button></div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card" style="box-shadow:none;">
          <h2>ì•Œë°”ìƒ ë“±ë¡</h2>
          <div class="split">
            <div><label>ì´ë¦„</label><input id="empName" placeholder="ì˜ˆ) í™ê¸¸ë™" maxlength="30" /></div>
            <div><label>ë©”ëª¨ (ì„ íƒ)</label><input id="empMemo" placeholder="ì˜ˆ) ì£¼ë§ë§Œ" maxlength="60" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>ê·¼ë¬´ êµ¬ë¶„</label><select id="empShiftType"><option value="MID">ë¯¸ë“¤</option><option value="CLOSE">ë§ˆê°</option></select></div>
            <div><label>í‰ì¼ ì‹œê¸‰</label><input id="empWage" type="number" placeholder="ì˜ˆ) 10030" inputmode="numeric" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label style="color:var(--warn)">ì£¼ë§ ì‹œê¸‰ (í† ,ì¼)</label><input id="empWageWeekend" type="number" placeholder="ì„ íƒ (ë¹„ì›Œë‘ë©´ í‰ì¼ë™ì¼)" inputmode="numeric" /></div>
            <div></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>ê·¼ë¬´ ì‹œì‘ ì‹œê°„</label><input id="empWorkStart" type="time" value="17:00" /></div>
            <div><label>ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</label><input id="empWorkEnd" type="time" value="23:30" /></div>
          </div>
          <div class="row" style="margin-top:10px;"><button class="btn primary" id="btnAddEmp">ë“±ë¡</button><span class="muted" id="nextCodeHint"></span></div>
        </div>
        <div class="card" style="box-shadow:none;">
          <h2>ì•Œë°”ìƒ ì¡°íšŒ / ì‚­ì œ</h2>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1 1 260px;"><label>ê²€ìƒ‰</label><input id="empSearch" placeholder="ì˜ˆ) 0002 ë˜ëŠ” ê¸¸ë™" /></div>
            <div class="spacer"></div><button class="btn small" id="btnRefreshEmp">ìƒˆë¡œê³ ì¹¨</button>
          </div>
          <div style="overflow:auto; max-height: 520px;">
            <table>
              <thead><tr><th style="width:90px;">ì½”ë“œ</th><th class="nameCell" style="width:160px;">ì´ë¦„</th><th style="width:90px;">êµ¬ë¶„</th><th>ì‹œê¸‰(í‰/ì£¼)</th><th>ê·¼ë¬´ì‹œê°„</th><th style="width:110px;">ì‚­ì œ</th></tr></thead>
              <tbody id="empTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-log">
    <div class="card">
      <div class="row"><h2 style="margin:0;">ê·¼íƒœ ì¡°íšŒ (ê´€ë¦¬ì)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromLog">â† ì¶œê·¼/í‡´ê·¼</button></div>
      <div class="hr"></div>
      <div class="row" style="margin-bottom:10px; gap:10px; flex-wrap:wrap;">
        <span class="pill">ì „ì²´ ê¸°ë¡: <strong id="logTotal">0</strong>ê±´</span>
        <label class="muted" style="display:flex; align-items:center; gap:8px;">ì•Œë°”ìƒ í•„í„°<select id="logFilterEmp" style="min-width:180px;"></select></label>
        <div class="spacer"></div>
        <button class="btn small" id="btnAddShift">ê·¼ë¬´ ì¶”ê°€</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display:none;" />
        <button class="btn small good" id="btnImportCsv">CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn small warn" id="btnExportCsv">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="hr"></div>
      
      <div class="totalWageBox">
        <div class="totalWageLabel" id="totalWageTitle">--ì›” ì˜ˆìƒ ê¸‰ì—¬</div>
        <div class="totalWageValue" id="totalWageAmount">0ì›</div>
        <div class="totalWageDetail" id="totalWageDetail">(ê¸°ë³¸ 0 + ì£¼íœ´ 0)</div>
      </div>

      <div class="calHeader">
        <button class="btn small" id="calPrevBtn">â—€ ì´ì „ë‹¬</button>
        <h3 id="calTitle" style="margin:0; font-size:18px;">202X. XX</h3>
        <button class="btn small" id="calNextBtn">ë‹¤ìŒë‹¬ â–¶</button>
      </div>
      <div class="calGrid" id="calendarView"></div>
      
      <div class="note" style="margin:14px 0;">â€¢ ì¼ìš”ì¼ì— í•´ë‹¹ ì£¼ì˜ ì£¼íœ´ìˆ˜ë‹¹(15ì‹œê°„â†‘)ì´ í‘œì‹œë©ë‹ˆë‹¤.<br/>â€¢ í‰ì¼ ê³µíœ´ì¼ì€ 1.5ë°° ì‹œê¸‰ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.</div>
      
      <div style="overflow:auto; max-height: 540px;">
        <table>
          <thead><tr><th style="width:110px;">ìœ í˜•</th><th style="width:90px;">ì½”ë“œ</th><th class="nameCell" style="width:160px;">ì´ë¦„</th><th style="width:220px;">ì‹œê°„</th><th>ë¹„ê³ </th><th style="width:90px;">ìˆ˜ì •</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">í‡´ê·¼ íŠ¹ì´ì‚¬í•­ (ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œì™¸)</div>
      <div style="overflow:auto; max-height: 360px;">
        <table>
          <thead><tr><th style="width:70px;">ìˆœë²ˆ</th><th style="width:110px;">ë‚ ì§œ</th><th style="width:90px;">ì½”ë“œ</th><th style="width:140px;">ì‘ì„±ì</th><th style="width:180px;">ì‹œê°„</th><th>ë‚´ìš©</th></tr></thead>
          <tbody id="outNoteTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸ ê¸°ë¡</div>
      <div style="overflow:auto; max-height: 280px;">
        <table>
          <thead><tr><th style="width:70px;">ìˆœë²ˆ</th><th style="width:110px;">ë‚ ì§œ</th><th style="width:90px;">ì½”ë“œ</th><th style="width:140px;">ì‘ì„±ì</th><th style="width:180px;">ì‹œê°„</th><th>ì²´í¬</th></tr></thead>
          <tbody id="closeCheckTable"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<div class="modalOverlay" id="adminMenuOverlay" role="dialog" aria-modal="true" style="z-index: 1000;">
  <div class="modal">
    <h3>ê´€ë¦¬ì ë©”ë‰´</h3>
    <div class="muted" id="adminStateText">ê´€ë¦¬ì ëª¨ë“œ (PIN ì—†ìŒ)</div>
    <div class="hr"></div>
    <div class="menuGrid">
      <button class="btn primary" id="goEmp">ì•Œë°”ìƒ ê´€ë¦¬</button>
      <button class="btn primary" id="goLog">ê·¼íƒœ ì¡°íšŒ</button>
      <button class="btn warn" id="btnExportCsv2">CSV ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="btnOpenActionLog">ì‹œìŠ¤í…œ ë¡œê·¸</button>
      <button class="btn" id="btnLockAdmin">ê´€ë¦¬ì ë©”ë‰´ ë‹«ê¸°</button>
    </div>
    
    <div class="hr"></div>
    <div class="muted" style="font-size:13px; font-weight:900;">í…”ë ˆê·¸ë¨ ì—°ë™ ì„¤ì •</div>
    <div class="row" style="margin-top:8px;">
        <input id="adminTgChatId" placeholder="Chat ID (ìˆ«ì)" style="flex:1;" />
        <button class="btn small primary" id="btnSaveTgId">ì €ì¥</button>
        <button class="btn small good" id="btnAutoTgId">ë‚´ ID ìë™ì°¾ê¸°</button>
    </div>
    <div class="note" style="margin-top:4px;">* ìë™ì°¾ê¸°: ë´‡ì—ê²Œ ë¨¼ì € ì•„ë¬´ ë§ì´ë‚˜ ë³´ë‚´ê³  ëˆ„ë¥´ì„¸ìš”.</div>
    <label class="row" style="margin-top:8px; gap:8px; align-items:center;">
      <input id="tgSystemLogEnabled" type="checkbox" />
      <span class="muted" style="font-size:12px;">ì‹œìŠ¤í…œ ë¡œê·¸(ë²„íŠ¼ í´ë¦­/ì¶œí‡´ê·¼ ì‹œë„) í…”ë ˆê·¸ë¨ ì „ì†¡</span>
    </label>
    
    <div class="hr"></div>
    <div class="muted" style="font-size:13px; font-weight:900;">ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸ í¸ì§‘</div>
    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
      <div style="flex: 2 1 240px;"><label>í•­ëª© ì¶”ê°€</label><input id="adminCloseNewItem" placeholder="ì˜ˆ) í¬ìŠ¤ ë§ˆê° ì •ì‚°" maxlength="60" /></div>
      <div style="flex: 0 0 auto; align-self:flex-end; display:flex; gap:8px;">
        <button class="btn" id="btnAddCloseChecklistItem">ì¶”ê°€</button>
        <button class="btn primary" id="btnSaveCloseChecklist">ì €ì¥</button>
        <button class="btn" id="btnResetCloseChecklist">ê¸°ë³¸ê°’</button>
      </div>
    </div>
    <div id="adminCloseChecklistList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
    
    <div class="hr"></div>
    <div class="muted" style="margin-top:10px; font-size:13px; font-weight:900;">ì˜¤ëŠ˜ì˜ ê³µì§€ (ìì²´ ì—ë””í„°)</div>
    <div class="row" style="margin-top:8px; align-items:center;">
      <label style="margin:0;">ìœ ì§€ ì‹œê°„(ì´ˆ):</label>
      <input id="adminNoticeDuration" type="number" value="5" style="width:60px; text-align:center;" />
    </div>

    <div style="margin-top:8px; border:1px solid #ced6e0; border-radius:12px; overflow:hidden;">
      <div class="editor-toolbar">
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('bold')" title="êµµê²Œ"><b>B</b></button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('underline')" title="ë°‘ì¤„" style="text-decoration:underline;">U</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('foreColor', '#e74c3c')" title="ë¹¨ê°„ìƒ‰" style="color:#e74c3c; font-weight:900;">A</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('foreColor', '#000000')" title="ê²€ì •ìƒ‰" style="color:#000000; font-weight:900;">A</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('fontSize', '5')" title="í¬ê²Œ">ê°€</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" title="ë¦¬ìŠ¤íŠ¸">â—</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); insertTable()" title="í‘œ ì‚½ì…">â–¦</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); document.getElementById('imgUploadInput').click()" title="ì´ë¯¸ì§€ ì‚½ì…">ğŸ–¼ï¸</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('removeFormat')" title="ì´ˆê¸°í™”">ì§€ìš°ê¸°</button>
      </div>
      <div id="adminNoticeInput" class="editor-content" contenteditable="true" inputmode="text"></div>
      <input type="file" id="imgUploadInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
    </div>
    
    <div style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:10px; border:1px solid var(--line);">
        <div class="row" style="margin-bottom:6px;">
            <span class="muted" style="font-size:12px; font-weight:700;">ìì£¼ ì“°ëŠ” ë¬¸êµ¬ ë³´ê´€í•¨</span>
            <div class="spacer"></div>
            <button class="btn small good" id="btnSaveTemplate">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        </div>
        <div id="templateList" style="max-height:120px; overflow-y:auto; display:flex; flex-direction:column; gap:4px;"></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="btnSaveTodayNotice">ì˜¤ëŠ˜ ê³µì§€ ì €ì¥</button>
      <button class="btn" id="btnClearTodayNotice">ì˜¤ëŠ˜ ê³µì§€ ë¹„ìš°ê¸°</button>
    </div>
  </div>
</div>


<div class="modalOverlay" id="actionLogOverlay" style="z-index: 2000;">
  <div class="modal" style="width: 100%; max-width: 700px;">
    <h3>ì‹œìŠ¤í…œ ë¡œê·¸ (í„°ì¹˜ ê¸°ë¡)</h3>
    <div class="muted">ìµœê·¼ 100ê°œì˜ í„°ì¹˜/ë™ì‘ ê¸°ë¡ì…ë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div style="max-height:500px; overflow-y:auto;">
      <table style="width:100%;">
        <thead><tr><th>ì‹œê°„</th><th>ë™ì‘</th><th>ìƒì„¸</th></tr></thead>
        <tbody id="actionLogTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px; text-align:right;">
      <button class="btn" id="btnCloseActionLog">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="noticeOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ì˜¤ëŠ˜ì˜ ê³µì§€</h3>
    <div class="muted" id="noticeDateText">-</div>
    <div class="hr"></div>
    <div id="noticeText" class="editor-content" style="border:none; padding:0; min-height:auto;"></div>
    <div class="countWrap">
      <div class="ring"><svg viewBox="0 0 80 80"><circle class="bg" cx="40" cy="40" r="30"></circle><circle class="fg" id="noticeRing" cx="40" cy="40" r="30"></circle></svg><div class="num" id="noticeNum">5</div></div>
    </div>
    <div class="modalActions"><button class="btn primary" id="noticeOk" disabled>ìˆ™ì§€í•˜ì˜€ìŠµë‹ˆë‹¤</button></div>
  </div>
</div>

<div class="modalOverlay" id="outNoteOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ì˜¤ëŠ˜ì˜ íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</h3>
    <div class="muted" id="outNoteDesc">í‡´ê·¼ ì €ì¥ ì „ì— íŠ¹ì´ì‚¬í•­ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</div>
    <div class="hr"></div>
    <label>íŠ¹ì´ì‚¬í•­</label>
    <div class="row" style="gap:8px; margin:8px 0 10px;">
      <button class="btn small" type="button" data-cat="ëˆ„ë½">ëˆ„ë½</button>
      <button class="btn small" type="button" data-cat="í™˜ë¶ˆ">í™˜ë¶ˆ</button>
      <button class="btn small" type="button" data-cat="ë¬¼í’ˆ">ë¬¼í’ˆ</button>
      <button class="btn small" type="button" data-cat="ê¸°íƒ€">ê¸°íƒ€</button>
    </div>
    <textarea id="outNoteText" placeholder="ì˜ˆ)&#10;[í™˜ë¶ˆ] 18:20 ìŒë£Œ ëˆ„ë½ í™˜ë¶ˆ&#10;[ì¬ê³ ] ê³ ë¬´ì¥ê°‘ ì—†ìŒ&#10;[ê¸°íƒ€] 17:55 í˜„ê¸ˆê²°ì œ or ê±´ì˜ì‚¬í•­&#10;&#10;ê·¼ë¬´ ì¤‘ ë°œìƒí•œ íŠ¹ì´ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.&#10;íŠ¹ì´ì‚¬í•­ì´ ì—†ë‹¤ë©´ ê±´ë„ˆë›°ê¸°!"></textarea>
    <div class="modalActions">
      <button class="btn" id="outNoteSkip">ê±´ë„ˆë›°ê¸°</button>
      <button class="btn primary" id="outNoteSave">ì €ì¥ í›„ í‡´ê·¼</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="empEditOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ì•Œë°”ìƒ ì •ë³´ ìˆ˜ì •</h3>
    <div class="muted">ì´ë¦„/êµ¬ë¶„/ê·¼ë¬´ì‹œê°„/ì‹œê¸‰/ë©”ëª¨ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì½”ë“œ</label><input id="empEditCode" readonly /></div>
      <div><label>ì´ë¦„</label><input id="empEditName" placeholder="ì˜ˆ) í™ê¸¸ë™" maxlength="20" /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div>
        <label>ê·¼ë¬´ êµ¬ë¶„</label>
        <select id="empEditShiftType"><option value="MID">ë¯¸ë“¤</option><option value="CLOSE">ë§ˆê°</option></select>
      </div>
      <div>
        <label>í‰ì¼ ì‹œê¸‰</label>
        <input id="empEditWage" type="number" placeholder="ìˆ«ìë§Œ ì…ë ¥" />
      </div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label style="color:var(--warn)">ì£¼ë§ ì‹œê¸‰ (í† ,ì¼)</label><input id="empEditWageWeekend" type="number" placeholder="ì„ íƒ" /></div>
      <div></div>
    </div>
    <label>ë©”ëª¨</label>
    <input id="empEditMemo" placeholder="ë©”ëª¨(ì„ íƒ)" maxlength="30" />
    <div class="split" style="margin-top:10px;">
      <div><label>ê·¼ë¬´ ì‹œì‘</label><input id="empEditWorkStart" type="time" /></div>
      <div><label>ê·¼ë¬´ ì¢…ë£Œ</label><input id="empEditWorkEnd" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="empEditCancel">ì·¨ì†Œ</button>
      <button class="btn primary" id="empEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logAddOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ê·¼ë¬´ ì¶”ê°€</h3>
    <div class="muted">ëˆ„ë½ëœ ê·¼ë¬´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤. (ê´€ë¦¬ì)</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì•Œë°”ìƒ</label><select id="logAddEmp"></select></div>
      <div>
        <label>ì¶”ê°€ ìœ í˜•</label>
        <select id="logAddMode"><option value="SHIFT">ì¶œê·¼+í‡´ê·¼</option><option value="IN">ì¶œê·¼ë§Œ</option><option value="OUT">í‡´ê·¼ë§Œ</option></select>
      </div>
    </div>
    
    <div style="margin-top:10px;">
      <label>ë‚ ì§œ (ì—¬ëŸ¬ ê°œ ì„ íƒ í›„ [ë‹´ê¸°] ëˆ„ë¥´ì„¸ìš”)</label>
      <div class="row">
        <input id="logAddDate" type="date" style="flex:1;" />
        <button class="btn small" id="btnPushDate" style="flex:0 0 auto;">ë‹´ê¸°</button>
      </div>
      <div id="selectedDateList" style="margin-top:8px; padding:4px; border:1px solid var(--line); border-radius:10px; min-height:40px; display:flex; flex-wrap:wrap; gap:4px; background:#f8f9fa;">
        <span class="muted" style="font-size:12px; padding:4px;">ë‚ ì§œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”</span>
      </div>
    </div>

    <div class="split" style="margin-top:10px;">
      <div><label>ë¹„ê³ </label><input id="logAddNote" placeholder="ì˜ˆ) ëˆ„ë½ ë³´ì •" maxlength="60" /></div>
      <div></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì¶œê·¼ ì‹œê°„</label><input id="logAddInTime" type="time" /></div>
      <div><label>í‡´ê·¼ ì‹œê°„</label><input id="logAddOutTime" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="logAddCancel">ì·¨ì†Œ</button>
      <button class="btn primary" id="logAddSave">ì¶”ê°€</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logEditOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì •</h3>
    <div class="muted">ì‹œê°„/ìœ í˜•/ë¹„ê³ ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì½”ë“œ</label><input id="logEditCode" readonly /></div>
      <div><label>ì´ë¦„</label><input id="logEditName" readonly /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>ìœ í˜•</label><select id="logEditType"><option value="IN">ì¶œê·¼</option><option value="OUT">í‡´ê·¼</option></select></div>
      <div><label>ì‹œê°„ (ì´ˆ ë‹¨ìœ„ ê°€ëŠ¥)</label><input id="logEditTs" type="datetime-local" step="1" /></div>
    </div>
    <label style="margin-top:10px;">ë¹„ê³ </label>
    <textarea id="logEditNote" placeholder="ì˜ˆ) ì¡°í‡´ / ë³‘ì› / íŠ¹ì´ì‚¬í•­"></textarea>
    <div class="modalActions">
      <button class="btn" id="logEditCancel">ì·¨ì†Œ</button>
      <button class="btn bad" id="logEditDelete">ì‚­ì œ</button>
      <button class="btn primary" id="logEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="closeCheckOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
    <div class="muted">ë§ˆê° í•­ëª©ì„ ì²´í¬í•œ ë’¤ í‡´ê·¼ì„ ì™„ë£Œí•˜ì„¸ìš”.</div>
    <div class="hr"></div>
    <div id="closeCheckList" class="checkList"></div>
    <div class="modalActions" style="margin-top:20px;">
      <button class="btn primary" id="closeCheckDone" disabled>ì™„ë£Œ í›„ í‡´ê·¼</button>
    </div>
  </div>
</div>

<input id="restoreInput" type="file" accept="application/json" style="display:none;" />

<script type="module">
  // [ì¤‘ìš”] getToday í•¨ìˆ˜ë¥¼ ê°€ì¥ ë¨¼ì € ì •ì˜í•´ì„œ ì—ëŸ¬ ë°©ì§€
  window.getToday = function() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };

  // -------------------------------------------------------------
  // [í…”ë ˆê·¸ë¨ ì—°ë™ ì½”ë“œ ìœ ì§€]
  // -------------------------------------------------------------
  const TG_TOKEN = "7735983028:AAGgXPT18XIeBHC4C_sjKrSKSbNqQsT0ZN0";
  const LS_TG_CHAT_ID = "ALBA_TG_CHAT_ID";
  const TG_SYSTEM_LOG_KEY = "TG_SYSTEM_LOG_ENABLED";
  const ADMIN_PIN_KEY = "ADMIN_PIN";

  function isSystemLogTelegramEnabled() {
    return !!window.loadJSON?.(TG_SYSTEM_LOG_KEY, false);
  }

  function setSystemLogTelegramEnabled(enabled) {
    window.saveJSON?.(TG_SYSTEM_LOG_KEY, !!enabled);
  }

  // ê´€ë¦¬ì ë©”ë‰´ì—ì„œ ID ì €ì¥ ë²„íŠ¼ìš© í•¨ìˆ˜
window.saveTgId = function() {
    const v = document.getElementById("adminTgChatId").value.trim();
    if (!v) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    
    // [ìˆ˜ì •] ê¸°ê¸°ê°€ ì•„ë‹Œ ì„œë²„(Firebase)ì— ì €ì¥
    window.saveJSON('adminChatId', v); 
    alert("í…”ë ˆê·¸ë¨ IDê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì•Œë¦¼ì´ ì˜µë‹ˆë‹¤.");
};

window.sendTelegramAlert = async function(text) {
    // [ìˆ˜ì •] localStorage ëŒ€ì‹  ì„œë²„ ë°ì´í„°(SERVER_CACHE)ì—ì„œ ë¶ˆëŸ¬ì˜´
    const chatId = window.loadJSON('adminChatId', null); 
    const TG_TOKEN = "7735983028:AAGgXPT18XIeBHC4C_sjKrSKSbNqQsT0ZN0"; 

    if (!chatId) {
        console.log("í…”ë ˆê·¸ë¨ Chat IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, text: text })
        });
    } catch (e) {
        console.error("í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:", e);
    }
};

  document.getElementById("btnAutoTgId").addEventListener("click", async () => {
      try {
          const url = `https://api.telegram.org/bot${TG_TOKEN}/getUpdates`;
          const res = await fetch(url);
          const data = await res.json();
          if(data.ok && data.result.length > 0) {
              const lastMsg = data.result[data.result.length - 1];
              const myId = lastMsg.message.chat.id;
              document.getElementById("adminTgChatId").value = myId;
              localStorage.setItem(LS_TG_CHAT_ID, myId);
              alert(`ID ì°¾ìŒ: ${myId}`);
          } else { alert("ë©”ì‹œì§€ ì—†ìŒ. ë´‡ì—ê²Œ ë§ì„ ê±´ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."); }
      } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
  });

  // -------------------------------------------------------------
  // [Firebase ë° ê¸°ë³¸ ì„¤ì •]
  // -------------------------------------------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = { apiKey: "AIzaSyAbdEqVxEOcA3qFEcYEH9yuvNRx_CTMxhE", authDomain: "tamna-hr.firebaseapp.com", projectId: "tamna-hr", storageBucket: "tamna-hr.firebasestorage.app", messagingSenderId: "766306504997", appId: "1:766306504997:web:3e4e77bc14101cd6660acc" };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let SERVER_CACHE = {}; 
  let logAddDates = []; 

  // [ê³µíœ´ì¼ ë°ì´í„°]
  // í•˜ë“œì½”ë”©ì€ ë°±ì—…ìœ¼ë¡œë§Œ ë‘ê³ , ê¸°ë³¸ì€ ê³µíœ´ì¼ API(Nager.Date)ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
  const HOLIDAY_CACHE_KEY = "HOLIDAY_CACHE_V1";
  const HOLIDAYS_FALLBACK = ["2024-01-01","2024-02-09","2024-02-10","2024-02-11","2024-02-12","2024-03-01","2024-04-10","2024-05-05","2024-05-06","2024-05-15","2024-06-06","2024-08-15","2024-09-16","2024-09-17","2024-09-18","2024-10-03","2024-10-09","2024-12-25","2025-01-01","2025-01-28","2025-01-29","2025-01-30","2025-03-01","2025-05-05","2025-05-06","2025-06-06","2025-08-15","2025-10-03","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-12-25","2026-01-01","2026-02-16","2026-02-17","2026-02-18","2026-03-01","2026-05-05","2026-05-24","2026-05-25","2026-06-06","2026-08-15","2026-09-24","2026-09-25","2026-09-26","2026-10-03","2026-10-09","2026-12-25"];
  let HOLIDAY_CACHE = {};
  const HOLIDAY_LOADING = new Set();

  function getFallbackHolidaysByYear(year) {
    const y = String(year);
    return HOLIDAYS_FALLBACK.filter(d => d.startsWith(`${y}-`));
  }

  function getHolidayListByYear(year) {
    const y = String(year);
    if (Array.isArray(HOLIDAY_CACHE[y]) && HOLIDAY_CACHE[y].length) return HOLIDAY_CACHE[y];
    return getFallbackHolidaysByYear(y);
  }

  function isHoliday(dateStr) {
    const y = String(dateStr).slice(0, 4);
    return getHolidayListByYear(y).includes(dateStr);
  }

  async function syncHolidayYear(year) {
    const y = String(year);
    if (HOLIDAY_LOADING.has(y)) return;
    HOLIDAY_LOADING.add(y);
    try {
      const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${y}/KR`);
      if (!res.ok) return;
      const data = await res.json();
      const dates = Array.isArray(data) ? data.map(x => x.date).filter(Boolean) : [];
      if (!dates.length) return;
      HOLIDAY_CACHE[y] = Array.from(new Set(dates));
      await saveJSON(HOLIDAY_CACHE_KEY, HOLIDAY_CACHE);
      if (typeof renderCalendar === "function") renderCalendar();
    } catch (e) {
      console.warn("ê³µíœ´ì¼ API ë™ê¸°í™” ì‹¤íŒ¨:", e);
    } finally {
      HOLIDAY_LOADING.delete(y);
    }
  }

  // [ì—ë””í„° ê¸°ëŠ¥ ìœ ì§€]
  window.execCmd = function(command, value = null) { document.execCommand(command, false, value); };
  window.insertTable = function() { const html = `<table style="width:100%; border-collapse:collapse; margin:8px 0;"><tbody><tr><td style="border:1px solid #dcdde1; padding:8px;">í•­ëª©</td><td style="border:1px solid #dcdde1; padding:8px;">ë‚´ìš©</td></tr></tbody></table><br/>`; document.execCommand('insertHTML', false, html); };
  window.handleImageUpload = function(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.execCommand('insertImage', false, e.target.result); }; reader.readAsDataURL(input.files[0]); } input.value = ''; };
  
  window.recordAction = function(action, detail) {
    const now = Date.now();
    const logs = loadJSON('ACTION_LOGS', []);
    logs.push({ ts: now, time: fmtTS(now), action: action, detail: detail });
    if(logs.length > 200) logs.shift();
    saveJSON('ACTION_LOGS', logs);

    if (isSystemLogTelegramEnabled()) {
      sendTelegramAlert(`[ì‹œìŠ¤í…œë¡œê·¸] ${fmtTS(now)}\n${action}\n${detail || '-'}`);
    }
  };

  onValue(ref(db, 'tamnaData'), (snapshot) => {
    const data = snapshot.val();
    if (data) {
      SERVER_CACHE = data;
      try {
        HOLIDAY_CACHE = loadJSON(HOLIDAY_CACHE_KEY, HOLIDAY_CACHE) || HOLIDAY_CACHE;
        if(typeof renderAttendancePanel === 'function') renderAttendancePanel();
        if(typeof renderLogAll === 'function') { renderLogFilterOptions(); renderLogAll(); }
        if(typeof renderEmployees === 'function') renderEmployees();
        
        let status = document.getElementById('syncStatus');
        if(!status) { status = document.createElement('div'); status.id = 'syncStatus'; document.body.appendChild(status); }
        status.textContent = "â— ì„œë²„ ë™ê¸°í™”ë¨"; status.style.background = "rgba(39, 174, 96, 0.8)";
      } catch(e) {}
    }
  });

    window.saveJSON = async function(key, val) {
      SERVER_CACHE[key] = val;
      await update(ref(db, 'tamnaData'), { [key]: val });
  };
  window.loadJSON = function(key, fallback) {
    return Object.prototype.hasOwnProperty.call(SERVER_CACHE, key) ? SERVER_CACHE[key] : fallback;
  };

  const LS_KEYS = { DAILY_NOTICE: "ALBA_DAILY_NOTICE_V1", OUT_NOTES: "ALBA_OUT_NOTES_V1", CLOSE_CHECKLIST: "ALBA_CLOSE_CHECKLIST_V1", CLOSE_CHECK_LOGS: "ALBA_CLOSE_CHECK_LOGS_V1", EMPLOYEES: "ALBA_EMPLOYEES_V2", NEXT_ID: "ALBA_NEXT_EMP_ID_V2", ATT_LOGS: "ALBA_ATT_LOGS_V2" };

  function pad4(n){ return String(n).length>=4?String(n):("0000"+n).slice(-4); }
  function nowTS(){ return Date.now(); }
  function dateKey(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  function todayKey(){ return dateKey(Date.now()); }
  function fmtTS(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`; }
  function toast(msg,type){ const el=document.getElementById("toast"); el.textContent=msg; el.className="toast show "+(type==="danger"?"danger":""); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"),2200); }
  function escapeHtml(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
  function normalizeCodeInput(v){ return (v||"").replace(/\D/g,"").slice(0,4); }

  (function disableDoubleTapZoom(){ let lastTouchEnd=0; document.addEventListener('touchend',function(e){ const now=Date.now(); if(now-lastTouchEnd<=300)e.preventDefault(); lastTouchEnd=now; },{passive:false}); })();

  function getEmployees(){ return loadJSON(LS_KEYS.EMPLOYEES, []); }
  function setEmployees(list){ saveJSON(LS_KEYS.EMPLOYEES, list); }
  function getNextEmpId(){ const v=loadJSON(LS_KEYS.NEXT_ID, 1); const n=v?Number(v):1; return Number.isFinite(n)&&n>=1?Math.floor(n):1; }
  function setNextEmpId(n){ saveJSON(LS_KEYS.NEXT_ID, String(n)); }
  function getLogs(){ return loadJSON(LS_KEYS.ATT_LOGS, []); }
  function setLogs(list){ saveJSON(LS_KEYS.ATT_LOGS, list); }
  function findEmpByCode(code){ return getEmployees().find(e=>e.code===code)||null; }
  
  function getNoticeMap(){ return loadJSON(LS_KEYS.DAILY_NOTICE, {}); }
  function setNoticeMap(map){ saveJSON(LS_KEYS.DAILY_NOTICE, map); }
  function getTodayNotice(){ return getNoticeMap()[todayKey()]?.text || ""; }
  function getTodayNoticeDuration(){ return getNoticeMap()[todayKey()]?.duration || 5; }
  function setTodayNotice(text, duration=5){ const m=getNoticeMap(); m[todayKey()]={text:String(text||""), duration: Number(duration), updatedAt:nowTS()}; setNoticeMap(m); }
  function clearTodayNotice(){ const m=getNoticeMap(); delete m[todayKey()]; setNoticeMap(m); }

  function getTemplates() { return loadJSON('NOTICE_TEMPLATES', []); }
  function renderTemplates() {
    const list = getTemplates();
    const container = document.getElementById('templateList');
    if(!list.length) { container.innerHTML = '<span class="muted" style="font-size:11px; padding:4px;">ì €ì¥ëœ ë¬¸êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; return; }
    container.innerHTML = list.map((t, i) => `<div style="display:flex; align-items:center; background:#fff; border:1px solid #dcdde1; padding:6px; border-radius:8px;"><div style="flex:1; font-size:12px; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" onclick="window.applyTemplate(${i})">${t.replace(/<[^>]*>/g, '') || '(ì´ë¯¸ì§€/í‘œ)'}</div><button class="btn small bad" onclick="window.deleteTemplate(${i})" style="padding:2px 6px; font-size:10px; margin-left:4px;">x</button></div>`).join('');
  }
  window.applyTemplate = (i) => { document.getElementById('adminNoticeInput').innerHTML = getTemplates()[i]; };
  window.deleteTemplate = (i) => { if(!confirm("ì‚­ì œ?")) return; const list = getTemplates(); list.splice(i, 1); saveJSON('NOTICE_TEMPLATES', list); renderTemplates(); };
  document.getElementById('btnSaveTemplate').onclick = () => { const txt = document.getElementById('adminNoticeInput').innerHTML; if(!txt) return toast("ë‚´ìš© ì—†ìŒ"); const list = getTemplates(); list.push(txt); saveJSON('NOTICE_TEMPLATES', list); renderTemplates(); toast("ë¬¸êµ¬ ì €ì¥ë¨"); };

  function getOutNotes(){ return loadJSON(LS_KEYS.OUT_NOTES, []); }
  function setOutNotes(list){ saveJSON(LS_KEYS.OUT_NOTES, list); }
  function getCloseChecklist(){ const def=["ê°€ìŠ¤/ì „ê¸° í™•ì¸","ì“°ë ˆê¸°/ì¬í™œìš© ì •ë¦¬","ëƒ‰ì¥ê³  ì •ë¦¬","ë§¤ì¥ ë¶ˆ/ì—ì–´ì»¨ OFF","ì˜¤ë¸/í† í•‘ëŒ€/ë„ìš°ë¡¤ëŸ¬ ì•„ë˜ ë°”ë‹¥ ì“¸ê¸°"]; const list=loadJSON(LS_KEYS.CLOSE_CHECKLIST, null); return Array.isArray(list)&&list.length?list:def; }
  function setCloseChecklist(list){ saveJSON(LS_KEYS.CLOSE_CHECKLIST, list); }
  function getCloseCheckLogs(){ return loadJSON(LS_KEYS.CLOSE_CHECK_LOGS, []); }
  function setCloseCheckLogs(list){ saveJSON(LS_KEYS.CLOSE_CHECK_LOGS, list); }
  function addCloseCheckLog({code,name,items,extra}){ const list=getCloseCheckLogs(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,items:items||[],extra:String(extra||"").trim()}); setCloseCheckLogs(list); }
  function addOutNote({code,name,text}){ const list=getOutNotes(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,text:String(text||"").trim()}); setOutNotes(list); }

  let adminUnlocked = false;
  function hasPin(){ return !!String(loadJSON(ADMIN_PIN_KEY, "") || "").trim(); }
  function isAdminUnlocked(){ return adminUnlocked; }
  function lockAdmin(){ adminUnlocked = false; document.getElementById("adminMenuOverlay").classList.remove("show"); }
  async function ensureAdmin(r="ê´€ë¦¬ì ê¸°ëŠ¥"){
    const savedPin = String(loadJSON(ADMIN_PIN_KEY, "") || "").trim();

    if(!savedPin){
      const created = prompt("ê´€ë¦¬ì PINì´ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©í•  PINì„ ë“±ë¡í•˜ì„¸ìš” (4ìë¦¬ ì´ìƒ)");
      if(created === null) return false;
      const pin = String(created).trim();
      if(pin.length < 4) { toast("PINì€ 4ìë¦¬ ì´ìƒ"); return false; }
      await saveJSON(ADMIN_PIN_KEY, pin);
      adminUnlocked = true;
      toast("ê´€ë¦¬ì PIN ë“±ë¡ ì™„ë£Œ");
      return true;
    }

    if(adminUnlocked) return true;

    const input = prompt(`${r} PIN ì…ë ¥`);
    if(input === null) return false;
    if(String(input).trim() !== savedPin){ toast("PIN ë¶ˆì¼ì¹˜"); return false; }

    adminUnlocked = true;
    return true;
  }

  function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id)?.classList.add("active");
    if(id==="sec-att") renderAttendancePanel();
    if(id==="sec-emp") renderEmployees();
    if(id==="sec-log"){ renderLogFilterOptions(); renderLogAll(); }
    recordAction("í™”ë©´ ì´ë™", id);
  }
  function renderActionLog(){
    const rows = (loadJSON('ACTION_LOGS', []) || []).slice(-100).reverse();
    document.getElementById("actionLogTable").innerHTML = rows.length
      ? rows.map(x=>`<tr><td>${escapeHtml(x.time || fmtTS(x.ts || Date.now()))}</td><td>${escapeHtml(x.action || "-")}</td><td>${escapeHtml(x.detail || "-")}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">ë¡œê·¸ ì—†ìŒ</td></tr>`;
  }

  function tickClock(){
    const d=new Date(); document.getElementById("nowTime").textContent=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    document.getElementById("nowDate").textContent=`${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()]})`;
  }
  setInterval(tickClock,250); tickClock();

  const adminMenuOverlay=document.getElementById("adminMenuOverlay");
  function updateAdminStateText(){ const el=document.getElementById("adminStateText"); if(!el) return; el.textContent=!hasPin()?"ê´€ë¦¬ì PIN ë¯¸ì„¤ì •":(isAdminUnlocked()?"ê´€ë¦¬ì ì ê¸ˆ í•´ì œë¨":"ê´€ë¦¬ì PIN ì ê¸ˆ"); }
  setInterval(updateAdminStateText,500); updateAdminStateText();
  
  function openAdminMenu(){
    document.getElementById("adminNoticeInput").innerHTML = getTodayNotice();
    document.getElementById("adminNoticeDuration").value = getTodayNoticeDuration();
    renderAdminCloseChecklist();
    renderTemplates();
    document.getElementById("adminTgChatId").value = loadJSON('adminChatId', localStorage.getItem(LS_TG_CHAT_ID) || "");
    const tgLogEl = document.getElementById("tgSystemLogEnabled");
    if (tgLogEl) tgLogEl.checked = isSystemLogTelegramEnabled();
    adminMenuOverlay.classList.add("show"); updateAdminStateText();
  }
  function bindClick(id, handler){ const el=document.getElementById(id); if(el) el.addEventListener("click", handler); }
  bindClick("adminMenuClose", ()=>adminMenuOverlay.classList.remove("show"));
  bindClick("btnLockAdmin", ()=>{ lockAdmin(); });
  bindClick("btnOpenActionLog", ()=>{ renderActionLog(); document.getElementById("actionLogOverlay").classList.add("show"); });
  bindClick("btnCloseActionLog", ()=>document.getElementById("actionLogOverlay").classList.remove("show"));
  const tgSystemLogEnabledEl = document.getElementById("tgSystemLogEnabled");
  if (tgSystemLogEnabledEl) tgSystemLogEnabledEl.addEventListener("change", (e)=>{ setSystemLogTelegramEnabled(e.target.checked); toast(`ì‹œìŠ¤í…œ ë¡œê·¸ í…”ë ˆê·¸ë¨ ì „ì†¡ ${e.target.checked ? "ON" : "OFF"}`); });
  bindClick("goEmp", ()=>{ adminMenuOverlay.classList.remove("show"); showSection("sec-emp"); });
  bindClick("goLog", ()=>{ adminMenuOverlay.classList.remove("show"); showSection("sec-log"); });
  bindClick("btnBackFromEmp", ()=>showSection("sec-att"));
  bindClick("btnBackFromLog", ()=>showSection("sec-att"));
  
  bindClick("btnSaveTodayNotice", async()=>{ if(await ensureAdmin("ê³µì§€ ì €ì¥")){ const content = document.getElementById("adminNoticeInput").innerHTML; const duration = document.getElementById("adminNoticeDuration").value; setTodayNotice(content, duration); toast("ì €ì¥ë¨"); } });
  bindClick("btnClearTodayNotice", async()=>{ if(await ensureAdmin("ê³µì§€ ì§€ìš°ê¸°")){ clearTodayNotice(); document.getElementById("adminNoticeInput").innerHTML = ""; toast("ì§€ì›Œì§"); } });
  
  document.getElementById("logoImg").addEventListener("click",async()=>{ if(await ensureAdmin("ê´€ë¦¬ì ë©”ë‰´")) openAdminMenu(); });

  document.addEventListener("click", (event) => {
    const btn = event.target.closest("button");
    if (!btn || btn.id === "btnCloseActionLog") return;
    const attCodeEl = document.getElementById("attCode");
    const rawCode = attCodeEl ? attCodeEl.value : "";
    const code = normalizeCodeInput(rawCode);
    const emp = code.length === 4 ? findEmpByCode(code) : null;
    const who = emp ? `${emp.name}(${code})` : (code ? `ì½”ë“œ:${code}` : "ë¯¸ì„ íƒ");
    const detail = `${btn.id || "(idì—†ìŒ)"} | ${(btn.textContent || "").trim()} | ${who}`;
    recordAction("ë²„íŠ¼ í´ë¦­", detail);
  });

  const noticeOverlay=document.getElementById("noticeOverlay");
  function setRingProgress(p){ const c=2*Math.PI*30; document.getElementById("noticeRing").style.strokeDasharray=`${c}`; document.getElementById("noticeRing").style.strokeDashoffset=`${c*(1-p)}`; }
  
  async function showNoticeCountdownIfAny(){
    const t=getTodayNotice(); if(!t) return true;
    const duration = getTodayNoticeDuration();
    const noticeEl = document.getElementById("noticeText"); noticeEl.innerHTML = t; noticeEl.scrollTop = 0; 
    document.getElementById("noticeDateText").textContent=`${todayKey()} ê³µì§€`;
    const btn=document.getElementById("noticeOk"), num=document.getElementById("noticeNum");
    btn.disabled=true; noticeOverlay.classList.add("show"); num.textContent = String(duration); setRingProgress(0);
    return new Promise(r=>{
      let s=Date.now(), tm=setInterval(()=>{
        const e=(Date.now()-s)/1000, p=Math.min(1,e/duration); setRingProgress(p); num.textContent=String(Math.max(0,duration-Math.floor(e)));
        if(p>=1){ clearInterval(tm); btn.disabled=false; noticeOverlay.querySelector(".countWrap").style.display="none"; }
      },60);
      const done=()=>{ clearInterval(tm); noticeOverlay.classList.remove("show"); noticeOverlay.querySelector(".countWrap").style.display=""; btn.removeEventListener("click",done); r(true); };
      btn.addEventListener("click",done);
    });
  }

  const outNoteOverlay=document.getElementById("outNoteOverlay");
  function askOutNote(){
    document.getElementById("outNoteText").value=""; outNoteOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ document.getElementById("outNoteSkip").removeEventListener("click",s); document.getElementById("outNoteSave").removeEventListener("click",sv); };
      const s=()=>{ c(); outNoteOverlay.classList.remove("show"); r(null); };
      const sv=()=>{ const t=document.getElementById("outNoteText").value; c(); outNoteOverlay.classList.remove("show"); r(t); };
      document.getElementById("outNoteSkip").addEventListener("click",s); document.getElementById("outNoteSave").addEventListener("click",sv); 
    });
  }
  document.querySelectorAll('#outNoteOverlay button[data-cat]').forEach(b=>{ b.addEventListener("click",()=>{ const t=document.getElementById("outNoteText"), cat=b.dataset.cat, pre=`[${cat}] `; b.classList.add("cat-active"); setTimeout(()=>b.classList.remove("cat-active"),500); const v=t.value||"", lines=v.split("\n"); if(lines[lines.length-1].trim()===pre.trim())return; t.value=(v.trim()?v.trim()+"\n":"")+pre; t.focus(); }); });

  const closeCheckOverlay=document.getElementById("closeCheckOverlay");
  function openCloseCheckModal(items){
    const lst=document.getElementById("closeCheckList"), done=document.getElementById("closeCheckDone");
    lst.innerHTML=items.map((t,i)=>`<label class="checkItem"><input type="checkbox" data-i="${i}" /><div><div class="t">${escapeHtml(t)}</div></div></label>`).join("");
    done.disabled=false; closeCheckOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ done.removeEventListener("click",d); };
      const d=()=>{ const boxes=lst.querySelectorAll('input[type="checkbox"]'); if(!Array.from(boxes).every(b=>b.checked)) return toast("ëª¨ë‘ ì²´í¬í•´ì£¼ì„¸ìš”","danger"); c(); closeCheckOverlay.classList.remove("show"); r({skip:false, items:Array.from(boxes).filter(b=>b.checked).map(b=>items[b.dataset.i]), extra:""}); };
      done.addEventListener("click",d); 
    });
  }

  const attCode=document.getElementById("attCode"), attName=document.getElementById("attName"), attStatus=document.getElementById("attStatus"), attLast=document.getElementById("attLast");
  function getLastEvent(code){ const logs=getLogs(); for(let i=logs.length-1;i>=0;i--)if(logs[i].code===code)return logs[i]; return null; }
  function canClockIn(code){ const l=getLastEvent(code); return !l||l.type!=="IN"; }
  function canClockOut(code){ const l=getLastEvent(code); return !!l&&l.type==="IN"; }
  function nextLogId(){ const logs=getLogs(); let m=0; for(const l of logs)if(Number(l.id)>m)m=Number(l.id); return m+1; }
  function addLog({code,name,type,note=""}){ const l=getLogs(); l.push({id:nextLogId(),code,name,type,ts:nowTS(),note}); setLogs(l); }
  function onCodeChanged(){
    const c=normalizeCodeInput(attCode.value);
    if(c.length!==4){ attName.value=""; attStatus.textContent="-"; attLast.textContent="-"; return; }
    const e=findEmpByCode(c); attName.value=e?e.name:"";
    if(!e){ attStatus.textContent="ë¯¸ë“±ë¡ ì½”ë“œ"; attLast.textContent="-"; return; }
    const l=getLastEvent(c);
    attStatus.textContent=l&&l.type==="IN"?"ì¶œê·¼ ìƒíƒœ":"í‡´ê·¼ ìƒíƒœ";
    attLast.textContent=l?`${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"} Â· ${fmtTS(l.ts)}`:"ê¸°ë¡ ì—†ìŒ";
  }
  attCode.addEventListener("input",onCodeChanged);
  document.getElementById("btnClearCode").addEventListener("click",()=>{attCode.value="";onCodeChanged();});

  // [ìˆ˜ì •] ì¶œê·¼ ì‹œê°„ ë³´ì • ê³„ì‚° í•¨ìˆ˜
  function getAdjustedStartTime(emp, inTs) {
    if (!emp.workStart) return inTs;
    const d = new Date(inTs);
    const [h, m] = emp.workStart.split(':').map(Number);
    const scheduledStart = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    
    // 1. ì¼ì° ì˜¨ ê²½ìš°: ìŠ¤ì¼€ì¤„ ì‹œê°„ìœ¼ë¡œ ì¸ì •
    if (inTs < scheduledStart) {
        return scheduledStart;
    }
    // 2. ì§€ê°ì¸ ê²½ìš° (10ë¶„ ë‹¨ìœ„ íŒ¨ë„í‹°)
    if (inTs > scheduledStart) {
        const diff = inTs - scheduledStart;
        const penaltyUnit = 10 * 60 * 1000; 
        const penaltyBlocks = Math.ceil(diff / penaltyUnit);
        return scheduledStart + (penaltyBlocks * penaltyUnit);
    }
    return inTs; 
  }

  document.getElementById("btnIn").addEventListener("click",async()=>{
    const c=attCode.value;
    if(c.length!==4){
      recordAction("ì¶œê·¼ ì‹œë„ ì‹¤íŒ¨", "ì•Œë°”ìƒ ë¯¸ì„ íƒ");
      return toast("ì•Œë°”ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”");
    }
    const e=findEmpByCode(c);
    if(!e){
      recordAction("ì¶œê·¼ ì‹œë„ ì‹¤íŒ¨", `ë¯¸ë“±ë¡ ì½”ë“œ(${c})`);
      return toast("ë¯¸ë“±ë¡ ì½”ë“œ");
    }
    if(!canClockIn(c)){
      recordAction("ì¶œê·¼ ì‹œë„ ì‹¤íŒ¨", `${e.name}(${c}) ì´ë¯¸ ì¶œê·¼ ìƒíƒœ`);
      return toast("ì´ë¯¸ ì¶œê·¼ ìƒíƒœ");
    }
    recordAction("ì¶œê·¼ ì‹œë„", `${e.name}(${c})`);
    
    await showNoticeCountdownIfAny();
    addLog({code:c,name:e.name,type:"IN"}); 
    
    // ì§€ê° ì—¬ë¶€ í™•ì¸ (í™”ë©´ í‘œì‹œìš©)
    const now = Date.now();
    const d = new Date(now);
    const [h, m] = e.workStart.split(':').map(Number);
    const scheduledStart = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();

    if(now > scheduledStart + 1000) { // 1ì´ˆ ì—¬ìœ 
        toast("ì§€ê°ìœ¼ë¡œ ì¸í•œ 10ë¶„ í˜ë„í‹°ê°€ ì ìš©ë©ë‹ˆë‹¤.", "danger");
    } else {
        toast(`${e.name} ì¶œê·¼ ì™„ë£Œ`);
    }
    
    sendTelegramAlert(`[ì¶œê·¼] ${e.name}ë‹˜ì´ ì¶œê·¼í–ˆìŠµë‹ˆë‹¤. (${fmtTS(now)})`);
    recordAction("ì¶œê·¼ ì™„ë£Œ", `${e.name}(${c})`);
    renderAttendancePanel();
  });
  
  document.getElementById("btnOut").addEventListener("click",async()=>{
    const c=attCode.value;
    if(c.length!==4){
      recordAction("í‡´ê·¼ ì‹œë„ ì‹¤íŒ¨", "ì•Œë°”ìƒ ë¯¸ì„ íƒ");
      return toast("ì•Œë°”ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”");
    }
    const e=findEmpByCode(c);
    if(!e){
      recordAction("í‡´ê·¼ ì‹œë„ ì‹¤íŒ¨", `ë¯¸ë“±ë¡ ì½”ë“œ(${c})`);
      return toast("ë¯¸ë“±ë¡ ì½”ë“œ");
    }
    if(!canClockOut(c)){
      recordAction("í‡´ê·¼ ì‹œë„ ì‹¤íŒ¨", `${e.name}(${c}) ì¶œê·¼ ê¸°ë¡ ì—†ìŒ`);
      return toast("ì¶œê·¼ ê¸°ë¡ ì—†ìŒ");
    }
    recordAction("í‡´ê·¼ ì‹œë„", `${e.name}(${c})`);
    
    let manualNote = await askOutNote();
    let checklistLogStr = "";
    if(e.shiftType==="CLOSE"){
      const res=await openCloseCheckModal(getCloseChecklist());
      if(!res.skip){ addCloseCheckLog({code:c,name:e.name,items:res.items,extra:res.extra}); checklistLogStr = `[ë§ˆê°ì²´í¬] ${res.items.join("/")}`; }
    }
    if(manualNote) addOutNote({code:c, name:e.name, text:manualNote});

    let combinedNote = (manualNote ? manualNote : "") + (manualNote && checklistLogStr ? "\n" : "") + (checklistLogStr ? checklistLogStr : "");
    addLog({code:c, name:e.name, type:"OUT", note:combinedNote}); 
    toast(`${e.name} í‡´ê·¼`); 

    sendTelegramAlert(`[í‡´ê·¼] ${e.name}ë‹˜ì´ í‡´ê·¼í–ˆìŠµë‹ˆë‹¤.${manualNote ? `\níŠ¹ì´ì‚¬í•­: ${manualNote}` : ''}`);
    recordAction("í‡´ê·¼ ì™„ë£Œ", `${e.name}(${c})`);
    renderAttendancePanel();
  });

  function renderRecent(){
    document.getElementById("recentTable").innerHTML=getLogs().slice(-15).reverse().map(l=>`<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name)}</td><td>${fmtTS(l.ts)}</td></tr>`).join("")||`<tr><td colspan="4" class="muted">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  }
  function renderQuickButtons(){
    const div=document.getElementById("quickButtons"), emps=getEmployees();
    if(!emps.length) div.innerHTML=`<span class="muted">ê´€ë¦¬ì ë©”ë‰´ì—ì„œ ì•Œë°”ìƒì„ ë“±ë¡í•˜ì„¸ìš”.</span>`;
    else{
      div.innerHTML=emps.map(e=>`<button class="btn" data-c="${e.code}">${escapeHtml(e.name)} <span class="muted">${e.code}</span></button>`).join("");
      div.querySelectorAll("button").forEach(b=>b.addEventListener("click",()=>{ attCode.value=b.dataset.c; onCodeChanged(); }));
    }
  }
  function renderAttendancePanel(){ renderRecent(); renderQuickButtons(); onCodeChanged(); }

  /* Employee & Edit Logic preserved */
  function nextAvailableCode(){ const s=new Set(getEmployees().map(e=>Number(e.code))); for(let i=1;i<=9999;i++)if(!s.has(i))return pad4(i); return pad4(getNextEmpId()); }
  function addEmployee(name,memo,ws,we,st,wage,wageW){ const emps=getEmployees(), code=nextAvailableCode(); emps.push({code, name, memo, workStart:ws, workEnd:we, shiftType:st, wage:Number(wage)||0, wageWeekend:Number(wageW)||0, createdAt:nowTS()}); setEmployees(emps); setNextEmpId(Math.max(getNextEmpId(),Number(code)+1)); }
  function updateEmployee(code,patch){ const emps=getEmployees(), idx=emps.findIndex(e=>e.code===code); if(idx>=0){ emps[idx]={...emps[idx],...patch}; setEmployees(emps); } }
  document.getElementById("btnAddEmp").addEventListener("click",async()=>{ try{ const nm=document.getElementById("empName").value.trim(); if(!nm) throw new Error("ì´ë¦„ ì…ë ¥"); addEmployee(nm, document.getElementById("empMemo").value, document.getElementById("empWorkStart").value, document.getElementById("empWorkEnd").value, document.getElementById("empShiftType").value, document.getElementById("empWage").value, document.getElementById("empWageWeekend").value); document.getElementById("empName").value=""; toast("ë“±ë¡ ì™„ë£Œ"); renderEmployees(); renderQuickButtons(); }catch(e){ toast(e.message); } });
  document.getElementById("btnRefreshEmp").addEventListener("click",renderEmployees);
  document.getElementById("empSearch").addEventListener("input",renderEmployees);
  
  function renderEmployees(){
    document.getElementById("nextCodeHint").textContent=`ë‹¤ìŒ ì½”ë“œ: ${nextAvailableCode()}`;
    const q=document.getElementById("empSearch").value.toLowerCase(), emps=getEmployees().filter(e=>e.code.includes(q)||e.name.toLowerCase().includes(q));
    document.getElementById("empTable").innerHTML=emps.length?emps.map(e=>`<tr><td><span class="tag open">${e.code}</span></td><td>${escapeHtml(e.name)}</td><td class="muted typeCell">${e.shiftType==="CLOSE"?"ë§ˆê°":"ë¯¸ë“¤"}</td><td class="muted">${(e.wage||0).toLocaleString()} / ${e.wageWeekend ? e.wageWeekend.toLocaleString() : '-'}</td><td class="muted timeCell">${e.workStart}~${e.workEnd}</td><td style="text-align:right;"><button class="btn small" onclick="window.editEmp('${e.code}')">ìˆ˜ì •</button> <button class="btn small bad" onclick="window.delEmp('${e.code}')">ì‚­ì œ</button></td></tr>`).join("") : `<tr><td colspan="6" class="muted">ì—†ìŒ</td></tr>`;
  }
  window.delEmp=async(c)=>{ if(!await ensureAdmin("ì‚­ì œ")) return; if(!confirm("ì •ë§ ì‚­ì œ?")) return; const l=getEmployees().filter(e=>e.code!==c); setEmployees(l); toast("ì‚­ì œë¨"); renderEmployees(); renderQuickButtons(); };
  window.editEmp=async(c)=>{ if(!await ensureAdmin("ìˆ˜ì •"))return; const e=findEmpByCode(c); if(!e)return; document.getElementById("empEditCode").value=e.code; document.getElementById("empEditName").value=e.name; document.getElementById("empEditShiftType").value=e.shiftType||"MID"; document.getElementById("empEditWage").value=e.wage||""; document.getElementById("empEditWageWeekend").value=e.wageWeekend||""; document.getElementById("empEditMemo").value=e.memo||""; document.getElementById("empEditWorkStart").value=e.workStart||"17:00"; document.getElementById("empEditWorkEnd").value=e.workEnd||"23:30"; document.getElementById("empEditOverlay").classList.add("show"); };
  document.getElementById("empEditSave").addEventListener("click",()=>{ const c=document.getElementById("empEditCode").value, n=document.getElementById("empEditName").value.trim(); if(!n)return toast("ì´ë¦„ ì…ë ¥"); updateEmployee(c,{ name:n, shiftType:document.getElementById("empEditShiftType").value, wage:Number(document.getElementById("empEditWage").value)||0, wageWeekend:Number(document.getElementById("empEditWageWeekend").value)||0, memo:document.getElementById("empEditMemo").value, workStart:document.getElementById("empEditWorkStart").value, workEnd:document.getElementById("empEditWorkEnd").value }); document.getElementById("empEditOverlay").classList.remove("show"); toast("ìˆ˜ì • ì™„ë£Œ"); renderEmployees(); renderQuickButtons(); renderLogAll(); });
  document.getElementById("empEditCancel").addEventListener("click",()=>document.getElementById("empEditOverlay").classList.remove("show"));

  let calYear=new Date().getFullYear(), calMonth=new Date().getMonth()+1;
  function getDayKey(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }

  function getScheduledEndTime(emp, inTs, outTs) {
    if (!emp || !emp.workEnd) return outTs;
    const d = new Date(inTs || outTs);
    const [h, m] = emp.workEnd.split(':').map(Number);
    let scheduledEnd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    if (inTs && scheduledEnd < inTs) { scheduledEnd += 24 * 60 * 60 * 1000; }
    return scheduledEnd;
  }

  function getAdjustedWorkTime(emp, inTs, outTs) {
    if (!emp.workEnd) return outTs;
    const scheduledEnd = getScheduledEndTime(emp, inTs, outTs);

    // ê³„ì•½ í‡´ê·¼ì‹œê°„ ì´ì „ í‡´ê·¼ë„ ê³„ì•½ ì‹œê°„ê¹Œì§€ ì¸ì •
    if (outTs <= scheduledEnd) return scheduledEnd;

    const diff = outTs - scheduledEnd;
    const bonusUnit = 5 * 60 * 1000;
    const blocks = Math.ceil(diff / bonusUnit);
    return scheduledEnd + (blocks * bonusUnit);
  }

  function resolveWageByDate(emp, workDateKey) {
    const dObj = new Date(workDateKey);
    const isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6);
    const isHol = isHoliday(workDateKey);
    if (isHol && !isWeekend) return (emp ? emp.wage : 0) * 1.5;
    if (isWeekend && emp && emp.wageWeekend) return emp.wageWeekend;
    return emp ? emp.wage : 0;
  }

  function roundPayWon(v) {
    // ê¸‰ì—¬ëŠ” ë³´ê¸°/ì •ì‚° í¸ì˜ë¥¼ ìœ„í•´ 10ì› ë‹¨ìœ„ ë°˜ì˜¬ë¦¼
    return Math.round((Number(v) || 0) / 10) * 10;
  }

  function getShiftPairs(filterCode = "") {
    const logs = getLogs().filter(l=>!filterCode || l.code===filterCode).sort((a,b)=>a.ts-b.ts);
    const openInByCode = {};
    const pairs = [];

    logs.forEach(l => {
      if (l.type === "IN") {
        openInByCode[l.code] = l;
        return;
      }
      if (l.type === "OUT" && openInByCode[l.code]) {
        pairs.push({ code:l.code, inTs:openInByCode[l.code].ts, outTs:l.ts, emp:findEmpByCode(l.code) });
        delete openInByCode[l.code];
      }
    });

    return pairs;
  }

  function calcDayStats(dk, tCode){
    const pairs = getShiftPairs(tCode).filter(p => dateKey(p.inTs) === dk);
    let ms=0, pay=0;

    pairs.forEach(p => {
      const wage = resolveWageByDate(p.emp, dk);
      const adjInTs = getAdjustedStartTime(p.emp, p.inTs);
      const adjOutTs = getAdjustedWorkTime(p.emp, p.inTs, p.outTs);
      if(adjOutTs > adjInTs) {
        const d=adjOutTs-adjInTs;
        ms+=d;
        pay+=roundPayWon((d/3600000)*wage);
      }
    });

    return { h:Math.floor(ms/3600000), m:Math.floor((ms%3600000)/60000), pay, has:pairs.length>0 };
  }

  function getWeeklyJuhyuSum(sundayDate, filterCode){
     const endTs = new Date(sundayDate).setHours(23,59,59,999);
     const startDate = new Date(sundayDate); startDate.setDate(startDate.getDate() - 6);
     const startTs = startDate.setHours(0,0,0,0);
     const employees = getEmployees().filter(e => !filterCode || e.code === filterCode);
     let totalJuhyu = 0;

     employees.forEach(emp => {
       const pairs = getShiftPairs(emp.code).filter(p => p.inTs >= startTs && p.inTs <= endTs);
       let weeklyMs = 0;
       let weeklyPay = 0;

       pairs.forEach(p => {
         const adjInTs = getAdjustedStartTime(emp, p.inTs);
         const adjOutTs = getAdjustedWorkTime(emp, p.inTs, p.outTs);
         if(adjOutTs <= adjInTs) return;

         const durationMs = adjOutTs - adjInTs;
         weeklyMs += durationMs;
         const dk = dateKey(p.inTs);
         const currentWage = resolveWageByDate(emp, dk);
         weeklyPay += (durationMs / 3600000) * currentWage;
       });

       const weeklyHours = weeklyMs / 3600000;
       if(weeklyHours >= 15) {
          const avgWage = weeklyPay / weeklyHours;
          const juhyuHours = (Math.min(weeklyHours, 40) / 40) * 8;
          totalJuhyu += roundPayWon(juhyuHours * avgWage);
       }
     });

     return totalJuhyu;
  }


function renderCalendar(){
    const g = document.getElementById("calendarView"); 
    if(!g) return;
    document.getElementById("calTitle").textContent = `${calYear}. ${String(calMonth).padStart(2,"0")}`;
    g.innerHTML = "";

    // 1. ìš”ì¼ í—¤ë” ì¶”ê°€ (ì¼~í† )
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    days.forEach(day => {
      const d = document.createElement("div");
      d.className = "calCellHeader"; // ì†ŒìŠ¤ ë‚´ ì •ì˜ëœ í—¤ë” ìŠ¤íƒ€ì¼
      d.textContent = day;
      if(day === 'ì¼') d.style.color = 'var(--bad)';
      if(day === 'í† ') d.style.color = 'var(--accent)';
      g.appendChild(d);
    });

    const start = new Date(calYear, calMonth-1, 1).getDay();
    const end = new Date(calYear, calMonth, 0).getDate();
    const tFilter = document.getElementById("logFilterEmp").value;
    syncHolidayYear(calYear);

    // 2. ì‹œì‘ ìš”ì¼ ë§ì¶”ê¸° ìœ„í•œ ë¹ˆ ì¹¸ ìƒì„±
    for(let i=0; i<start; i++){ 
      const d = document.createElement("div"); 
      d.className = "calDay empty"; 
      g.appendChild(d); 
    }

    // 3. ë‚ ì§œë³„ ë°ì´í„° ë Œë”ë§
    for(let d=1; d<=end; d++){
      const div = document.createElement("div"); 
      div.className = "calDay";
      const k = getDayKey(calYear, calMonth, d); 
      if(k === todayKey()) div.classList.add("today");

      const isHol = isHoliday(k);
      const st = calcDayStats(k, tFilter);
      
      let inner = `<div class="calNum" style="${isHol ? 'color:var(--bad);' : ''}">${d}${isHol ? '(íœ´)' : ''}</div>`;
      
      // ì¼ìš”ì¼ ì£¼íœ´ìˆ˜ë‹¹ í‘œì‹œ
      if(new Date(calYear, calMonth-1, d).getDay() === 0) { 
         const juhyu = getWeeklyJuhyuSum(new Date(calYear, calMonth-1, d), tFilter);
         if(juhyu > 0) inner += `<span class="tag juhyu">ì£¼íœ´ğŸ’° +${juhyu.toLocaleString()}</span>`;
      }

      // ê·¼ë¬´ ê¸°ë¡ í‘œì‹œ
      if(st.has) inner += `<div class="calData"><span class="calTime">${st.h > 0 ? st.h + 'h ' : ''}${st.m}m</span>${st.pay > 0 ? `<span class="calPay">${st.pay.toLocaleString()}ì›</span>` : ''}</div>`;
      
      div.innerHTML = inner;
      g.appendChild(div);
    }
    updateMonthlyWageEstimate(); // ì›”ë³„ ì˜ˆìƒ ê¸‰ì—¬ ê°±ì‹ 
  }
  
  document.getElementById("calPrevBtn").addEventListener("click",()=>{ calMonth--; if(calMonth<1){calMonth=12;calYear--;} renderCalendar(); });
  document.getElementById("calNextBtn").addEventListener("click",()=>{ calMonth++; if(calMonth>12){calMonth=1;calYear++;} renderCalendar(); });

  function updateMonthlyWageEstimate() {
    const tEmp = document.getElementById("logFilterEmp").value;
    document.getElementById("totalWageTitle").textContent = `${calMonth}ì›” ì˜ˆìƒ ê¸‰ì—¬ ${tEmp ? '(ì„ íƒëœ ì•Œë°”ìƒ)' : '(ì „ì²´)'}`;
    const targetPrefix = `${calYear}-${String(calMonth).padStart(2,"0")}`;
    const employees = getEmployees().filter(e => !tEmp || e.code === tEmp);
    let totalBase = 0, totalJuhyu = 0;

    employees.forEach(emp => {
      const pairs = getShiftPairs(emp.code).filter(p => dateKey(p.inTs).startsWith(targetPrefix));
      pairs.forEach(p => {
        const adjInTs = getAdjustedStartTime(emp, p.inTs);
        const adjOutTs = getAdjustedWorkTime(emp, p.inTs, p.outTs);
        if(adjOutTs <= adjInTs) return;
        const ms = adjOutTs - adjInTs;
        const dk = dateKey(p.inTs);
        const wage = resolveWageByDate(emp, dk);
        totalBase += roundPayWon((ms / 3600000) * wage);
      });

      const sundaysInMonth = [];
      const d = new Date(calYear, calMonth-1, 1);
      while(d.getMonth() === calMonth-1) { if(d.getDay() === 0) sundaysInMonth.push(new Date(d)); d.setDate(d.getDate() + 1); }
      sundaysInMonth.forEach(sunday => { totalJuhyu += getWeeklyJuhyuSum(sunday, emp.code); });
    });

    document.getElementById("totalWageAmount").textContent = (totalBase + totalJuhyu).toLocaleString() + "ì›";
    document.getElementById("totalWageDetail").textContent = `(ê¸°ë³¸ ${totalBase.toLocaleString()} + ì£¼íœ´ ${totalJuhyu.toLocaleString()})`;
  }


  function renderLogFilterOptions(){
    const sel=document.getElementById("logFilterEmp"), old=sel.value;
    sel.innerHTML=`<option value="">ì „ì²´ ì•Œë°”ìƒ</option>`+getEmployees().map(e=>`<option value="${e.code}">${e.code} ${escapeHtml(e.name)}</option>`).join("");
    sel.value=old;
  }
  document.getElementById("logFilterEmp").addEventListener("change",renderLogAll);

  // [ìˆ˜ì •] ê·¼íƒœ ê¸°ë¡ í‘œì‹œ í•¨ìˆ˜ (ì§€ê° íŒì • ë¡œì§ ìˆ˜ì •)
  function renderLogAll(){
    const f=document.getElementById("logFilterEmp").value, all=getLogs(), list=f?all.filter(l=>l.code===f):all;
    const shiftByOutKey = new Map();
    getShiftPairs(f).forEach(p => {
      shiftByOutKey.set(`${p.code}|${p.outTs}`, p);
    });
    document.getElementById("logTotal").textContent=list.length;
    
    document.getElementById("logTable").innerHTML=list.slice().reverse().map(l=> {
        let timeDisplay = fmtTS(l.ts);
        const emp = findEmpByCode(l.code);
        
        // 1. ì¶œê·¼ í‘œì‹œ ë¡œì§ ìˆ˜ì •
        if(l.type === "IN" && emp && emp.workStart) {
            const adjInTs = getAdjustedStartTime(emp, l.ts);
            
            const d = new Date(l.ts);
            const [h, m] = emp.workStart.split(':').map(Number);
            const scheduledStart = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();

            const adjDate = new Date(adjInTs);
            const adjStr = `${String(adjDate.getHours()).padStart(2,"0")}:${String(adjDate.getMinutes()).padStart(2,"0")}`;

            // ì‹¤ì œ ì¶œê·¼(l.ts)ì´ ì˜ˆì •ì‹œê°„(scheduledStart)ë³´ë‹¤ ëŠ¦ì€ ê²½ìš° -> ì§€ê°
            if(l.ts > scheduledStart) {
                timeDisplay += `<br><span class="tag out" style="font-size:10px;">ì§€ê°(ì¸ì •:${adjStr})</span>`;
            } 
            // ì¼ì° ì™”ê±°ë‚˜ ì •ì‹œì¸ ê²½ìš° -> ì •ì‹œ(ì´ˆë¡ìƒ‰)ìœ¼ë¡œ í‘œì‹œí•˜ë˜, ì¸ì • ì‹œê°„ì€ ë³´ì—¬ì¤Œ
            else {
                timeDisplay += `<br><span class="tag good" style="font-size:10px;">ì •ì‹œ(ì¸ì •:${adjStr})</span>`;
            }
        }
        
        // 2. í‡´ê·¼ í‘œì‹œ ë¡œì§
        if(l.type === "OUT" && emp) {
            const matchedPair = shiftByOutKey.get(`${l.code}|${l.ts}`);
            const inTsForAdjust = matchedPair ? matchedPair.inTs : l.ts;
            const adjOutTs = getAdjustedWorkTime(emp, inTsForAdjust, l.ts);
            if(adjOutTs !== l.ts) {
                const d = new Date(adjOutTs);
                const adjStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;

                const scheduledEnd = getScheduledEndTime(emp, inTsForAdjust, l.ts);
                const label = adjOutTs > scheduledEnd ? "ì—°ì¥" : "ì •ì‹œ";
                timeDisplay += `<br><span class="tag good" style="font-size:10px;">${label}(ì¸ì •:${adjStr})</span>`;
            }
        }
        
        const noteTag = l.note ? (l.note.includes("[ë§ˆê°ì²´í¬]") ? `<span class="tag good">ë§ˆê°âœ…</span>` : (l.note.length>10?l.note.slice(0,10)+"...":l.note)) : "";
        return `<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name||"")}</td><td>${timeDisplay}</td><td>${noteTag}</td><td><button class="btn small" onclick="window.editLog(${l.id})">ìˆ˜ì •</button></td></tr>`;
    }).join("")||`<tr><td colspan="6" class="muted">ê¸°ë¡ ì—†ìŒ</td></tr>`;
    
    const ons=getOutNotes().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("outNoteTable").innerHTML=ons.map((x,i)=>`<tr><td>${ons.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml(x.text)}</td></tr>`).join("");
    const cls=getCloseCheckLogs().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("closeCheckTable").innerHTML=cls.map((x,i)=>`<tr><td>${cls.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml((x.items||[]).join("/"))}</td></tr>`).join("");
    renderCalendar();
  }

  window.editLog=async(id)=>{ if(!await ensureAdmin("ìˆ˜ì •"))return; const l=getLogs().find(x=>x.id===id); if(!l)return; document.getElementById("logEditCode").value=l.code; document.getElementById("logEditName").value=l.name||""; document.getElementById("logEditType").value=l.type; 
  const d = new Date(l.ts);
  const timeStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  document.getElementById("logEditTs").value = timeStr;
  document.getElementById("logEditNote").value=l.note||""; document.getElementById("logEditSave").onclick=()=>{ const ts=new Date(document.getElementById("logEditTs").value).getTime(); if(!ts)return toast("ì‹œê°„ í™•ì¸"); const logs=getLogs(), idx=logs.findIndex(x=>x.id===id); if(idx>=0){ logs[idx]={...logs[idx], type:document.getElementById("logEditType").value, ts, note:document.getElementById("logEditNote").value}; setLogs(logs); } document.getElementById("logEditOverlay").classList.remove("show"); toast("ìˆ˜ì •ë¨"); renderLogAll(); renderAttendancePanel(); }; document.getElementById("logEditDelete").onclick=()=>{ if(confirm("ì‚­ì œ?")){ setLogs(getLogs().filter(x=>x.id!==id)); document.getElementById("logEditOverlay").classList.remove("show"); toast("ì‚­ì œë¨"); renderLogAll(); renderAttendancePanel(); } }; document.getElementById("logEditOverlay").classList.add("show"); };
  document.getElementById("logEditCancel").addEventListener("click",()=>document.getElementById("logEditOverlay").classList.remove("show"));

  document.getElementById("btnAddShift").addEventListener("click",async()=>{ if(!await ensureAdmin("ì¶”ê°€"))return; const emps=getEmployees(); if(!emps.length)return toast("ì•Œë°”ìƒ ì—†ìŒ"); document.getElementById("logAddEmp").innerHTML=emps.map(e=>`<option value="${e.code}">${e.code} ${e.name}</option>`).join(""); logAddDates = []; document.getElementById("selectedDateList").innerHTML = `<span class="muted" style="font-size:12px; padding:4px;">ë‚ ì§œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”</span>`; document.getElementById("logAddOverlay").classList.add("show"); });
  document.getElementById("btnPushDate").addEventListener("click", () => { const dVal = document.getElementById("logAddDate").value; if(!dVal) return toast("ë‚ ì§œ ì„ íƒ"); if(logAddDates.includes(dVal)) return toast("ì¤‘ë³µ ë‚ ì§œ"); logAddDates.push(dVal); renderSelectedDates(); });
  function renderSelectedDates() { const box = document.getElementById("selectedDateList"); if(logAddDates.length === 0) { box.innerHTML = `<span class="muted" style="font-size:12px; padding:4px;">ë‚ ì§œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”</span>`; return; } box.innerHTML = logAddDates.map(d => `<span class="date-pill">${d} <button onclick="removeDate('${d}')">x</button></span>`).join(""); }
  window.removeDate = function(d) { logAddDates = logAddDates.filter(x => x !== d); renderSelectedDates(); };
  document.getElementById("logAddSave").addEventListener("click",()=>{ const c=document.getElementById("logAddEmp").value; const e=findEmpByCode(c); const md=document.getElementById("logAddMode").value; const inT=document.getElementById("logAddInTime").value; const outT=document.getElementById("logAddOutTime").value; const note=document.getElementById("logAddNote").value; let targetDates = [...logAddDates]; if(targetDates.length === 0) { const singleDate = document.getElementById("logAddDate").value; if(singleDate) targetDates.push(singleDate); } if(targetDates.length === 0) return toast("ë‚ ì§œ ì—†ìŒ");
    targetDates.forEach(dt => { const mkTs=(t)=>new Date(`${dt}T${t}`).getTime(); if(md==="SHIFT"){ addLog({code:c,name:e.name,type:"IN",note:note||"ìˆ˜ë™"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); addLog({code:c,name:e.name,type:"OUT",note:note||"ìˆ˜ë™"}); const l2=getLogs(); l2[l2.length-1].ts=mkTs(outT); setLogs(l2); } else if(md==="IN"){ addLog({code:c,name:e.name,type:"IN",note:note||"ìˆ˜ë™"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); } else{ addLog({code:c,name:e.name,type:"OUT",note:note||"ìˆ˜ë™"}); const l=getLogs(); l[l.length-1].ts=mkTs(outT); setLogs(l); } }); document.getElementById("logAddOverlay").classList.remove("show"); toast("ì¶”ê°€ ì™„ë£Œ"); renderLogAll(); renderAttendancePanel(); 
  });
  document.getElementById("logAddCancel").addEventListener("click",()=>document.getElementById("logAddOverlay").classList.remove("show"));

  function downloadFile(fn,txt,mime){ const b=new Blob([txt],{type:mime}), a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=fn; document.body.appendChild(a); a.click(); a.remove(); }
  function exportCsv(){ const f=document.getElementById("logFilterEmp").value, l=getLogs().filter(x=>!f||x.code===f); const csv="id,type,code,name,ts,time,note\n"+l.map(x=>`${x.id},${x.type},${x.code},"${x.name}",${x.ts},"${fmtTS(x.ts)}","${(x.note||"").replace(/"/g,'""')}"`).join("\n"); downloadFile(`ê·¼íƒœ_${todayKey()}.csv`,csv,"text/csv;charset=utf-8"); }
  document.getElementById("btnExportCsv").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  document.getElementById("btnExportCsv2").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  // =========================================================================
// [ìˆ˜ì • ì‹œì‘: CSV ë°ì´í„° ë³‘í•© (Import) ë¡œì§ - ì½”ë“œ ê°„ì†Œí™” ê¸ˆì§€]
// =========================================================================

// 1. ìˆ¨ê²¨ì§„ íŒŒì¼ ì„ íƒì°½(input)ì´ HTMLì— ì—†ìœ¼ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ë§Œë“­ë‹ˆë‹¤. (ì—ëŸ¬ ì™„ë²½ ë°©ì§€)
let csvFileInput = document.getElementById("csvFileInput");
if (!csvFileInput) {
    csvFileInput = document.createElement("input");
    csvFileInput.type = "file";
    csvFileInput.id = "csvFileInput";
    csvFileInput.accept = ".csv";
    csvFileInput.style.display = "none";
    document.body.appendChild(csvFileInput);
    console.log("CSV íŒŒì¼ ì„ íƒìš© input íƒœê·¸ê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// 2. ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ¨ê²¨ì§„ inputì„ ëŒ€ì‹  í´ë¦­í•´ì£¼ëŠ” ì—°ê²°
const btnImportCsv = document.getElementById("btnImportCsv");
if (btnImportCsv) {
    btnImportCsv.addEventListener("click", async () => {
        if(await ensureAdmin("CSV ë¶ˆëŸ¬ì˜¤ê¸°")) {
            csvFileInput.click(); // ì—¬ê¸°ì„œ ë‚˜ë˜ null ì—ëŸ¬ê°€ ì´ì œ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        }
    });
}

// 3. íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ ë¡œì§
csvFileInput.addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        try {
            // CSV í…ìŠ¤íŠ¸ ì •ì œ (ìœ ë ¹ ë¬¸ì ì œê±° ë° ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
            const cleanContent = String(text || "").replace(/^\ufeff/, ""); 
            const lines = cleanContent.split(/\r?\n/);
            const validLines = lines.filter(function(line) { return line.trim() !== ""; });
            
            if (validLines.length <= 1) {
                toast("ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì˜ëª»ëœ í˜•ì‹ì…ë‹ˆë‹¤.", "danger");
                return;
            }

            // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
            const dataRows = validLines.slice(1);
            let importedCount = 0;
            const existingLogs = getLogs();
            
            // ê¸°ì¡´ ë°ì´í„°ì™€ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ í˜„ì¬ ê°€ì¥ ë†’ì€ ID ê°’ì„ ì°¾ìŒ
            let maxId = 0;
            for(const log of existingLogs) {
                if(Number(log.id) > maxId) maxId = Number(log.id);
            }

            dataRows.forEach(function(line) {
                const columns = line.split(",");
                // ì»¬ëŸ¼ ê°œìˆ˜ê°€ ë¶€ì¡±í•˜ë©´ ê±´ë„ˆëœ€ (ì•ˆì „ ì¥ì¹˜)
                if (columns.length < 5) return; 

                // ê°„ì†Œí™” ì—†ì´ ê° ë³€ìˆ˜ë¥¼ ê¼¼ê¼¼íˆ íŒŒì‹±
                const type = columns[1] ? columns[1].trim() : "";
                let code = columns[2] ? columns[2].trim() : "";
                code = pad4(normalizeCodeInput(code)); // ì‚¬ë²ˆì„ 4ìë¦¬ ìˆ«ìë¡œ í†µì¼
                const name = columns[3] ? columns[3].replace(/"/g, "").trim() : "";
                const ts = columns[4] ? Number(columns[4].trim()) : Date.now();
                const note = columns[6] ? columns[6].replace(/"/g, "").trim() : "";

                // ê¸°ì¡´ ë°ì´í„°ì— ê°™ì€ ì‹œê°„(ts)ê³¼ ê°™ì€ ì‚¬ë²ˆ(code)ì˜ ê¸°ë¡ì´ ìˆëŠ”ì§€ ì¤‘ë³µ ê²€ì‚¬
                const isDuplicate = existingLogs.some(function(log) {
                    return log.ts === ts && log.code === code;
                });
                
                // ì¤‘ë³µì´ ì•„ë‹ˆë©´ ìƒˆë¡œìš´ IDë¥¼ ë¶€ì—¬í•˜ì—¬ ì¶”ê°€
                if (!isDuplicate) {
                    maxId += 1;
                    existingLogs.push({
                        id: maxId,
                        type: type,
                        code: code,
                        name: name,
                        ts: ts,
                        note: note
                    });
                    importedCount++;
                }
            });

            // ë³€ê²½ëœ ì „ì²´ ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥ (ì´ì „ì— ê³ ì¹œ update ë°©ì‹ ì ìš©ë¨)
            setLogs(existingLogs);
            
            // íŒŒì¼ ì…ë ¥ì°½ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            csvFileInput.value = "";

            // UI ê°±ì‹ 
            toast(`ì´ ${importedCount}ê±´ì˜ ìƒˆ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            renderLogAll();
            renderAttendancePanel();

        } catch (error) {
            console.error("CSV íŒŒì‹± ì—ëŸ¬:", error);
            toast("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "danger");
        }
    };
    reader.readAsText(file);
});
// =========================================================================
// [ìˆ˜ì • ë]
// =========================================================================
  
  function renderAdminCloseChecklist(){ const lst=document.getElementById("adminCloseChecklistList"), items=getCloseChecklist(); lst.innerHTML=items.map((t,i)=>`<div class="admCLRow"><div class="idx">${i+1}</div><input class="admCLInput" value="${escapeHtml(t)}" /><button class="btn small" onclick="delCLItem(${i})">ì‚­ì œ</button></div>`).join(""); }
  window.delCLItem=async(i)=>{ const l=getCloseChecklist(); l.splice(i,1); setCloseChecklist(l); renderAdminCloseChecklist(); };
  document.getElementById("btnAddCloseChecklistItem").addEventListener("click",()=>{ const v=document.getElementById("adminCloseNewItem").value.trim(); if(!v)return; const l=getCloseChecklist(); l.push(v); setCloseChecklist(l); document.getElementById("adminCloseNewItem").value=""; renderAdminCloseChecklist(); });
  document.getElementById("btnSaveCloseChecklist").addEventListener("click",()=>{ const l=Array.from(document.querySelectorAll(".admCLInput")).map(i=>i.value.trim()).filter(Boolean); setCloseChecklist(l); toast("ì €ì¥ë¨"); renderAdminCloseChecklist(); });
  document.getElementById("btnResetCloseChecklist").addEventListener("click",()=>{ localStorage.removeItem(LS_KEYS.CLOSE_CHECKLIST); renderAdminCloseChecklist(); });

// [ì‚­ì œí•œ ìë¦¬ì— ì´ ì½”ë“œë§Œ ë‚¨ê²¨ì£¼ì„¸ìš”]
  (async () => {
    try {
      renderAttendancePanel();
      if (typeof updateAdminStateText === 'function') updateAdminStateText();
      renderEmployees();
      renderLogFilterOptions();
      renderLogAll();
      console.log("íƒë‚˜ëŠ”í”¼ì ì‹œìŠ¤í…œ ì¬ê°€ë™ ì™„ë£Œ");
    } catch (e) {
      console.error("ë¡œë”© ì—ëŸ¬:", e);
    }
  })();
</script>
