<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  
  <title>íƒë‚˜ëŠ”í”¼ì í™”ì„±ë‚¨ì–‘ì </title>
  
  <style>
    /* ================================================================
       [ì‚¬ì¥ë‹˜ ì›ë³¸ ë””ìì¸ ë³µêµ¬ ì™„ë£Œ] 
       ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
       ================================================================
    */
    :root{
      --bg: #f4f6f9; --panel: #ffffff; --panel2: #f8f9fa;
      --text: #2c3e50; --muted: #8395a7; --line: #dcdde1;
      --accent: #3498db; --good: #27ae60; --bad: #e74c3c; --warn: #f39c12;
      --shadow: 0 8px 20px rgba(0,0,0,0.08); --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{ 
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
      background: var(--bg); 
      color:var(--text); 
      min-height:100dvh;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none; touch-action: manipulation;
      padding-bottom: 20px;
    }
    /* ì…ë ¥ì°½ì€ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ */
    input, textarea { -webkit-user-select: text; user-select: text; }

    header{ padding: 14px 18px 10px; position: sticky; top:0; background: rgba(255,255,255,.90); backdrop-filter: blur(10px); border-bottom: 1px solid var(--line); z-index:100; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1100px; margin:0 auto; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logoWrap{ display:flex; flex-direction:column; gap:4px; }
    .logo{ height: 34px; width: auto; display:block; object-fit: contain; cursor: pointer; }
    .right{ display:flex; align-items:flex-end; gap:12px; font-variant-numeric: tabular-nums; }
    .clockBlock{ text-align:right; }
    .clockBlock .time{ font-size:16px; font-weight:800; color: #2c3e50; }
    .clockBlock .date{ font-size:12px; color:var(--muted); margin-top:2px; }

    main{ max-width:1100px; margin:0 auto; padding: 14px 18px 30px; display:grid; gap:14px; }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .logo{ height: 30px; } }

    .card{ background: var(--panel); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }
    .card h2{ margin:0 0 10px; font-size: 16px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1 1 auto !important; }

    label{ font-size: 13px; color:var(--muted); display:block; margin: 4px 0 6px; }
    input, select{ width:100%; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 16px; outline:none; }
    input::placeholder{ color: #b2bec3; }
    input:focus, select:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }
    textarea{ width:100%; min-height: 120px; resize: vertical; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 15px; outline:none; }
    textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }

    .btn{ border:1px solid var(--line); background: #f1f2f6; color: var(--text); padding: 12px 14px; border-radius: 14px; font-size: 15px; font-weight: 800; cursor:pointer; user-select:none; transition: transform .05s ease; }
    .btn:active{ transform: scale(.98); }
    .btn.primary{ border-color: transparent; background: var(--accent); color: #fff; }
    .btn.good{ border-color: transparent; background: var(--good); color: #fff; }
    .btn.bad{ border-color: transparent; background: var(--bad); color: #fff; }
    .btn.warn{ border-color: transparent; background: var(--warn); color: #fff; }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 13px; font-weight: 900; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .split{ grid-template-columns: 1fr; } }
    .big-actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .big-actions .btn{ padding: 18px 14px; font-size: 18px; border-radius: 16px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border: 1px solid var(--line); border-radius: 999px; background: #f8f9fa; font-size: 13px; color: var(--muted); font-variant-numeric: tabular-nums; }
    .pill strong{ color:var(--text); }

    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius: 14px; border: 1px solid var(--line); background: #fff; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid var(--line); text-align:left; font-size: 14px; vertical-align: middle; }
    th{ color: var(--muted); font-weight: 900; background: #f1f2f6; }
    tr:last-child td{ border-bottom: none; }

    .tag{ display:inline-flex; align-items:center; justify-content:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 900; border: 1px solid var(--line); font-variant-numeric: tabular-nums; white-space: nowrap; }
    .tag.in{ border-color: transparent; color: #fff; background: var(--good); }
    .tag.out{ border-color: transparent; color: #fff; background: var(--bad); }
    .tag.open{ border-color: transparent; color: #fff; background: var(--warn); }
    .tag.juhyu { border-color: transparent; color: #d35400; background: rgba(230, 126, 34, 0.15); margin-top: 2px; width: 100%; }
    .tag.adj { border-color: var(--accent); color: var(--accent); background: rgba(52,152,219,0.1); margin-left:6px; font-size:11px; }

    .section{ display:none; }
    .section.active{ display:block; }

    .note{ margin-top:10px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: #2f3640; border: 1px solid #2f3640; border-radius: 14px; padding: 14px 18px; box-shadow: var(--shadow); font-size: 16px; color: #fff; display:none; z-index: 5000; max-width: 92vw; white-space: normal; overflow: hidden; text-overflow: clip; }
    .toast.show{ display:block; }
    .toast.danger{ background: var(--bad); border-color: var(--bad); color: #fff; }

    .modalOverlay{ position: fixed; inset:0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index: 1000; padding: 18px; backdrop-filter: blur(2px); }
    .modalOverlay.show{ display:flex; }
    .modal{ width: min(560px, 100%); border-radius: 18px; border: 1px solid var(--line); background: #fff; box-shadow: var(--shadow); padding: 14px; max-height: 85vh; overflow-y:auto; padding-bottom: 40px; }
    .modal h3{ margin:0 0 6px; font-size: 16px; letter-spacing:.2px; }
    .modalActions{ display:flex; gap:10px; margin-top: 12px; justify-content:flex-end; flex-wrap:wrap; }
    .menuGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 12px; }
    @media (max-width: 520px){ .menuGrid{ grid-template-columns: 1fr; } }

    .countWrap{ display:flex; align-items:center; gap:14px; margin-top:12px; }
    .ring{ width:62px; height:62px; position:relative; flex:0 0 auto; }
    .ring svg{ width:62px; height:62px; display:block; }
    .ring .num{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:18px; }
    .ring .bg{ stroke: #f1f2f6; stroke-width: 8; fill: none; }
    .ring .fg{ stroke: var(--accent); stroke-width: 8; fill: none; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.15s linear; }
    .btn.cat-active{ border-color: transparent; background: var(--warn); color:#fff; }
    td.nameCell, th.nameCell { white-space: nowrap; word-break: keep-all; }
    
    .checkList{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .checkItem{ display:flex; align-items:flex-start; gap:10px; padding: 10px 10px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .checkItem input{ width:auto; margin-top:3px; }
    .checkItem .t{ font-weight: 900; font-size: 14px; }
    .admCLRow{ display:flex; gap:8px; align-items:center; padding: 8px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .admCLRow input{ flex: 1 1 auto; }
    .admCLRow .idx{ width: 28px; text-align:center; color: var(--muted); font-weight: 900; font-variant-numeric: tabular-nums; }
    
    /* [ìì²´ ì—ë””í„° ìŠ¤íƒ€ì¼] */
    .editor-toolbar { display: flex; gap: 6px; padding: 8px; background: #f1f2f6; border-bottom: 1px solid #ced6e0; border-radius: 12px 12px 0 0; flex-wrap:wrap; }
    .editor-btn { 
      padding: 6px 12px; font-weight: 900; background: #fff; border: 1px solid #dcdde1; border-radius: 6px; cursor: pointer; font-size:14px; flex: 0 0 auto; 
      min-width: 40px; min-height: 40px; display:flex; align-items:center; justify-content:center;
    }
    .editor-btn:active { background: #e2e6ea; transform:scale(0.95); }
    .editor-content { min-height: 250px; max-height: 400px; overflow-y: auto; padding: 12px; border: 1px solid #ced6e0; border-top: none; border-radius: 0 0 12px 12px; outline: none; background: #fff; -webkit-user-select: text; user-select: text; white-space: pre-wrap; line-height: 1.5; font-size:16px; }
    .editor-content:focus { box-shadow: inset 0 0 0 2px rgba(52,152,219,.15); }
    
    /* ë¦¬ìŠ¤íŠ¸, ì´ë¯¸ì§€, í‘œ ìŠ¤íƒ€ì¼ */
    .editor-content ul { padding-left: 20px; margin: 8px 0; }
    .editor-content li { list-style-type: disc; margin-bottom: 4px; }
    .editor-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 4px 0; }
    .editor-content table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    .editor-content td { border: 1px solid #dcdde1; padding: 8px; vertical-align: top; }

    #adminMenuOverlay .modal{ padding-bottom: 18px; max-height: 88vh; overflow-y: auto; overscroll-behavior: contain; }
    #adminMenuOverlay .modal::-webkit-scrollbar{ width: 10px; }
    #adminMenuOverlay .modal::-webkit-scrollbar-thumb{ background: #bdc3c7; border-radius: 999px; border: 3px solid rgba(0,0,0,0); background-clip: padding-box; }
    #adminMenuOverlay .modal::-webkit-scrollbar-track{ background: transparent; border-radius: 999px; }
    
    #sec-emp .grid{ grid-template-columns: 1fr !important; }
    #sec-emp .card{ border-radius: 22px; }
    #sec-emp h2{ font-size: 22px; }
    #sec-emp table{ min-width: 860px; }

    .calHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .calGrid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .calCellHeader{ text-align:center; font-weight:900; color:var(--muted); font-size:13px; padding-bottom:6px; }
    .calDay{ min-height: 80px; background: #fff; border: 1px solid var(--line); border-radius: 12px; padding: 6px 8px; display:flex; flex-direction:column; gap:4px; position:relative; }
    .calDay.empty{ background:none !important; border:none; }
    .calDay.today{ border-color: var(--accent); background: rgba(52,152,219,.05) !important; }
    .calNum{ font-size:14px; font-weight:800; color:var(--muted); }
    .calData{ margin-top: auto; text-align:right; }
    .calTime{ font-size: 13px; font-weight: 800; color: var(--text); display:block; }
    .calPay{ font-size: 11px; color: var(--good); font-weight: 700; display:block; margin-top:2px; }
    .calDay:hover{ background: #f8f9fa !important; }

    .totalWageBox { background: var(--panel2); border: 2px solid var(--accent); border-radius: 14px; padding: 16px; text-align:center; margin-bottom: 14px; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .totalWageLabel { color: var(--muted); font-size: 13px; font-weight: 800; }
    .totalWageValue { color: var(--text); font-size: 20px; font-weight: 900; }
    .totalWageDetail { color: var(--good); font-size: 13px; font-weight: 700; }
    
    #syncStatus { position:fixed; top:5px; left:50%; transform:translateX(-50%); font-size:10px; color:white; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; z-index:9999; }
    
    #quickButtons { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    #quickButtons .btn { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 16px; }
    #quickButtons .btn .muted { font-size: 12px; font-weight: normal; }
    
    /* [íˆ¬ë‘ë©”ì´íŠ¸ ìŠ¤íƒ€ì¼] */
    .mate-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
    .mate-title { font-size: 18px; font-weight: 900; }
    .mate-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 14px; }
    .mate-day-head { text-align: center; font-size: 12px; color: var(--muted); font-weight: 700; padding-bottom: 4px; }
    .mate-cell { 
        aspect-ratio: 1/1.1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; 
        border-radius: 10px; padding-top:6px; cursor: pointer; position:relative; border: 1px solid transparent;
    }
    .mate-cell.today { background-color: #f0f8ff; border-color: var(--accent); }
    .mate-cell.selected { background-color: var(--accent); color: #fff; box-shadow: 0 4px 10px rgba(52,152,219,0.3); }
    .mate-date-num { font-size: 14px; font-weight: 700; z-index:1; }
    .mate-dots { display:flex; gap:2px; margin-top:4px; flex-wrap:wrap; justify-content:center; max-width:80%; }
    .mate-dot { width: 5px; height: 5px; border-radius: 50%; background: #e0e0e0; }
    .mate-dot.done { background: var(--good); } 
    
    .mate-list-area { background: #f8f9fa; border-radius: 14px; padding: 14px; min-height: 200px; }
    .mate-item { display:flex; align-items:center; gap:10px; padding: 12px; background:#fff; border:1px solid var(--line); border-radius:12px; margin-bottom:8px; transition:all 0.2s; }
    .mate-item.done { opacity: 0.6; }
    .mate-check { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--line); display:flex; align-items:center; justify-content:center; cursor: pointer; flex: 0 0 auto; }
    .mate-check.checked { background: var(--good); border-color: var(--good); color: #fff; }
    .mate-text { flex:1; font-size:15px; font-weight:600; line-height:1.3; }
    .mate-tag { font-size:10px; padding:2px 6px; border-radius:4px; background:#eee; color:#666; font-weight:700; }

    /* [ë£¨í‹´ ì„¤ì • ìŠ¤íƒ€ì¼] */
    .routine-opt { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:8px; }
    .routine-btn { padding: 8px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:13px; cursor:pointer; }
    .routine-btn.active { background:var(--accent); color:#fff; border-color:transparent; font-weight:700; }
    .day-selector { display:flex; gap:4px; margin-top:4px; }
    .day-btn { width:32px; height:32px; border-radius:50%; border:1px solid var(--line); background:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
    .day-btn.active { background:var(--accent); color:#fff; border-color:transparent; }

    /* [Z-Index ì •ë¦¬ - íŒì—… ìˆœì„œ í•´ê²°] */
    #adminMenuOverlay { z-index: 1000; }
    #mateOverlay, #actionLogOverlay, #empEditOverlay, #logEditOverlay, #logAddOverlay, #todoOverlay { z-index: 2000; }
    #routineSetOverlay { z-index: 3000; }
    #noticeOverlay, #closeCheckOverlay, #outNoteOverlay, .toast { z-index: 5000; }
    #pinOverlay { z-index: 9999; }
  </style>
</head>

<body>
<div id="syncStatus">ì„œë²„ ì—°ê²° ì¤‘...</div>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap"><img id="logoImg" class="logo" alt="ê°€ê²Œ ë¡œê³ " src="tamnayo.png" /></div>
    </div>
    <div class="right">
      <div class="clockBlock"><div class="time" id="nowTime">--:--:--</div><div class="date" id="nowDate">----</div></div>
    </div>
  </div>
</header>

<main>
  <section class="section active" id="sec-att">
    <div class="grid">
      <div class="card">
        <h2>ì¶œê·¼ / í‡´ê·¼ ì°ê¸°</h2>
        <div class="split">
          <div><label>ì•Œë°” ì½”ë“œ (ìë™ ì…ë ¥)</label><input id="attCode" inputmode="numeric" autocomplete="off" placeholder="ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" maxlength="4" readonly /></div>
          <div><label>ì´ë¦„ (ìë™ í‘œì‹œ)</label><input id="attName" disabled placeholder="-" /></div>
        </div>
        <div class="big-actions"><button class="btn good" id="btnIn">ì¶œê·¼</button><button class="btn bad" id="btnOut">í‡´ê·¼</button></div>
        <div class="row" style="margin-top:10px;">
          <span class="pill">ìƒíƒœ: <strong id="attStatus">-</strong></span>
          <span class="pill">ë§ˆì§€ë§‰ ê¸°ë¡: <strong id="attLast">-</strong></span>
          <span class="spacer"></span>
          <button class="btn small" id="btnClearCode">ì§€ìš°ê¸°</button>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:12px;">
          <div style="flex:1 1 100%;">
            <div class="muted" style="font-size:13px; font-weight:900;">ë¹ ë¥¸ ì„ íƒ (ì•Œë°”ìƒ ë²„íŠ¼)</div>
            <div id="quickButtons" style="margin-top:8px;"></div>
            <div class="note">
              â€¢ ì•Œë°”ìƒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì½”ë“œê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.<br/>
              â€¢ ì¶œí‡´ê·¼ ëˆ„ë½ ì‹œ <b>ì‚¬ì¥ë‹˜ê»˜ ë§ì”€í•´ì£¼ì„¸ìš”.</b>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>ìµœê·¼ ê¸°ë¡ (ìµœì‹  15ê°œ)</h2>
        <div style="overflow:auto; max-height: 520px;">
          <table>
            <thead><tr><th style="width:90px;">ìœ í˜•</th><th style="width:90px;">ì½”ë“œ</th><th class="nameCell">ì´ë¦„</th><th style="width:200px;">ì‹œê°„</th></tr></thead>
            <tbody id="recentTable"></tbody>
          </table>
        </div>
        <div class="note">ìµœê·¼ ê¸°ë¡ì€ ëˆ„ë½ ë°©ì§€ë¥¼ ìœ„í•œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-emp">
    <div class="card">
      <div class="row"><h2 style="margin:0;">ì•Œë°”ìƒ ê´€ë¦¬ (ê´€ë¦¬ì)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromEmp">â† ì¶œê·¼/í‡´ê·¼</button></div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card" style="box-shadow:none;">
          <h2>ì•Œë°”ìƒ ë“±ë¡</h2>
          <div class="split">
            <div><label>ì´ë¦„</label><input id="empName" placeholder="ì˜ˆ) í™ê¸¸ë™" maxlength="30" /></div>
            <div><label>ë©”ëª¨ (ì„ íƒ)</label><input id="empMemo" placeholder="ì˜ˆ) ì£¼ë§ë§Œ" maxlength="60" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>ê·¼ë¬´ êµ¬ë¶„</label><select id="empShiftType"><option value="MID">ë¯¸ë“¤</option><option value="CLOSE">ë§ˆê°</option></select></div>
            <div><label>í‰ì¼ ì‹œê¸‰</label><input id="empWage" type="number" placeholder="ì˜ˆ) 10030" inputmode="numeric" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label style="color:var(--warn)">ì£¼ë§ ì‹œê¸‰ (í† ,ì¼)</label><input id="empWageWeekend" type="number" placeholder="ì„ íƒ (ë¹„ì›Œë‘ë©´ í‰ì¼ë™ì¼)" inputmode="numeric" /></div>
            <div></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>ê·¼ë¬´ ì‹œì‘ ì‹œê°„</label><input id="empWorkStart" type="time" value="17:00" /></div>
            <div><label>ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</label><input id="empWorkEnd" type="time" value="23:30" /></div>
          </div>
          <div class="row" style="margin-top:10px;"><button class="btn primary" id="btnAddEmp">ë“±ë¡</button><span class="muted" id="nextCodeHint"></span></div>
        </div>
        <div class="card" style="box-shadow:none;">
          <h2>ì•Œë°”ìƒ ì¡°íšŒ / ì‚­ì œ</h2>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1 1 260px;"><label>ê²€ìƒ‰</label><input id="empSearch" placeholder="ì˜ˆ) 0002 ë˜ëŠ” ê¸¸ë™" /></div>
            <div class="spacer"></div><button class="btn small" id="btnRefreshEmp">ìƒˆë¡œê³ ì¹¨</button>
          </div>
          <div style="overflow:auto; max-height: 520px;">
            <table>
              <thead><tr><th style="width:90px;">ì½”ë“œ</th><th class="nameCell" style="width:160px;">ì´ë¦„</th><th style="width:90px;">êµ¬ë¶„</th><th>ì‹œê¸‰(í‰/ì£¼)</th><th>ê·¼ë¬´ì‹œê°„</th><th style="width:110px;">ì‚­ì œ</th></tr></thead>
              <tbody id="empTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-log">
    <div class="card">
      <div class="row"><h2 style="margin:0;">ê·¼íƒœ ì¡°íšŒ (ê´€ë¦¬ì)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromLog">â† ì¶œê·¼/í‡´ê·¼</button></div>
      <div class="hr"></div>
      <div class="row" style="margin-bottom:10px; gap:10px; flex-wrap:wrap;">
        <span class="pill">ì „ì²´ ê¸°ë¡: <strong id="logTotal">0</strong>ê±´</span>
        <label class="muted" style="display:flex; align-items:center; gap:8px;">ì•Œë°”ìƒ í•„í„°<select id="logFilterEmp" style="min-width:180px;"></select></label>
        <div class="spacer"></div>
        <button class="btn small" id="btnAddShift">ê·¼ë¬´ ì¶”ê°€</button>
        <button class="btn small warn" id="btnExportCsv">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="hr"></div>
      
      <div class="totalWageBox">
        <div class="totalWageLabel" id="totalWageTitle">--ì›” ì˜ˆìƒ ê¸‰ì—¬</div>
        <div class="totalWageValue" id="totalWageAmount">0ì›</div>
        <div class="totalWageDetail" id="totalWageDetail">(ê¸°ë³¸ 0 + ì£¼íœ´ 0)</div>
      </div>

      <div class="calHeader">
        <button class="btn small" id="calPrevBtn">â—€ ì´ì „ë‹¬</button>
        <h3 id="calTitle" style="margin:0; font-size:18px;">202X. XX</h3>
        <button class="btn small" id="calNextBtn">ë‹¤ìŒë‹¬ â–¶</button>
      </div>
      <div class="calGrid" id="calendarView"></div>
      
      <div class="note" style="margin:14px 0;">â€¢ ì¼ìš”ì¼ì— í•´ë‹¹ ì£¼ì˜ ì£¼íœ´ìˆ˜ë‹¹(15ì‹œê°„â†‘)ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      
      <div style="overflow:auto; max-height: 540px;">
        <table>
          <thead><tr><th style="width:110px;">ìœ í˜•</th><th style="width:90px;">ì½”ë“œ</th><th class="nameCell" style="width:160px;">ì´ë¦„</th><th style="width:220px;">ì‹œê°„</th><th>ë¹„ê³ </th><th style="width:90px;">ìˆ˜ì •</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">í‡´ê·¼ íŠ¹ì´ì‚¬í•­ (ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œì™¸)</div>
      <div style="overflow:auto; max-height: 360px;">
        <table>
          <thead><tr><th style="width:70px;">ìˆœë²ˆ</th><th style="width:110px;">ë‚ ì§œ</th><th style="width:90px;">ì½”ë“œ</th><th style="width:140px;">ì‘ì„±ì</th><th style="width:180px;">ì‹œê°„</th><th>ë‚´ìš©</th></tr></thead>
          <tbody id="outNoteTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸ ê¸°ë¡</div>
      <div style="overflow:auto; max-height: 280px;">
        <table>
          <thead><tr><th style="width:70px;">ìˆœë²ˆ</th><th style="width:110px;">ë‚ ì§œ</th><th style="width:90px;">ì½”ë“œ</th><th style="width:140px;">ì‘ì„±ì</th><th style="width:180px;">ì‹œê°„</th><th>ì²´í¬</th></tr></thead>
          <tbody id="closeCheckTable"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<div class="modalOverlay" id="adminMenuOverlay" role="dialog" aria-modal="true" style="z-index: 1000;">
  <div class="modal">
    <h3>ê´€ë¦¬ì ë©”ë‰´</h3>
    <div class="muted" id="adminStateText">ê´€ë¦¬ì ëª¨ë“œ (PIN ì—†ìŒ)</div>
    <div class="menuGrid">
      <button class="btn primary" id="goEmp">ì•Œë°”ìƒ ê´€ë¦¬</button>
      <button class="btn primary" id="goLog">ê·¼íƒœ ì¡°íšŒ</button>
      <button class="btn good" id="btnOpenMate">ì—…ë¬´/ë£¨í‹´ ê´€ë¦¬</button>
      <button class="btn" id="btnShowActionLogs">ì‹œìŠ¤í…œ ë¡œê·¸ ë³´ê¸°</button>
      <button class="btn warn" id="btnExportCsv2">CSV ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn bad" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”</button>
      <button class="btn" id="btnLockAdmin">ê´€ë¦¬ì ì ê¸ˆ</button>
    </div>
    <div class="hr"></div><div class="hr"></div>
    <div class="muted" style="font-size:13px; font-weight:900;">ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸ í¸ì§‘</div>
    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
      <div style="flex: 2 1 240px;"><label>í•­ëª© ì¶”ê°€</label><input id="adminCloseNewItem" placeholder="ì˜ˆ) í¬ìŠ¤ ë§ˆê° ì •ì‚°" maxlength="60" /></div>
      <div style="flex: 0 0 auto; align-self:flex-end; display:flex; gap:8px;">
        <button class="btn" id="btnAddCloseChecklistItem">ì¶”ê°€</button>
        <button class="btn primary" id="btnSaveCloseChecklist">ì €ì¥</button>
        <button class="btn" id="btnResetCloseChecklist">ê¸°ë³¸ê°’</button>
      </div>
    </div>
    <div id="adminCloseChecklistList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
    
    <div class="muted" style="margin-top:10px; font-size:13px; font-weight:900;">ì˜¤ëŠ˜ì˜ ê³µì§€ (ìì²´ ì—ë””í„°)</div>
    <div class="row" style="margin-top:8px; align-items:center;">
      <label style="margin:0;">ìœ ì§€ ì‹œê°„(ì´ˆ):</label>
      <input id="adminNoticeDuration" type="number" value="5" style="width:60px; text-align:center;" />
    </div>

    <div style="margin-top:8px; border:1px solid #ced6e0; border-radius:12px; overflow:hidden;">
      <div class="editor-toolbar">
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('bold')" title="êµµê²Œ"><b>B</b></button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('underline')" title="ë°‘ì¤„" style="text-decoration:underline;">U</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('foreColor', '#e74c3c')" title="ë¹¨ê°„ìƒ‰" style="color:#e74c3c; font-weight:900;">A</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('fontSize', '5')" title="í¬ê²Œ">ê°€</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" title="ë¦¬ìŠ¤íŠ¸">â—</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); insertTable()" title="í‘œ ì‚½ì…">â–¦</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); document.getElementById('imgUploadInput').click()" title="ì´ë¯¸ì§€ ì‚½ì…">ğŸ–¼ï¸</button>
        <button class="editor-btn" onmousedown="event.preventDefault(); execCmd('removeFormat')" title="ì´ˆê¸°í™”">ì§€ìš°ê¸°</button>
      </div>
      <div id="adminNoticeInput" class="editor-content" contenteditable="true" inputmode="text"></div>
      <input type="file" id="imgUploadInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="btnSaveTodayNotice">ì˜¤ëŠ˜ ê³µì§€ ì €ì¥</button>
      <button class="btn" id="btnClearTodayNotice">ì˜¤ëŠ˜ ê³µì§€ ë¹„ìš°ê¸°</button>
    </div>
    <div class="modalActions"><button class="btn" id="adminMenuClose">ë‹«ê¸°</button></div>
  </div>
</div>

<div class="modalOverlay" id="mateOverlay" style="z-index: 2000;">
  <div class="modal" style="max-width:600px; height:90vh; display:flex; flex-direction:column;">
    <div class="mate-header">
      <h3 class="mate-title">ì—…ë¬´ & ë£¨í‹´ ê´€ë¦¬</h3>
      <button class="btn small" id="btnOpenRoutineSet">ë£¨í‹´ ì„¤ì • âš™ï¸</button>
    </div>
    
    <div class="calHeader">
        <button class="btn small" id="matePrevMonth">â—€</button>
        <span id="mateMonthTitle" style="font-weight:900;">202X. XX</span>
        <button class="btn small" id="mateNextMonth">â–¶</button>
    </div>
    <div class="mate-grid" id="mateCalendar"></div>
    
    <div class="hr"></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span id="mateSelectedDate" class="tag in">ì˜¤ëŠ˜ì˜ í•  ì¼</span>
        <button class="btn small" id="btnAddOneTimeTask">+ 1íšŒì„± ì¶”ê°€</button>
    </div>
    <div class="mate-list-area" id="mateListArea" style="flex:1; overflow-y:auto;">
        </div>
    
    <div style="margin-top:10px;">
        <button class="btn" onclick="document.getElementById('mateOverlay').classList.remove('show')" style="width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="routineSetOverlay" style="z-index: 3000;">
  <div class="modal">
    <h3>ë£¨í‹´ ë§Œë“¤ê¸°</h3>
    <div class="muted">ë°˜ë³µë˜ëŠ” ì—…ë¬´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <label>í•  ì¼ ë‚´ìš©</label>
    <input id="routineInput" placeholder="ì˜ˆ: ì˜¤í”ˆ ì¤€ë¹„, ë§ˆê° ì²­ì†Œ" />
    
    <label style="margin-top:10px;">ë°˜ë³µ ì£¼ê¸°</label>
    <div class="routine-opt" id="routineTypeBox">
        <div class="routine-btn active" data-type="daily">ë§¤ì¼</div>
        <div class="routine-btn" data-type="weekly">ë§¤ì£¼ (ìš”ì¼ì§€ì •)</div>
        <div class="routine-btn" data-type="monthly">ë§¤ì›” (ë‚ ì§œì§€ì •)</div>
    </div>
    
    <div id="weekSelector" class="day-selector" style="display:none;">
        <div class="day-btn" data-d="0">ì¼</div>
        <div class="day-btn" data-d="1">ì›”</div>
        <div class="day-btn" data-d="2">í™”</div>
        <div class="day-btn" data-d="3">ìˆ˜</div>
        <div class="day-btn" data-d="4">ëª©</div>
        <div class="day-btn" data-d="5">ê¸ˆ</div>
        <div class="day-btn" data-d="6">í† </div>
    </div>
    
    <div id="monthSelector" style="display:none; margin-top:4px;">
        <input type="number" id="routineMonthDay" placeholder="1~31ì¼ ì…ë ¥" style="width:80px;" /> ì¼ ë§ˆë‹¤
    </div>

    <div class="split" style="margin-top:20px;">
        <button class="btn" onclick="document.getElementById('routineSetOverlay').classList.remove('show')">ì·¨ì†Œ</button>
        <button class="btn primary" id="btnSaveRoutine">ì €ì¥</button>
    </div>
    
    <div class="hr"></div>
    <h4>ë“±ë¡ëœ ë£¨í‹´ ëª©ë¡</h4>
    <div id="routineListBody" style="max-height:150px; overflow-y:auto; font-size:13px;"></div>
  </div>
</div>

<div class="modalOverlay" id="actionLogOverlay" style="z-index: 2000;">
  <div class="modal" style="width: 100%; max-width: 700px;">
    <h3>ì‹œìŠ¤í…œ ë¡œê·¸ (í„°ì¹˜ ê¸°ë¡)</h3>
    <div class="muted">ìµœê·¼ 100ê°œì˜ í„°ì¹˜/ë™ì‘ ê¸°ë¡ì…ë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div style="max-height:500px; overflow-y:auto;">
      <table style="width:100%;">
        <thead><tr><th>ì‹œê°„</th><th>ë™ì‘</th><th>ìƒì„¸</th></tr></thead>
        <tbody id="actionLogTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px; text-align:right;">
      <button class="btn" onclick="document.getElementById('actionLogOverlay').classList.remove('show')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="noticeOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ì˜¤ëŠ˜ì˜ ê³µì§€</h3>
    <div class="muted" id="noticeDateText">-</div>
    <div class="hr"></div>
    <div id="noticeText" class="editor-content" style="border:none; padding:0; min-height:auto;"></div>
    <div class="countWrap">
      <div class="ring"><svg viewBox="0 0 80 80"><circle class="bg" cx="40" cy="40" r="30"></circle><circle class="fg" id="noticeRing" cx="40" cy="40" r="30"></circle></svg><div class="num" id="noticeNum">5</div></div>
    </div>
    <div class="modalActions"><button class="btn primary" id="noticeOk" disabled>ìˆ™ì§€í•˜ì˜€ìŠµë‹ˆë‹¤</button></div>
  </div>
</div>

<div class="modalOverlay" id="outNoteOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ì˜¤ëŠ˜ì˜ íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</h3>
    <div class="muted" id="outNoteDesc">í‡´ê·¼ ì €ì¥ ì „ì— íŠ¹ì´ì‚¬í•­ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</div>
    <div class="hr"></div>
    <label>íŠ¹ì´ì‚¬í•­</label>
    <div class="row" style="gap:8px; margin:8px 0 10px;">
      <button class="btn small" type="button" data-cat="ëˆ„ë½">ëˆ„ë½</button>
      <button class="btn small" type="button" data-cat="í™˜ë¶ˆ">í™˜ë¶ˆ</button>
      <button class="btn small" type="button" data-cat="ë¬¼í’ˆ">ë¬¼í’ˆ</button>
      <button class="btn small" type="button" data-cat="ê¸°íƒ€">ê¸°íƒ€</button>
    </div>
    <textarea id="outNoteText" placeholder="ì˜ˆ)&#10;[í™˜ë¶ˆ] 18:20 ìŒë£Œ ëˆ„ë½ í™˜ë¶ˆ&#10;[ì¬ê³ ] ê³ ë¬´ì¥ê°‘ ì—†ìŒ&#10;[ê¸°íƒ€] 17:55 í˜„ê¸ˆê²°ì œ or ê±´ì˜ì‚¬í•­&#10;&#10;ê·¼ë¬´ ì¤‘ ë°œìƒí•œ íŠ¹ì´ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.&#10;íŠ¹ì´ì‚¬í•­ì´ ì—†ë‹¤ë©´ ê±´ë„ˆë›°ê¸°!"></textarea>
    <div class="modalActions">
      <button class="btn" id="outNoteSkip">ê±´ë„ˆë›°ê¸°</button>
      <button class="btn primary" id="outNoteSave">ì €ì¥ í›„ í‡´ê·¼</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="empEditOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ì•Œë°”ìƒ ì •ë³´ ìˆ˜ì •</h3>
    <div class="muted">ì´ë¦„/êµ¬ë¶„/ê·¼ë¬´ì‹œê°„/ì‹œê¸‰/ë©”ëª¨ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì½”ë“œ</label><input id="empEditCode" readonly /></div>
      <div><label>ì´ë¦„</label><input id="empEditName" placeholder="ì˜ˆ) í™ê¸¸ë™" maxlength="20" /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div>
        <label>ê·¼ë¬´ êµ¬ë¶„</label>
        <select id="empEditShiftType"><option value="MID">ë¯¸ë“¤</option><option value="CLOSE">ë§ˆê°</option></select>
      </div>
      <div>
        <label>í‰ì¼ ì‹œê¸‰</label>
        <input id="empEditWage" type="number" placeholder="ìˆ«ìë§Œ ì…ë ¥" />
      </div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label style="color:var(--warn)">ì£¼ë§ ì‹œê¸‰ (í† ,ì¼)</label><input id="empEditWageWeekend" type="number" placeholder="ì„ íƒ" /></div>
      <div></div>
    </div>
    <label>ë©”ëª¨</label>
    <input id="empEditMemo" placeholder="ë©”ëª¨(ì„ íƒ)" maxlength="30" />
    <div class="split" style="margin-top:10px;">
      <div><label>ê·¼ë¬´ ì‹œì‘</label><input id="empEditWorkStart" type="time" /></div>
      <div><label>ê·¼ë¬´ ì¢…ë£Œ</label><input id="empEditWorkEnd" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="empEditCancel">ì·¨ì†Œ</button>
      <button class="btn primary" id="empEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logAddOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ê·¼ë¬´ ì¶”ê°€</h3>
    <div class="muted">ëˆ„ë½ëœ ê·¼ë¬´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤. (ê´€ë¦¬ì)</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì•Œë°”ìƒ</label><select id="logAddEmp"></select></div>
      <div>
        <label>ì¶”ê°€ ìœ í˜•</label>
        <select id="logAddMode"><option value="SHIFT">ì¶œê·¼+í‡´ê·¼</option><option value="IN">ì¶œê·¼ë§Œ</option><option value="OUT">í‡´ê·¼ë§Œ</option></select>
      </div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>ë‚ ì§œ</label><input id="logAddDate" type="date" /></div>
      <div><label>ë¹„ê³ </label><input id="logAddNote" placeholder="ì˜ˆ) ëˆ„ë½ ë³´ì •" maxlength="60" /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì¶œê·¼ ì‹œê°„</label><input id="logAddInTime" type="time" /></div>
      <div><label>í‡´ê·¼ ì‹œê°„</label><input id="logAddOutTime" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="logAddCancel">ì·¨ì†Œ</button>
      <button class="btn primary" id="logAddSave">ì¶”ê°€</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logEditOverlay" role="dialog" aria-modal="true" style="z-index: 2000;">
  <div class="modal">
    <h3>ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì •</h3>
    <div class="muted">ì‹œê°„/ìœ í˜•/ë¹„ê³ ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>ì½”ë“œ</label><input id="logEditCode" readonly /></div>
      <div><label>ì´ë¦„</label><input id="logEditName" readonly /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>ìœ í˜•</label><select id="logEditType"><option value="IN">ì¶œê·¼</option><option value="OUT">í‡´ê·¼</option></select></div>
      <div><label>ì‹œê°„</label><input id="logEditTs" type="datetime-local" /></div>
    </div>
    <label style="margin-top:10px;">ë¹„ê³ </label>
    <textarea id="logEditNote" placeholder="ì˜ˆ) ì¡°í‡´ / ë³‘ì› / íŠ¹ì´ì‚¬í•­"></textarea>
    <div class="modalActions">
      <button class="btn" id="logEditCancel">ì·¨ì†Œ</button>
      <button class="btn bad" id="logEditDelete">ì‚­ì œ</button>
      <button class="btn primary" id="logEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="closeCheckOverlay" role="dialog" aria-modal="true" style="z-index: 5000;">
  <div class="modal">
    <h3>ë§ˆê° ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
    <div class="muted">ë§ˆê° í•­ëª©ì„ ì²´í¬í•œ ë’¤ í‡´ê·¼ì„ ì™„ë£Œí•˜ì„¸ìš”.</div>
    <div class="hr"></div>
    <div id="closeCheckList" class="checkList"></div>
    <div class="modalActions" style="margin-top:20px;">
      <button class="btn primary" id="closeCheckDone" disabled>ì™„ë£Œ í›„ í‡´ê·¼</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="pinOverlay" role="dialog" aria-modal="true" style="z-index: 9999;">
  <div class="modal">
    <h3 id="pinTitle">ê´€ë¦¬ì PIN</h3>
    <div class="muted" id="pinDesc">ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ PINì„ ì…ë ¥í•˜ì„¸ìš”.</div>
    <div class="hr"></div>
    <div id="pinUnlockBlock">
      <label>PIN ì…ë ¥</label><input id="pinInput" inputmode="numeric" autocomplete="off" placeholder="PIN" maxlength="8" />
      <div class="note">í•´ì œ í›„ <b>10ë¶„</b> ë™ì•ˆ ê´€ë¦¬ì ê¸°ëŠ¥ì´ ì—´ë¦½ë‹ˆë‹¤.</div>
    </div>
    <div class="modalActions">
      <button class="btn" id="pinCancel">ì·¨ì†Œ</button>
      <button class="btn primary" id="pinOk">í™•ì¸</button>
    </div>
  </div>
</div>

<input id="restoreInput" type="file" accept="application/json" style="display:none;" />

<script type="module">
  // [ì¤‘ìš”] getToday í•¨ìˆ˜ë¥¼ ê°€ì¥ ë¨¼ì € ì •ì˜í•´ì„œ ì—ëŸ¬ ë°©ì§€
  window.getToday = function() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbdEqVxEOcA3qFEcYEH9yuvNRx_CTMxhE",
    authDomain: "tamna-hr.firebaseapp.com",
    projectId: "tamna-hr",
    storageBucket: "tamna-hr.firebasestorage.app",
    messagingSenderId: "766306504997",
    appId: "1:766306504997:web:3e4e77bc14101cd6660acc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let SERVER_CACHE = {}; 
  
  // ìì²´ ì—ë””í„° ëª…ë ¹ ì‹¤í–‰ í•¨ìˆ˜ (ê¸€ë¡œë²Œ)
  window.execCmd = function(command, value = null) {
    document.execCommand(command, false, value);
  };
  
  // í‘œ ì‚½ì… í•¨ìˆ˜
  window.insertTable = function() {
    const html = `
      <table style="width:100%; border-collapse:collapse; margin:8px 0;">
        <tbody>
          <tr><td style="border:1px solid #dcdde1; padding:8px;">í•­ëª©1</td><td style="border:1px solid #dcdde1; padding:8px;">ë‚´ìš©1</td></tr>
          <tr><td style="border:1px solid #dcdde1; padding:8px;">í•­ëª©2</td><td style="border:1px solid #dcdde1; padding:8px;">ë‚´ìš©2</td></tr>
          <tr><td style="border:1px solid #dcdde1; padding:8px;">í•­ëª©3</td><td style="border:1px solid #dcdde1; padding:8px;">ë‚´ìš©3</td></tr>
        </tbody>
      </table><br/>`;
    document.execCommand('insertHTML', false, html);
  };

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
  window.handleImageUpload = function(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.execCommand('insertImage', false, e.target.result);
      };
      reader.readAsDataURL(input.files[0]);
    }
    input.value = ''; 
  };
  
  // ê¸€ë¡œë²Œ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
  window.recordAction = function(action, detail) {
    const logs = loadJSON('ACTION_LOGS', []);
    logs.push({
      ts: Date.now(),
      time: fmtTS(Date.now()),
      action: action,
      detail: detail
    });
    // ìµœê·¼ 200ê°œë§Œ ìœ ì§€
    if(logs.length > 200) logs.shift();
    saveJSON('ACTION_LOGS', logs);
  };

  onValue(ref(db, 'tamnaData'), (snapshot) => {
    const data = snapshot.val();
    if (data) {
      SERVER_CACHE = data;
      try {
        if(typeof renderAttendancePanel === 'function') renderAttendancePanel();
        if(typeof renderLogAll === 'function') {
          renderLogFilterOptions();
          renderLogAll();
        }
        if(typeof renderEmployees === 'function') renderEmployees();
        
        let status = document.getElementById('syncStatus');
        if(!status) {
          status = document.createElement('div');
          status.id = 'syncStatus';
          status.textContent = "â— ì„œë²„ ë™ê¸°í™”ë¨";
          document.body.appendChild(status);
        }
      } catch(e) {}
    }
  });

  window.saveJSON = async function(key, val) {
    SERVER_CACHE[key] = val;
    await set(ref(db, 'tamnaData'), SERVER_CACHE);
  };

  window.loadJSON = function(key, fallback) {
    return SERVER_CACHE[key] ? SERVER_CACHE[key] : fallback;
  };

  const LS_KEYS = { DAILY_NOTICE: "ALBA_DAILY_NOTICE_V1", OUT_NOTES: "ALBA_OUT_NOTES_V1", CLOSE_CHECKLIST: "ALBA_CLOSE_CHECKLIST_V1", CLOSE_CHECK_LOGS: "ALBA_CLOSE_CHECK_LOGS_V1", EMPLOYEES: "ALBA_EMPLOYEES_V2", NEXT_ID: "ALBA_NEXT_EMP_ID_V2", ATT_LOGS: "ALBA_ATT_LOGS_V2", PIN_HASH: "ALBA_ADMIN_PIN_HASH_V1", PIN_SALT: "ALBA_ADMIN_PIN_SALT_V1" };
  const SS_KEYS = { UNLOCK_UNTIL: "ALBA_ADMIN_UNLOCK_UNTIL_V1" };

  function pad4(n){ return String(n).length>=4?String(n):("0000"+n).slice(-4); }
  function nowTS(){ return Date.now(); }
  function dateKey(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  function todayKey(){ return dateKey(Date.now()); }
  function fmtTS(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`; }
  function toast(msg,type){ const el=document.getElementById("toast"); el.textContent=msg; el.className="toast show "+(type==="danger"?"danger":""); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"),2200); }
  function escapeHtml(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
  function normalizeCodeInput(v){ return (v||"").replace(/\D/g,"").slice(0,4); }

  (function disableDoubleTapZoom(){ let lastTouchEnd=0; document.addEventListener('touchend',function(e){ const now=Date.now(); if(now-lastTouchEnd<=300)e.preventDefault(); lastTouchEnd=now; },{passive:false}); })();

  function getEmployees(){ return loadJSON(LS_KEYS.EMPLOYEES, []); }
  function setEmployees(list){ saveJSON(LS_KEYS.EMPLOYEES, list); }
  function getNextEmpId(){ const v=loadJSON(LS_KEYS.NEXT_ID, 1); const n=v?Number(v):1; return Number.isFinite(n)&&n>=1?Math.floor(n):1; }
  function setNextEmpId(n){ saveJSON(LS_KEYS.NEXT_ID, String(n)); }
  function getLogs(){ return loadJSON(LS_KEYS.ATT_LOGS, []); }
  function setLogs(list){ saveJSON(LS_KEYS.ATT_LOGS, list); }
  function findEmpByCode(code){ return getEmployees().find(e=>e.code===code)||null; }
  
  function getNoticeMap(){ return loadJSON(LS_KEYS.DAILY_NOTICE, {}); }
  function setNoticeMap(map){ saveJSON(LS_KEYS.DAILY_NOTICE, map); }
  
  function getTodayNotice(){ return getNoticeMap()[todayKey()]?.text || ""; }
  function getTodayNoticeDuration(){ return getNoticeMap()[todayKey()]?.duration || 5; } // ê¸°ë³¸ê°’ 5ì´ˆ

  function setTodayNotice(text, duration=5){ 
    const m=getNoticeMap(); 
    m[todayKey()]={text:String(text||""), duration: Number(duration), updatedAt:nowTS()}; 
    setNoticeMap(m); 
  }
  function clearTodayNotice(){ const m=getNoticeMap(); delete m[todayKey()]; setNoticeMap(m); }

  function getOutNotes(){ return loadJSON(LS_KEYS.OUT_NOTES, []); }
  function setOutNotes(list){ saveJSON(LS_KEYS.OUT_NOTES, list); }
  function getCloseChecklist(){ const def=["ê°€ìŠ¤/ì „ê¸° í™•ì¸","ì“°ë ˆê¸°/ì¬í™œìš© ì •ë¦¬","ëƒ‰ì¥ê³  ì •ë¦¬","ë§¤ì¥ ë¶ˆ/ì—ì–´ì»¨ OFF","ì˜¤ë¸/í† í•‘ëŒ€/ë„ìš°ë¡¤ëŸ¬ ì•„ë˜ ë°”ë‹¥ ì“¸ê¸°"]; const list=loadJSON(LS_KEYS.CLOSE_CHECKLIST, null); return Array.isArray(list)&&list.length?list:def; }
  function setCloseChecklist(list){ saveJSON(LS_KEYS.CLOSE_CHECKLIST, list); }
  function getCloseCheckLogs(){ return loadJSON(LS_KEYS.CLOSE_CHECK_LOGS, []); }
  function setCloseCheckLogs(list){ saveJSON(LS_KEYS.CLOSE_CHECK_LOGS, list); }
  function addCloseCheckLog({code,name,items,extra}){ const list=getCloseCheckLogs(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,items:items||[],extra:String(extra||"").trim()}); setCloseCheckLogs(list); }
  function addOutNote({code,name,text}){ const list=getOutNotes(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,text:String(text||"").trim()}); setOutNotes(list); }

  function hasPin(){ return true; } 
  function isAdminUnlocked(){ const u=sessionStorage.getItem(SS_KEYS.UNLOCK_UNTIL); return u && Date.now()<Number(u); }
  function setAdminUnlocked(m=10){ sessionStorage.setItem(SS_KEYS.UNLOCK_UNTIL, String(Date.now()+m*60*1000)); updateAdminStateText(); }
  function lockAdmin(){ sessionStorage.removeItem(SS_KEYS.UNLOCK_UNTIL); updateAdminStateText(); }
  function verifyPin(p){ return p === "0721"; } 

  const pinOverlay=document.getElementById("pinOverlay");
  let pinResolve=null;
  function showPinModal(mode,opts={}){
    document.getElementById("pinTitle").textContent=opts.title||"ê´€ë¦¬ì PIN";
    document.getElementById("pinDesc").textContent=opts.desc||"";
    document.getElementById("pinInput").value="";
    pinOverlay.classList.add("show"); setTimeout(()=>document.getElementById("pinInput")?.focus(),50);
    return new Promise(r=>{ pinResolve=r; });
  }
  function hidePinModal(res){ pinOverlay.classList.remove("show"); if(pinResolve){ pinResolve(res); pinResolve=null; } }
  document.getElementById("pinCancel").addEventListener("click",()=>hidePinModal({ok:false}));
  
  document.getElementById("pinOk").addEventListener("click",()=>{
    const p=(document.getElementById("pinInput").value||"").replace(/\D/g,"");
    if(verifyPin(p)){ setAdminUnlocked(); toast("í•´ì œë¨"); hidePinModal({ok:true}); } else toast("PIN ì˜¤ë¥˜ (0721)");
  });

  async function ensureAdmin(r="ê´€ë¦¬ì ê¸°ëŠ¥"){
    // [ì¤‘ìš”] PIN ê²€ì‚¬ ë¡œì§ ì‚­ì œ (ë°”ë¡œ í†µê³¼)
    return true;
  }

  function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id)?.classList.add("active");
    if(id==="sec-att") renderAttendancePanel();
    if(id==="sec-emp") renderEmployees();
    if(id==="sec-log"){ renderLogFilterOptions(); renderLogAll(); }
    recordAction("í™”ë©´ ì´ë™", id);
  }
  function tickClock(){
    const d=new Date(); document.getElementById("nowTime").textContent=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    document.getElementById("nowDate").textContent=`${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()]})`;
  }
  setInterval(tickClock,250); tickClock();

  const adminMenuOverlay=document.getElementById("adminMenuOverlay");
  function updateAdminStateText(){
    // [ì¤‘ìš”] "PIN í•„ìš”" í…ìŠ¤íŠ¸ ì‚­ì œ, ê·¸ëƒ¥ ê´€ë¦¬ì ëª¨ë“œë¼ê³  í‘œì‹œ
    if(document.getElementById("adminStateText")) {
       document.getElementById("adminStateText").textContent="ê´€ë¦¬ì ëª¨ë“œ (ì ‘ì† ì¤‘)";
    }
  }
  setInterval(updateAdminStateText,500); updateAdminStateText();
  
  function openAdminMenu(){
    // ìì²´ ì—ë””í„°ì— ë‚´ìš© ë¡œë“œ
    document.getElementById("adminNoticeInput").innerHTML = getTodayNotice();
    // ê³µì§€ ìœ ì§€ ì‹œê°„ ë¡œë“œ
    document.getElementById("adminNoticeDuration").value = getTodayNoticeDuration();
    
    renderAdminCloseChecklist();
    adminMenuOverlay.classList.add("show"); updateAdminStateText();
  }
  document.getElementById("adminMenuClose").addEventListener("click",()=>adminMenuOverlay.classList.remove("show"));
  document.getElementById("btnLockAdmin").addEventListener("click",()=>{ lockAdmin(); toast("ì ê¸ˆ ì™„ë£Œ"); adminMenuOverlay.classList.remove("show"); showSection("sec-att"); });
  document.getElementById("goEmp").addEventListener("click",()=>{ adminMenuOverlay.classList.remove("show"); showSection("sec-emp"); });
  document.getElementById("goLog").addEventListener("click",()=>{ adminMenuOverlay.classList.remove("show"); showSection("sec-log"); });
  document.getElementById("btnBackFromEmp").addEventListener("click",()=>showSection("sec-att"));
  document.getElementById("btnBackFromLog").addEventListener("click",()=>showSection("sec-att"));
  
  // ê³µì§€ ì €ì¥ (ìì²´ ì—ë””í„° innerHTML + ì‹œê°„)
  document.getElementById("btnSaveTodayNotice").addEventListener("click",async()=>{ 
      if(await ensureAdmin("ê³µì§€ ì €ì¥")){ 
          const content = document.getElementById("adminNoticeInput").innerHTML;
          const duration = document.getElementById("adminNoticeDuration").value;
          setTodayNotice(content, duration); 
          recordAction("ê³µì§€ ì €ì¥", content.slice(0,10));
          toast("ì €ì¥ë¨"); 
      } 
  });
  
  // ê³µì§€ ì§€ìš°ê¸°
  document.getElementById("btnClearTodayNotice").addEventListener("click",async()=>{ 
      if(await ensureAdmin("ê³µì§€ ì§€ìš°ê¸°")){ 
          clearTodayNotice(); 
          document.getElementById("adminNoticeInput").innerHTML = "";
          document.getElementById("adminNoticeDuration").value = 5; // ê¸°ë³¸ê°’ ë¦¬ì…‹
          recordAction("ê³µì§€ ì‚­ì œ", "ì‚­ì œë¨");
          toast("ì§€ì›Œì§"); 
      } 
  });
  
  let logoTap=0, logoT;
  document.getElementById("logoImg").addEventListener("click",async()=>{
    logoTap++; clearTimeout(logoT); logoT=setTimeout(()=>{logoTap=0},1300);
    if(logoTap>=5){ 
        logoTap=0; 
        openAdminMenu(); // PIN ì—†ì´ ë°”ë¡œ ì˜¤í”ˆ
    }
  });

  const noticeOverlay=document.getElementById("noticeOverlay");
  function setRingProgress(p){ const c=2*Math.PI*30; document.getElementById("noticeRing").style.strokeDasharray=`${c}`; document.getElementById("noticeRing").style.strokeDashoffset=`${c*(1-p)}`; }
  
  async function showNoticeCountdownIfAny(){
    const t=getTodayNotice(); if(!t) return true;
    const duration = getTodayNoticeDuration(); // ì €ì¥ëœ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°

    // [ì¤‘ìš” ìˆ˜ì •] ê³µì§€ ë‚´ìš© ì±„ìš°ê³ , ìŠ¤í¬ë¡¤ì„ ê°•ì œë¡œ ë§¨ ìœ„ë¡œ ì˜¬ë¦¼
    const noticeEl = document.getElementById("noticeText");
    noticeEl.innerHTML = t;
    noticeEl.scrollTop = 0; 

    document.getElementById("noticeDateText").textContent=`${todayKey()} ê³µì§€`;
    const btn=document.getElementById("noticeOk"), num=document.getElementById("noticeNum");
    
    // ë²„íŠ¼ ì´ˆê¸°í™”
    btn.disabled=true; 
    noticeOverlay.classList.add("show"); 
    num.textContent = String(duration); 
    setRingProgress(0);
    
    recordAction("ê³µì§€ íŒì—…", "ë…¸ì¶œë¨");

    return new Promise(r=>{
      let s=Date.now(), tm=setInterval(()=>{
        const e=(Date.now()-s)/1000, p=Math.min(1,e/duration); // duration ì‚¬ìš©
        setRingProgress(p);
        num.textContent=String(Math.max(0,duration-Math.floor(e)));
        if(p>=1){ clearInterval(tm); btn.disabled=false; noticeOverlay.querySelector(".countWrap").style.display="none"; }
      },60);
      const done=()=>{ clearInterval(tm); noticeOverlay.classList.remove("show"); noticeOverlay.querySelector(".countWrap").style.display=""; btn.removeEventListener("click",done); r(true); };
      btn.addEventListener("click",done);
    });
  }

  const outNoteOverlay=document.getElementById("outNoteOverlay");
  function askOutNote(){
    document.getElementById("outNoteText").value=""; outNoteOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ document.getElementById("outNoteSkip").removeEventListener("click",s); document.getElementById("outNoteSave").removeEventListener("click",sv); };
      const s=()=>{ c(); outNoteOverlay.classList.remove("show"); r(null); };
      const sv=()=>{ const t=document.getElementById("outNoteText").value; c(); outNoteOverlay.classList.remove("show"); r(t); };
      document.getElementById("outNoteSkip").addEventListener("click",s); document.getElementById("outNoteSave").addEventListener("click",sv); 
    });
  }
  document.querySelectorAll('#outNoteOverlay button[data-cat]').forEach(b=>{
    b.addEventListener("click",()=>{
      const t=document.getElementById("outNoteText"), cat=b.dataset.cat, pre=`[${cat}] `;
      b.classList.add("cat-active"); setTimeout(()=>b.classList.remove("cat-active"),500);
      const v=t.value||"", lines=v.split("\n"); if(lines[lines.length-1].trim()===pre.trim())return;
      t.value=(v.trim()?v.trim()+"\n":"")+pre; t.focus();
    });
  });

  const closeCheckOverlay=document.getElementById("closeCheckOverlay");
  function openCloseCheckModal(items){
    const lst=document.getElementById("closeCheckList"), done=document.getElementById("closeCheckDone");
    lst.innerHTML=items.map((t,i)=>`<label class="checkItem"><input type="checkbox" data-i="${i}" /><div><div class="t">${escapeHtml(t)}</div></div></label>`).join("");
    done.disabled=false; closeCheckOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ done.removeEventListener("click",d); };
      const d=()=>{
        const boxes=lst.querySelectorAll('input[type="checkbox"]');
        if(!Array.from(boxes).every(b=>b.checked)) return toast("ëª¨ë‘ ì²´í¬í•´ì£¼ì„¸ìš”","danger");
        c(); closeCheckOverlay.classList.remove("show");
        r({skip:false, items:Array.from(boxes).filter(b=>b.checked).map(b=>items[b.dataset.i]), extra:""});
      };
      done.addEventListener("click",d); 
    });
  }

  const attCode=document.getElementById("attCode"), attName=document.getElementById("attName"), attStatus=document.getElementById("attStatus"), attLast=document.getElementById("attLast");
  function getLastEvent(code){ const logs=getLogs(); for(let i=logs.length-1;i>=0;i--)if(logs[i].code===code)return logs[i]; return null; }
  function canClockIn(code){ const l=getLastEvent(code); return !l||l.type!=="IN"; }
  function canClockOut(code){ const l=getLastEvent(code); return !!l&&l.type==="IN"; }
  function nextLogId(){ const logs=getLogs(); let m=0; for(const l of logs)if(Number(l.id)>m)m=Number(l.id); return m+1; }
  function addLog({code,name,type,note=""}){ const l=getLogs(); l.push({id:nextLogId(),code,name,type,ts:nowTS(),note}); setLogs(l); }
  function onCodeChanged(){
    const c=normalizeCodeInput(attCode.value);
    if(c.length!==4){ attName.value=""; attStatus.textContent="-"; attLast.textContent="-"; return; }
    const e=findEmpByCode(c); attName.value=e?e.name:"";
    if(!e){ attStatus.textContent="ë¯¸ë“±ë¡ ì½”ë“œ"; attLast.textContent="-"; return; }
    const l=getLastEvent(c);
    attStatus.textContent=l&&l.type==="IN"?"ì¶œê·¼ ìƒíƒœ":"í‡´ê·¼ ìƒíƒœ";
    attLast.textContent=l?`${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"} Â· ${fmtTS(l.ts)}`:"ê¸°ë¡ ì—†ìŒ";
  }
  attCode.addEventListener("input",onCodeChanged);
  document.getElementById("btnClearCode").addEventListener("click",()=>{attCode.value="";onCodeChanged();});

  document.getElementById("btnIn").addEventListener("click",async()=>{
    const c=attCode.value; if(c.length!==4)return toast("ì•Œë°”ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”");
    const e=findEmpByCode(c); if(!e)return toast("ë¯¸ë“±ë¡ ì½”ë“œ");
    if(!canClockIn(c))return toast("ì´ë¯¸ ì¶œê·¼ ìƒíƒœ");
    recordAction("ì¶œê·¼ ì‹œë„", `${e.name}(${c})`);
    await showNoticeCountdownIfAny();
    addLog({code:c,name:e.name,type:"IN"}); toast(`${e.name} ì¶œê·¼`); 
    recordAction("ì¶œê·¼ ì™„ë£Œ", `${e.name}(${c})`);
    renderAttendancePanel();
  });
  
  document.getElementById("btnOut").addEventListener("click",async()=>{
    const c=attCode.value; if(c.length!==4)return toast("ì•Œë°”ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”");
    const e=findEmpByCode(c); if(!e)return toast("ë¯¸ë“±ë¡ ì½”ë“œ");
    if(!canClockOut(c))return toast("ì¶œê·¼ ê¸°ë¡ ì—†ìŒ");
    
    recordAction("í‡´ê·¼ ì‹œë„", `${e.name}(${c})`);
    let manualNote = await askOutNote();
    let checklistLogStr = "";

    if(e.shiftType==="CLOSE"){
      const res=await openCloseCheckModal(getCloseChecklist());
      if(!res.skip){
        addCloseCheckLog({code:c,name:e.name,items:res.items,extra:res.extra});
        checklistLogStr = `[ë§ˆê°ì²´í¬] ${res.items.join("/")}`;
      }
    }

    if(manualNote) addOutNote({code:c, name:e.name, text:manualNote});

    let combinedNote = "";
    if(manualNote && checklistLogStr) combinedNote = manualNote + "\n" + checklistLogStr;
    else if(manualNote) combinedNote = manualNote;
    else if(checklistLogStr) combinedNote = checklistLogStr;

    addLog({code:c, name:e.name, type:"OUT", note:combinedNote}); 
    toast(`${e.name} í‡´ê·¼`); 
    recordAction("í‡´ê·¼ ì™„ë£Œ", `${e.name}(${c})`);
    renderAttendancePanel();
  });

  function renderRecent(){
    document.getElementById("recentTable").innerHTML=getLogs().slice(-15).reverse().map(l=>`<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name)}</td><td>${fmtTS(l.ts)}</td></tr>`).join("")||`<tr><td colspan="4" class="muted">ê¸°ë¡ ì—†ìŒ</td></tr>`;
  }
  function renderQuickButtons(){
    const div=document.getElementById("quickButtons"), emps=getEmployees();
    if(!emps.length) div.innerHTML=`<span class="muted">ê´€ë¦¬ì ë©”ë‰´ì—ì„œ ì•Œë°”ìƒì„ ë“±ë¡í•˜ì„¸ìš”.</span>`;
    else{
      div.innerHTML=emps.map(e=>`<button class="btn" data-c="${e.code}">${escapeHtml(e.name)} <span class="muted">${e.code}</span></button>`).join("");
      div.querySelectorAll("button").forEach(b=>b.addEventListener("click",()=>{ 
          attCode.value=b.dataset.c; 
          onCodeChanged();
          recordAction("ì•Œë°”ìƒ ì„ íƒ", b.dataset.c); 
      }));
    }
  }
  function renderAttendancePanel(){ renderRecent(); renderQuickButtons(); onCodeChanged(); }

  /* Employee */
  function nextAvailableCode(){ const s=new Set(getEmployees().map(e=>Number(e.code))); for(let i=1;i<=9999;i++)if(!s.has(i))return pad4(i); return pad4(getNextEmpId()); }
  function addEmployee(name,memo,ws,we,st,wage,wageW){
    const emps=getEmployees(), code=nextAvailableCode();
    emps.push({code, name, memo, workStart:ws, workEnd:we, shiftType:st, wage:Number(wage)||0, wageWeekend:Number(wageW)||0, createdAt:nowTS()});
    setEmployees(emps); setNextEmpId(Math.max(getNextEmpId(),Number(code)+1));
  }
  function updateEmployee(code,patch){ const emps=getEmployees(), idx=emps.findIndex(e=>e.code===code); if(idx>=0){ emps[idx]={...emps[idx],...patch}; setEmployees(emps); } }
  document.getElementById("btnAddEmp").addEventListener("click",async()=>{
    if(!await ensureAdmin("ë“±ë¡"))return toast("PIN í•„ìš”");
    try{
      const nm=document.getElementById("empName").value.trim(); if(!nm) throw new Error("ì´ë¦„ ì…ë ¥");
      addEmployee(nm, document.getElementById("empMemo").value, document.getElementById("empWorkStart").value, document.getElementById("empWorkEnd").value, document.getElementById("empShiftType").value, document.getElementById("empWage").value, document.getElementById("empWageWeekend").value);
      document.getElementById("empName").value=""; document.getElementById("empMemo").value=""; document.getElementById("empWage").value=""; document.getElementById("empWageWeekend").value="";
      toast("ë“±ë¡ ì™„ë£Œ"); renderEmployees(); renderQuickButtons();
      recordAction("ì•Œë°”ìƒ ë“±ë¡", nm);
    }catch(e){ toast(e.message); }
  });
  document.getElementById("btnRefreshEmp").addEventListener("click",renderEmployees);
  document.getElementById("empSearch").addEventListener("input",renderEmployees);
  function renderEmployees(){
    document.getElementById("nextCodeHint").textContent=`ë‹¤ìŒ ì½”ë“œ: ${nextAvailableCode()}`;
    const q=document.getElementById("empSearch").value.toLowerCase(), emps=getEmployees().filter(e=>e.code.includes(q)||e.name.toLowerCase().includes(q));
    document.getElementById("empTable").innerHTML=emps.length?emps.map(e=>`<tr><td><span class="tag open">${e.code}</span></td><td>${escapeHtml(e.name)}</td><td class="muted typeCell">${e.shiftType==="CLOSE"?"ë§ˆê°":"ë¯¸ë“¤"}</td><td class="muted">${(e.wage||0).toLocaleString()} / ${e.wageWeekend ? e.wageWeekend.toLocaleString() : '-'}</td><td class="muted timeCell">${e.workStart}~${e.workEnd}</td><td style="text-align:right;"><button class="btn small" onclick="window.editEmp('${e.code}')">ìˆ˜ì •</button> <button class="btn small bad" onclick="window.delEmp('${e.code}')">ì‚­ì œ</button></td></tr>`).join("") : `<tr><td colspan="6" class="muted">ì—†ìŒ</td></tr>`;
  }
  // ì•Œë°”ìƒ ì‚­ì œ ë¡œì§ ìˆ˜ì • (2ë‹¨ê³„ ì§ˆë¬¸)
  window.delEmp=async(c)=>{ 
    if(!await ensureAdmin("ì‚­ì œ")) return;

    // 1ë‹¨ê³„: ì‚¬ëŒ ì‚­ì œ ì—¬ë¶€
    if(!confirm("ì •ë§ ì´ ì•Œë°”ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    // 2ë‹¨ê³„: ê¸°ë¡ ì‚­ì œ ì—¬ë¶€
    const delLogs = confirm("ì´ ì•Œë°”ìƒì˜ 'ëª¨ë“  ì¶œí‡´ê·¼ ê¸°ë¡'ë„ í•¨ê»˜ ì‚­ì œí• ê¹Œìš”?\n(í…ŒìŠ¤íŠ¸ìš©ì´ë©´ [í™•ì¸], ê¸°ë¡ì„ ë‚¨ê¸°ë ¤ë©´ [ì·¨ì†Œ])");
    
    // ì•Œë°”ìƒ ì‚­ì œ
    const l = getEmployees().filter(e=>e.code!==c); 
    setEmployees(l); 
    
    // ê¸°ë¡ ì‚­ì œ (í™•ì¸ ì‹œ)
    if(delLogs) {
        const allLogs = getLogs().filter(log => log.code !== c);
        setLogs(allLogs);
    }

    toast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
    renderEmployees(); 
    renderQuickButtons();
    renderAttendancePanel(); 
    renderLogAll(); 
  };
  window.editEmp=async(c)=>{
    if(!await ensureAdmin("ìˆ˜ì •"))return;
    const e=findEmpByCode(c); if(!e)return;
    document.getElementById("empEditCode").value=e.code; document.getElementById("empEditName").value=e.name;
    document.getElementById("empEditShiftType").value=e.shiftType||"MID"; document.getElementById("empEditWage").value=e.wage||"";
    document.getElementById("empEditWageWeekend").value=e.wageWeekend||"";
    document.getElementById("empEditMemo").value=e.memo||""; document.getElementById("empEditWorkStart").value=e.workStart||"17:00"; document.getElementById("empEditWorkEnd").value=e.workEnd||"23:30";
    document.getElementById("empEditOverlay").classList.add("show");
  };
  document.getElementById("empEditSave").addEventListener("click",()=>{
    const c=document.getElementById("empEditCode").value, n=document.getElementById("empEditName").value.trim();
    if(!n)return toast("ì´ë¦„ ì…ë ¥");
    updateEmployee(c,{
      name:n, shiftType:document.getElementById("empEditShiftType").value,
      wage:Number(document.getElementById("empEditWage").value)||0,
      wageWeekend:Number(document.getElementById("empEditWageWeekend").value)||0,
      memo:document.getElementById("empEditMemo").value,
      workStart:document.getElementById("empEditWorkStart").value, workEnd:document.getElementById("empEditWorkEnd").value
    });
    document.getElementById("empEditOverlay").classList.remove("show"); toast("ìˆ˜ì • ì™„ë£Œ"); renderEmployees(); renderQuickButtons(); renderLogAll();
    recordAction("ì•Œë°”ìƒ ìˆ˜ì •", c);
  });
  document.getElementById("empEditCancel").addEventListener("click",()=>document.getElementById("empEditOverlay").classList.remove("show"));

  /* Logs & Calendar & Wage Logic */
  let calYear=new Date().getFullYear(), calMonth=new Date().getMonth()+1;
  function getDayKey(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
  
  function getAdjustedStartTime(emp, inTs) {
    if (!emp.workStart) return inTs;
    const d = new Date(inTs);
    const [h, m] = emp.workStart.split(':').map(Number);
    const scheduledStart = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    if (inTs < scheduledStart) return scheduledStart; 
    return inTs;
  }

  function getAdjustedWorkTime(emp, inTs, outTs) {
    // shiftTypeì— ìƒê´€ì—†ì´ workEndê°€ ìˆìœ¼ë©´ ì ìš©
    if (!emp.workEnd) return outTs;
    const d = new Date(inTs);
    const [h, m] = emp.workEnd.split(':').map(Number);
    let scheduledEnd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    if (scheduledEnd < inTs) { scheduledEnd += 24 * 60 * 60 * 1000; }
    
    const safetyMs = 60 * 60 * 1000; 
    if (outTs < scheduledEnd) {
      if (scheduledEnd - outTs > safetyMs) return outTs;
      return scheduledEnd;
    } else {
      const diff = outTs - scheduledEnd;
      const tenMins = 10 * 60 * 1000;
      const extra = Math.floor(diff / tenMins) * tenMins;
      return scheduledEnd + extra;
    }
  }

  function calcDayStats(dk, tCode){
    const logs=getLogs().filter(l=>dateKey(l.ts)===dk && (!tCode||l.code===tCode)).sort((a,b)=>a.ts-b.ts);
    let ms=0, pay=0, codeMap={};
    logs.forEach(l=>{ if(!codeMap[l.code])codeMap[l.code]=[]; codeMap[l.code].push(l); });
    Object.keys(codeMap).forEach(c=>{
      const e=findEmpByCode(c);
      let inTs=null;
      const evts=codeMap[c];
      const dateObj = new Date(dk);
      const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
      const wage = (e && isWeekend && e.wageWeekend) ? e.wageWeekend : (e ? e.wage : 0);

      evts.forEach(ev=>{
        if(ev.type==="IN") inTs=ev.ts;
        else if(ev.type==="OUT" && inTs){
          const adjInTs = getAdjustedStartTime(e, inTs);
          const adjOutTs = getAdjustedWorkTime(e, inTs, ev.ts);
          if(adjOutTs > adjInTs) {
             const d=adjOutTs-adjInTs; ms+=d;
             pay+=Math.floor((d/3600000)*wage);
          }
          inTs=null;
        }
      });
    });
    return { h:Math.floor(ms/3600000), m:Math.floor((ms%3600000)/60000), pay, has:logs.length>0 };
  }

  function getWeeklyJuhyuSum(sundayDate, filterCode){
     const endTs = new Date(sundayDate).setHours(23,59,59,999);
     const startDate = new Date(sundayDate); startDate.setDate(startDate.getDate() - 6);
     const startTs = startDate.setHours(0,0,0,0);
     const allLogs = getLogs();
     const employees = getEmployees().filter(e => !filterCode || e.code === filterCode);
     let totalJuhyu = 0;
     employees.forEach(emp => {
       const logs = allLogs.filter(l => l.code === emp.code && l.ts >= startTs && l.ts <= endTs).sort((a,b)=>a.ts-b.ts);
       let ms = 0;
       logs.forEach(l => {
         if(l.type==='IN') l._tIn = l.ts;
         else if(l.type==='OUT') {
           const prevIn = logs.find(x => x.type === 'IN' && x.ts < l.ts && !x._used);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) ms += (adjOutTs - adjInTs); 
             prevIn._used = true; 
           }
         }
       });
       logs.forEach(l => delete l._used);
       const hours = ms / 3600000;
       if(hours >= 15) {
          const juhyuHours = (Math.min(hours, 40) / 40) * 8;
          totalJuhyu += Math.floor(juhyuHours * emp.wage);
       }
     });
     return totalJuhyu;
  }

  function renderCalendar(){
    const g=document.getElementById("calendarView"); if(!g)return;
    document.getElementById("calTitle").textContent=`${calYear}. ${String(calMonth).padStart(2,"0")}`;
    while(g.children.length>7) g.removeChild(g.lastChild);
    const start=new Date(calYear,calMonth-1,1).getDay(), end=new Date(calYear,calMonth,0).getDate(), tFilter=document.getElementById("logFilterEmp").value;
    for(let i=0;i<start;i++){ const d=document.createElement("div"); d.className="calDay empty"; g.appendChild(d); }
    for(let d=1;d<=end;d++){
      const div=document.createElement("div"); div.className="calDay";
      const dateObj = new Date(calYear, calMonth-1, d);
      const k=getDayKey(calYear,calMonth,d); if(k===todayKey())div.classList.add("today");
      const st=calcDayStats(k, tFilter);
      let inner = `<div class="calNum">${d}</div>`;
      if(dateObj.getDay() === 0) { 
         const juhyu = getWeeklyJuhyuSum(dateObj, tFilter);
         if(juhyu > 0) inner += `<span class="tag juhyu">ì£¼íœ´ğŸ’° +${juhyu.toLocaleString()}</span>`;
      }
      if(st.has) inner += `<div class="calData"><span class="calTime">${st.h>0?st.h+'h ':''}${st.m}m</span>${st.pay>0?`<span class="calPay">${st.pay.toLocaleString()}ì›</span>`:''}</div>`;
      div.innerHTML = inner;
      g.appendChild(div);
    }
    updateMonthlyWageEstimate(); 
  }
  document.getElementById("calPrevBtn").addEventListener("click",()=>{ calMonth--; if(calMonth<1){calMonth=12;calYear--;} renderCalendar(); });
  document.getElementById("calNextBtn").addEventListener("click",()=>{ calMonth++; if(calMonth>12){calMonth=1;calYear++;} renderCalendar(); });

  function updateMonthlyWageEstimate() {
    const tEmp = document.getElementById("logFilterEmp").value;
    document.getElementById("totalWageTitle").textContent = `${calMonth}ì›” ì˜ˆìƒ ê¸‰ì—¬ ${tEmp ? '(ì„ íƒëœ ì•Œë°”ìƒ)' : '(ì „ì²´)'}`;
    const targetPrefix = `${calYear}-${String(calMonth).padStart(2,"0")}`;
    const allLogs = getLogs();
    const currentMonthLogs = allLogs.filter(l => dateKey(l.ts).startsWith(targetPrefix));
    const employees = getEmployees().filter(e => !tEmp || e.code === tEmp);
    let totalBase = 0;
    let totalJuhyu = 0;
    employees.forEach(emp => {
      const empLogs = currentMonthLogs.filter(l => l.code === emp.code).sort((a,b)=>a.ts-b.ts);
      let empBaseMs = 0;
      empLogs.forEach(l => {
        if(l.type === 'IN') l._tempIn = l.ts;
        else if(l.type === 'OUT') {
           const prevIn = empLogs.find(xx => xx.type === 'IN' && xx.ts < l.ts && !xx._usedBase);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) {
               const ms = adjOutTs - adjInTs;
               const dt = new Date(l.ts);
               const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;
               const wage = (isWeekend && emp.wageWeekend) ? emp.wageWeekend : emp.wage;
               totalBase += Math.floor((ms / 3600000) * wage);
             }
             prevIn._usedBase = true; 
           }
        }
      });
      empLogs.forEach(l => delete l._usedBase);
      const allEmpLogs = allLogs.filter(l => l.code === emp.code).sort((a,b)=>a.ts-b.ts);
      const weeks = {};
      allEmpLogs.forEach(l => {
        const d = new Date(l.ts);
        const day = d.getDay(); 
        const dist = day === 0 ? 0 : 7 - day;
        const sundayDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + dist);
        const sundayKey = `${sundayDate.getFullYear()}-${String(sundayDate.getMonth()+1).padStart(2,"0")}-${String(sundayDate.getDate()).padStart(2,"0")}`;
        if (!weeks[sundayKey]) weeks[sundayKey] = { ms: 0 };
        if(l.type === 'IN') l._tempIn = l.ts;
        else if(l.type === 'OUT') {
           const prevIn = allEmpLogs.find(xx => xx.type === 'IN' && xx.ts < l.ts && !xx._usedJuhyu);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) weeks[sundayKey].ms += (adjOutTs - adjInTs); 
             prevIn._usedJuhyu = true; 
           }
        }
      });
      allEmpLogs.forEach(l => delete l._usedJuhyu);
      Object.keys(weeks).forEach(sundayKey => {
        if (sundayKey.startsWith(targetPrefix)) {
          const hours = weeks[sundayKey].ms / 3600000;
          if(hours >= 15) {
            const juhyu = Math.floor( ((Math.min(hours, 40)/40)*8) * emp.wage );
            totalJuhyu += juhyu;
          }
        }
      });
    });
    document.getElementById("totalWageAmount").textContent = (totalBase + totalJuhyu).toLocaleString() + "ì›";
    document.getElementById("totalWageDetail").textContent = `(ê¸°ë³¸ ${totalBase.toLocaleString()} + ì£¼íœ´ ${totalJuhyu.toLocaleString()})`;
  }

  function renderLogFilterOptions(){
    const sel=document.getElementById("logFilterEmp"), old=sel.value;
    sel.innerHTML=`<option value="">ì „ì²´ ì•Œë°”ìƒ</option>`+getEmployees().map(e=>`<option value="${e.code}">${e.code} ${escapeHtml(e.name)}</option>`).join("");
    sel.value=old;
  }
  document.getElementById("logFilterEmp").addEventListener("change",renderLogAll);

  function renderLogAll(){
    const f=document.getElementById("logFilterEmp").value, all=getLogs(), list=f?all.filter(l=>l.code===f):all;
    document.getElementById("logTotal").textContent=list.length;
    const makeNoteTag = (note) => {
      if(!note) return "";
      let tags = "";
      if(note.includes("[ë§ˆê°ì²´í¬]")) tags += `<span class="tag good" style="margin-right:4px;">ë§ˆê°âœ…</span>`;
      if(note.includes("[ëˆ„ë½]") || note.includes("[í™˜ë¶ˆ]") || note.includes("[ë¬¼í’ˆ]") || note.includes("[ê¸°íƒ€]")) tags += `<span class="tag warn" style="margin-right:4px;">íŠ¹ì´ğŸ“</span>`;
      if(note.includes("ìˆ˜ë™ì¶”ê°€")) tags += `<span class="tag" style="background:#eee; color:#888;">ìˆ˜ë™</span>`;
      if(!tags) return note.length > 10 ? note.slice(0,10)+"..." : note;
      return tags;
    };
    
    document.getElementById("logTable").innerHTML=list.slice().reverse().map(l=> {
        let timeDisplay = fmtTS(l.ts);
        const emp = findEmpByCode(l.code);
        
        // ì¶œê·¼ ì‹œê°„ ë³´ì • í‘œì‹œ
        if(l.type === "IN" && emp) {
            const adjInTs = getAdjustedStartTime(emp, l.ts);
            if(adjInTs !== l.ts) {
                const d = new Date(adjInTs);
                const adjStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
                timeDisplay += `<br><span class="tag adj">ê¸‰ì—¬ì‹œì‘: ${adjStr}</span>`;
            }
        }
        
        // í‡´ê·¼ ì‹œê°„ ë³´ì • í‘œì‹œ
        if(l.type === "OUT" && emp) {
            const prevIn = list.find(x => x.type === "IN" && x.ts < l.ts && x.code === l.code);
            if(prevIn) {
                const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
                if(adjOutTs !== l.ts) {
                    const d = new Date(adjOutTs);
                    const adjStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
                    timeDisplay += `<br><span class="tag adj">ê¸‰ì—¬ì¢…ë£Œ: ${adjStr}</span>`;
                }
            }
        }
        return `<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"ì¶œê·¼":"í‡´ê·¼"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name||"")}</td><td>${timeDisplay}</td><td>${makeNoteTag(l.note)}</td><td><button class="btn small" onclick="window.editLog(${l.id})">ìˆ˜ì •</button></td></tr>`;
    }).join("")||`<tr><td colspan="6" class="muted">ê¸°ë¡ ì—†ìŒ</td></tr>`;
    
    const ons=getOutNotes().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("outNoteTable").innerHTML=ons.map((x,i)=>`<tr><td>${ons.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml(x.text)}</td></tr>`).join("");
    const cls=getCloseCheckLogs().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("closeCheckTable").innerHTML=cls.map((x,i)=>`<tr><td>${cls.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml((x.items||[]).join("/"))}</td></tr>`).join("");
    renderCalendar();
  }

  window.editLog=async(id)=>{ if(!await ensureAdmin("ìˆ˜ì •"))return; const l=getLogs().find(x=>x.id===id); if(!l)return; document.getElementById("logEditCode").value=l.code; document.getElementById("logEditName").value=l.name||""; document.getElementById("logEditType").value=l.type; const d=new Date(l.ts); document.getElementById("logEditTs").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}T${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; document.getElementById("logEditNote").value=l.note||""; document.getElementById("logEditSave").onclick=()=>{ const ts=new Date(document.getElementById("logEditTs").value).getTime(); if(!ts)return toast("ì‹œê°„ í™•ì¸"); const logs=getLogs(), idx=logs.findIndex(x=>x.id===id); if(idx>=0){ logs[idx]={...logs[idx], type:document.getElementById("logEditType").value, ts, note:document.getElementById("logEditNote").value}; setLogs(logs); } document.getElementById("logEditOverlay").classList.remove("show"); toast("ìˆ˜ì •ë¨"); renderLogAll(); renderAttendancePanel(); }; document.getElementById("logEditDelete").onclick=()=>{ if(confirm("ì‚­ì œ?")){ setLogs(getLogs().filter(x=>x.id!==id)); document.getElementById("logEditOverlay").classList.remove("show"); toast("ì‚­ì œë¨"); renderLogAll(); renderAttendancePanel(); } }; document.getElementById("logEditOverlay").classList.add("show"); };
  document.getElementById("logEditCancel").addEventListener("click",()=>document.getElementById("logEditOverlay").classList.remove("show"));

  document.getElementById("btnAddShift").addEventListener("click",async()=>{ if(!await ensureAdmin("ì¶”ê°€"))return; const emps=getEmployees(); if(!emps.length)return toast("ì•Œë°”ìƒ ì—†ìŒ"); document.getElementById("logAddEmp").innerHTML=emps.map(e=>`<option value="${e.code}">${e.code} ${e.name}</option>`).join(""); const t=new Date(); document.getElementById("logAddDate").value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`; document.getElementById("logAddOverlay").classList.add("show"); });
  document.getElementById("logAddSave").addEventListener("click",()=>{ const c=document.getElementById("logAddEmp").value, e=findEmpByCode(c), dt=document.getElementById("logAddDate").value, md=document.getElementById("logAddMode").value, inT=document.getElementById("logAddInTime").value, outT=document.getElementById("logAddOutTime").value, mkTs=(t)=>new Date(`${dt}T${t}`).getTime(); if(md==="SHIFT"){ addLog({code:c,name:e.name,type:"IN",note:"ìˆ˜ë™ì¶”ê°€"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); addLog({code:c,name:e.name,type:"OUT",note:"ìˆ˜ë™ì¶”ê°€"}); const l2=getLogs(); l2[l2.length-1].ts=mkTs(outT); setLogs(l2); } else if(md==="IN"){ addLog({code:c,name:e.name,type:"IN",note:"ìˆ˜ë™ì¶”ê°€"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); } else{ addLog({code:c,name:e.name,type:"OUT",note:"ìˆ˜ë™ì¶”ê°€"}); const l=getLogs(); l[l.length-1].ts=mkTs(outT); setLogs(l); } document.getElementById("logAddOverlay").classList.remove("show"); toast("ì¶”ê°€ë¨"); renderLogAll(); renderAttendancePanel(); });
  document.getElementById("logAddCancel").addEventListener("click",()=>document.getElementById("logAddOverlay").classList.remove("show"));

  function downloadFile(fn,txt,mime){ const b=new Blob([txt],{type:mime}), a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=fn; document.body.appendChild(a); a.click(); a.remove(); }
  function exportCsv(){ const f=document.getElementById("logFilterEmp").value, l=getLogs().filter(x=>!f||x.code===f); const csv="id,type,code,name,ts,time,note\n"+l.map(x=>`${x.id},${x.type},${x.code},"${x.name}",${x.ts},"${fmtTS(x.ts)}","${(x.note||"").replace(/"/g,'""')}"`).join("\n"); downloadFile(`ê·¼íƒœ_${todayKey()}.csv`,csv,"text/csv;charset=utf-8"); }
  document.getElementById("btnExportCsv").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  document.getElementById("btnExportCsv2").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  
  // ë°±ì—…/ë³µì› ì´ë²¤íŠ¸ ì œê±°ë¨

  document.getElementById("btnResetAll").addEventListener("click",async()=>{ if(await ensureAdmin() && confirm("ì „ì²´ ì´ˆê¸°í™”?? (ë³µêµ¬ë¶ˆê°€)")){ localStorage.clear(); await set(ref(db, 'tamnaData'), null); location.reload(); } });

  function renderAdminCloseChecklist(){ const lst=document.getElementById("adminCloseChecklistList"), items=getCloseChecklist(); lst.innerHTML=items.map((t,i)=>`<div class="admCLRow"><div class="idx">${i+1}</div><input class="admCLInput" value="${escapeHtml(t)}" /><button class="btn small" onclick="delCLItem(${i})">ì‚­ì œ</button></div>`).join(""); }
  window.delCLItem=async(i)=>{ const l=getCloseChecklist(); l.splice(i,1); setCloseChecklist(l); renderAdminCloseChecklist(); };
  document.getElementById("btnAddCloseChecklistItem").addEventListener("click",()=>{ const v=document.getElementById("adminCloseNewItem").value.trim(); if(!v)return; const l=getCloseChecklist(); l.push(v); setCloseChecklist(l); document.getElementById("adminCloseNewItem").value=""; renderAdminCloseChecklist(); });
  document.getElementById("btnSaveCloseChecklist").addEventListener("click",()=>{ const l=Array.from(document.querySelectorAll(".admCLInput")).map(i=>i.value.trim()).filter(Boolean); setCloseChecklist(l); toast("ì €ì¥ë¨"); renderAdminCloseChecklist(); });
  document.getElementById("btnResetCloseChecklist").addEventListener("click",()=>{ localStorage.removeItem(LS_KEYS.CLOSE_CHECKLIST); renderAdminCloseChecklist(); });

  // ----- íˆ¬ë‘ë©”ì´íŠ¸ (ë£¨í‹´ & ìº˜ë¦°ë”) ë¡œì§ ì¶”ê°€ -----
  let mateYear = new Date().getFullYear();
  let mateMonth = new Date().getMonth() + 1;
  let selectedDate = getToday();

  // ë£¨í‹´ ë°ì´í„° êµ¬ì¡°: [{id, text, type:'daily'|'weekly'|'monthly', days:[1,3], date:5}]
  // ìˆ˜í–‰ ê¸°ë¡ êµ¬ì¡°: {'2024-01-26': { routineId1: true, routineId2: false }}
  
  function renderMateCalendar() {
    const title = document.getElementById('mateMonthTitle');
    title.textContent = `${mateYear}. ${pad4(mateMonth).slice(-2)}`;
    
    const grid = document.getElementById('mateCalendar');
    grid.innerHTML = '<div class="mate-day-head">ì¼</div><div class="mate-day-head">ì›”</div><div class="mate-day-head">í™”</div><div class="mate-day-head">ìˆ˜</div><div class="mate-day-head">ëª©</div><div class="mate-day-head">ê¸ˆ</div><div class="mate-day-head">í† </div>';

    const firstDay = new Date(mateYear, mateMonth-1, 1).getDay();
    const lastDate = new Date(mateYear, mateMonth, 0).getDate();
    
    // ë¹ˆì¹¸
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
    
    // ë‚ ì§œ
    const routines = loadJSON('ROUTINES', []);
    const history = loadJSON('ROUTINE_HISTORY', {});

    for(let d=1; d<=lastDate; d++) {
        const dateKey = `${mateYear}-${pad4(mateMonth).slice(-2)}-${pad4(d).slice(-2)}`;
        const dayOfWeek = new Date(mateYear, mateMonth-1, d).getDay();
        
        // ì´ ë‚ ì§œì— í•´ì•¼ í•  ë£¨í‹´ ê°œìˆ˜ ê³„ì‚°
        let todoCount = 0;
        let doneCount = 0;
        
        routines.forEach(r => {
            if(isRoutineForDate(r, dateKey, dayOfWeek)) {
                todoCount++;
                if(history[dateKey] && history[dateKey][r.id]) doneCount++;
            }
        });
        
        // ì™„ë£Œ ì  í‘œì‹œ (ìµœëŒ€ 4ê°œ)
        let dotsHtml = '';
        if(todoCount > 0) {
            for(let k=0; k<doneCount && k<4; k++) dotsHtml += `<div class="mate-dot done"></div>`;
            for(let k=0; k<(todoCount-doneCount) && (k+doneCount)<4; k++) dotsHtml += `<div class="mate-dot"></div>`;
        }

        const isToday = (dateKey === getToday());
        const isSel = (dateKey === selectedDate);
        
        const cell = document.createElement('div');
        cell.className = `mate-cell ${isToday?'today':''} ${isSel?'selected':''}`;
        cell.onclick = () => { selectedDate = dateKey; renderMateCalendar(); renderMateList(); };
        cell.innerHTML = `<span class="mate-date-num">${d}</span><div class="mate-dots">${dotsHtml}</div>`;
        grid.appendChild(cell);
    }
  }

  function renderMateList() {
    const listArea = document.getElementById('mateListArea');
    document.getElementById('mateSelectedDate').textContent = `${selectedDate} í•  ì¼`;
    
    const routines = loadJSON('ROUTINES', []);
    const history = loadJSON('ROUTINE_HISTORY', {});
    const dayHistory = history[selectedDate] || {};
    
    const dayOfWeek = new Date(selectedDate).getDay();
    // í•´ë‹¹ ë‚ ì§œì— ë§ëŠ” ë£¨í‹´ í•„í„°ë§
    const todaysTasks = routines.filter(r => isRoutineForDate(r, selectedDate, dayOfWeek));

    if(todaysTasks.length === 0) {
        listArea.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    listArea.innerHTML = todaysTasks.map(t => {
        const isDone = !!dayHistory[t.id];
        return `
        <div class="mate-item ${isDone?'done':''}">
            <div class="mate-check ${isDone?'checked':''}" onclick="window.toggleTask('${t.id}')">âœ”</div>
            <div class="mate-text">${t.text} <span class="mate-tag">${getRoutineLabel(t)}</span></div>
            ${t.type==='onetime' ? `<button class="btn small bad" onclick="window.delRoutine('${t.id}')">ì‚­ì œ</button>` : ''}
        </div>`;
    }).join("");
  }

  function isRoutineForDate(r, dateKey, dayOfWeek) {
    if(r.type === 'daily') return true;
    if(r.type === 'weekly') return r.days.includes(dayOfWeek);
    if(r.type === 'monthly') return r.date === parseInt(dateKey.split('-')[2]);
    if(r.type === 'onetime') return r.targetDate === dateKey;
    return false;
  }
  
  function getRoutineLabel(r) {
    if(r.type==='daily') return 'ë§¤ì¼';
    if(r.type==='weekly') return 'ë§¤ì£¼';
    if(r.type==='monthly') return 'ë§¤ì›”';
    return '1íšŒì„±';
  }

  window.toggleTask = (rid) => {
    const history = loadJSON('ROUTINE_HISTORY', {});
    if(!history[selectedDate]) history[selectedDate] = {};
    history[selectedDate][rid] = !history[selectedDate][rid];
    saveJSON('ROUTINE_HISTORY', history).then(() => {
        renderMateCalendar();
        renderMateList();
        recordAction("í• ì¼ ì²´í¬", rid); // ë¡œê·¸ ì¶”ê°€ë¨
    });
  };

  let curRoutineType = 'daily';
  let curWeekDays = [];

  document.querySelectorAll('.routine-btn').forEach(b => {
    b.addEventListener('click', () => {
        document.querySelectorAll('.routine-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        curRoutineType = b.dataset.type;
        document.getElementById('weekSelector').style.display = (curRoutineType === 'weekly') ? 'flex' : 'none';
        document.getElementById('monthSelector').style.display = (curRoutineType === 'monthly') ? 'block' : 'none';
    });
  });

  document.querySelectorAll('.day-btn').forEach(b => {
    b.addEventListener('click', () => {
        const d = parseInt(b.dataset.d);
        if(curWeekDays.includes(d)) {
            curWeekDays = curWeekDays.filter(x => x!==d);
            b.classList.remove('active');
        } else {
            curWeekDays.push(d);
            b.classList.add('active');
        }
    });
  });

  document.getElementById('btnSaveRoutine').addEventListener('click', () => {
    const txt = document.getElementById('routineInput').value.trim();
    if(!txt) return toast("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

    const newRoutine = {
        id: 'r_' + Date.now(),
        text: txt,
        type: curRoutineType,
        days: curWeekDays,
        date: parseInt(document.getElementById('routineMonthDay').value) || 1,
        created: Date.now()
    };

    const list = loadJSON('ROUTINES', []);
    list.push(newRoutine);
    saveJSON('ROUTINES', list);
    
    document.getElementById('routineInput').value = '';
    toast("ë£¨í‹´ ì¶”ê°€ë¨");
    renderRoutineList(); 
    renderMateCalendar(); 
    renderMateList();
    recordAction("ë£¨í‹´ ì¶”ê°€", txt); // ë¡œê·¸ ì¶”ê°€ë¨
  });

  function renderRoutineList() {
    const list = loadJSON('ROUTINES', []);
    document.getElementById('routineListBody').innerHTML = list.map(r => `
        <div style="display:flex; justify-content:space-between; padding:6px; border-bottom:1px solid #eee;">
            <span>${r.text} <small>(${getRoutineLabel(r)})</small></span>
            <button onclick="window.delRoutine('${r.id}')" style="font-size:11px; color:red; border:none; background:none;">ì‚­ì œ</button>
        </div>
    `).join("");
  }
  
  window.delRoutine = (rid) => {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const list = loadJSON('ROUTINES', []).filter(r => r.id !== rid);
    saveJSON('ROUTINES', list);
    renderRoutineList();
    renderMateCalendar();
    renderMateList();
    recordAction("ë£¨í‹´ ì‚­ì œ", rid); // ë¡œê·¸ ì¶”ê°€ë¨
  };

  document.getElementById('matePrevMonth').onclick = () => {
      mateMonth--; if(mateMonth<1){mateMonth=12; mateYear--;}
      renderMateCalendar();
  };
  document.getElementById('mateNextMonth').onclick = () => {
      mateMonth++; if(mateMonth>12){mateMonth=1; mateYear++;}
      renderMateCalendar();
  };

  document.getElementById('btnAddOneTimeTask').onclick = () => {
    const txt = prompt("ì˜¤ëŠ˜ë§Œ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if(txt) {
        const list = loadJSON('ROUTINES', []);
        list.push({
            id: 'ot_' + Date.now(),
            text: txt,
            type: 'onetime',
            targetDate: selectedDate
        });
        saveJSON('ROUTINES', list);
        renderMateList();
        renderMateCalendar();
        recordAction("1íšŒì„± í• ì¼", txt); // ë¡œê·¸ ì¶”ê°€ë¨
    }
  };

  // ----- UI ì´ë²¤íŠ¸ ì—°ê²° -----
  document.getElementById('btnOpenMate').onclick = () => {
      document.getElementById('mateOverlay').classList.add('show');
      renderMateCalendar();
      renderMateList();
      recordAction('íˆ¬ë‘ ê´€ë¦¬', 'ì—´ê¸°');
  };
  document.getElementById('btnOpenRoutineSet').onclick = () => {
      document.getElementById('routineSetOverlay').classList.add('show');
      renderRoutineList();
  };
  
  document.getElementById('btnShowActionLogs').onclick = () => {
      const logs = loadJSON('ACTION_LOGS', []);
      document.getElementById('actionLogTable').innerHTML = logs.slice().reverse().map(l => 
        `<tr><td>${l.time}</td><td>${l.action}</td><td>${l.detail}</td></tr>`
      ).join("") || '<tr><td colspan="3" style="text-align:center;">ê¸°ë¡ ì—†ìŒ</td></tr>';
      document.getElementById('actionLogOverlay').classList.add('show');
  };
  document.getElementById('btnCloseActionLog').addEventListener("click", () => {
    document.getElementById("actionLogOverlay").classList.remove("show");
  });

  (async()=>{ renderAttendancePanel(); updateAdminStateText(); })();
</script>
</body>
</html>
