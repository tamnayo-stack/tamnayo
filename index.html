<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  
  <title>탐나는피자 화성남양점</title>
  
  <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/lang/ko.js"></script>

  <style>
    :root{
      --bg: #f4f6f9; --panel: #ffffff; --panel2: #f8f9fa;
      --text: #2c3e50; --muted: #8395a7; --line: #dcdde1;
      --accent: #3498db; --good: #27ae60; --bad: #e74c3c; --warn: #f39c12;
      --shadow: 0 8px 20px rgba(0,0,0,0.08); --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{ 
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
      background: var(--bg); 
      color:var(--text); 
      min-height:100dvh;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none; touch-action: manipulation;
    }
    /* 입력창과 에디터 내부는 선택 가능하게 */
    input, textarea, .se-wrapper-inner, .sun-editor-editable { 
      -webkit-user-select: text !important; 
      user-select: text !important; 
    }

    header{ padding: 14px 18px 10px; position: sticky; top:0; background: rgba(255,255,255,.90); backdrop-filter: blur(10px); border-bottom: 1px solid var(--line); z-index:10; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1100px; margin:0 auto; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logoWrap{ display:flex; flex-direction:column; gap:4px; }
    .logo{ height: 34px; width: auto; display:block; object-fit: contain; cursor: pointer; }
    .right{ display:flex; align-items:flex-end; gap:12px; font-variant-numeric: tabular-nums; }
    .clockBlock{ text-align:right; }
    .clockBlock .time{ font-size:16px; font-weight:800; color: #2c3e50; }
    .clockBlock .date{ font-size:12px; color:var(--muted); margin-top:2px; }

    main{ max-width:1100px; margin:0 auto; padding: 14px 18px 30px; display:grid; gap:14px; }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .logo{ height: 30px; } }

    .card{ background: var(--panel); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }
    .card h2{ margin:0 0 10px; font-size: 16px; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1 1 auto !important; }

    label{ font-size: 13px; color:var(--muted); display:block; margin: 4px 0 6px; }
    input, select{ width:100%; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 16px; outline:none; }
    input::placeholder{ color: #b2bec3; }
    input:focus, select:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }
    textarea{ width:100%; min-height: 120px; resize: vertical; background: #fff; border: 1px solid #ced6e0; color: var(--text); border-radius: 12px; padding: 12px 12px; font-size: 15px; outline:none; }
    textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }

    .btn{ border:1px solid var(--line); background: #f1f2f6; color: var(--text); padding: 12px 14px; border-radius: 14px; font-size: 15px; font-weight: 800; cursor:pointer; user-select:none; transition: transform .05s ease; }
    .btn:active{ transform: scale(.98); }
    .btn.primary{ border-color: transparent; background: var(--accent); color: #fff; }
    .btn.good{ border-color: transparent; background: var(--good); color: #fff; }
    .btn.bad{ border-color: transparent; background: var(--bad); color: #fff; }
    .btn.warn{ border-color: transparent; background: var(--warn); color: #fff; }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 13px; font-weight: 900; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .split{ grid-template-columns: 1fr; } }
    .big-actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .big-actions .btn{ padding: 18px 14px; font-size: 18px; border-radius: 16px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border: 1px solid var(--line); border-radius: 999px; background: #f8f9fa; font-size: 13px; color: var(--muted); font-variant-numeric: tabular-nums; }
    .pill strong{ color:var(--text); }

    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius: 14px; border: 1px solid var(--line); background: #fff; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid var(--line); text-align:left; font-size: 14px; vertical-align: middle; }
    th{ color: var(--muted); font-weight: 900; background: #f1f2f6; }
    tr:last-child td{ border-bottom: none; }

    .tag{ display:inline-flex; align-items:center; justify-content:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 900; border: 1px solid var(--line); font-variant-numeric: tabular-nums; white-space: nowrap; }
    .tag.in{ border-color: transparent; color: #fff; background: var(--good); }
    .tag.out{ border-color: transparent; color: #fff; background: var(--bad); }
    .tag.open{ border-color: transparent; color: #fff; background: var(--warn); }
    .tag.juhyu { border-color: transparent; color: #d35400; background: rgba(230, 126, 34, 0.15); margin-top: 2px; width: 100%; }
    .tag.adj { border-color: var(--accent); color: var(--accent); background: rgba(52,152,219,0.1); margin-left:6px; font-size:11px; }

    .section{ display:none; }
    .section.active{ display:block; }

    .note{ margin-top:10px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: #2f3640; border: 1px solid #2f3640; border-radius: 14px; padding: 14px 18px; box-shadow: var(--shadow); font-size: 16px; color: #fff; display:none; z-index: 5000; max-width: 92vw; white-space: normal; overflow: hidden; text-overflow: clip; }
    .toast.show{ display:block; }
    .toast.danger{ background: var(--bad); border-color: var(--bad); color: #fff; }

    .modalOverlay{ position: fixed; inset:0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index: 1000; padding: 18px; backdrop-filter: blur(2px); }
    .modalOverlay.show{ display:flex; }
    .modal{ width: min(560px, 100%); border-radius: 18px; border: 1px solid var(--line); background: #fff; box-shadow: var(--shadow); padding: 14px; }
    .modal h3{ margin:0 0 6px; font-size: 16px; letter-spacing:.2px; }
    .modalActions{ display:flex; gap:10px; margin-top: 12px; justify-content:flex-end; flex-wrap:wrap; }
    .menuGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 12px; }
    @media (max-width: 520px){ .menuGrid{ grid-template-columns: 1fr; } }

    .countWrap{ display:flex; align-items:center; gap:14px; margin-top:12px; }
    .ring{ width:62px; height:62px; position:relative; flex:0 0 auto; }
    .ring svg{ width:62px; height:62px; display:block; }
    .ring .num{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:18px; }
    .ring .bg{ stroke: #f1f2f6; stroke-width: 8; fill: none; }
    .ring .fg{ stroke: var(--accent); stroke-width: 8; fill: none; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.15s linear; }
    .btn.cat-active{ border-color: transparent; background: var(--warn); color:#fff; }
    td.nameCell, th.nameCell { white-space: nowrap; word-break: keep-all; }
    
    .checkList{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .checkItem{ display:flex; align-items:flex-start; gap:10px; padding: 10px 10px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .checkItem input{ width:auto; margin-top:3px; }
    .checkItem .t{ font-weight: 900; font-size: 14px; }
    .admCLRow{ display:flex; gap:8px; align-items:center; padding: 8px; border: 1px solid var(--line); border-radius: 14px; background: #f8f9fa; }
    .admCLRow input{ flex: 1 1 auto; }
    .admCLRow .idx{ width: 28px; text-align:center; color: var(--muted); font-weight: 900; font-variant-numeric: tabular-nums; }
    
    /* SunEditor 높이 및 스타일 보정 */
    .sun-editor { border-radius: 12px; overflow: hidden; border: 1px solid #ced6e0 !important; font-family: sans-serif !important; }
    .se-container { z-index: 9999 !important; }

    #adminMenuOverlay .modal{ padding-bottom: 18px; max-height: 88vh; overflow-y: auto; overscroll-behavior: contain; }
    #adminMenuOverlay .modal::-webkit-scrollbar{ width: 10px; }
    #adminMenuOverlay .modal::-webkit-scrollbar-thumb{ background: #bdc3c7; border-radius: 999px; border: 3px solid rgba(0,0,0,0); background-clip: padding-box; }
    #adminMenuOverlay .modal::-webkit-scrollbar-track{ background: transparent; border-radius: 999px; }
    #logEditOverlay .modal, #empEditOverlay .modal{ max-width: 640px; }
    #sec-emp .grid{ grid-template-columns: 1fr !important; }
    #sec-emp .card{ border-radius: 22px; }
    #sec-emp h2{ font-size: 22px; }
    #sec-emp table{ min-width: 860px; }

    .calHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .calGrid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .calCellHeader{ text-align:center; font-weight:900; color:var(--muted); font-size:13px; padding-bottom:6px; }
    .calDay{ min-height: 80px; background: #fff; border: 1px solid var(--line); border-radius: 12px; padding: 6px 8px; display:flex; flex-direction:column; gap:4px; position:relative; }
    .calDay.empty{ background:none !important; border:none; }
    .calDay.today{ border-color: var(--accent); background: rgba(52,152,219,.05) !important; }
    .calNum{ font-size:14px; font-weight:800; color:var(--muted); }
    .calData{ margin-top: auto; text-align:right; }
    .calTime{ font-size: 13px; font-weight: 800; color: var(--text); display:block; }
    .calPay{ font-size: 11px; color: var(--good); font-weight: 700; display:block; margin-top:2px; }
    .calDay:hover{ background: #f8f9fa !important; }

    .totalWageBox { background: var(--panel2); border: 2px solid var(--accent); border-radius: 14px; padding: 16px; text-align:center; margin-bottom: 14px; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .totalWageLabel { color: var(--muted); font-size: 13px; font-weight: 800; }
    .totalWageValue { color: var(--text); font-size: 20px; font-weight: 900; }
    .totalWageDetail { color: var(--good); font-size: 13px; font-weight: 700; }
    
    #syncStatus { position:fixed; top:5px; left:50%; transform:translateX(-50%); font-size:10px; color:white; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; z-index:9999; }
    
    #quickButtons { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    #quickButtons .btn { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 16px; }
    #quickButtons .btn .muted { font-size: 12px; font-weight: normal; }
  </style>
</head>

<body>
<div id="syncStatus">서버 연결 중...</div>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap"><img id="logoImg" class="logo" alt="가게 로고" src="tamnayo.png" /></div>
    </div>
    <div class="right">
      <div class="clockBlock"><div class="time" id="nowTime">--:--:--</div><div class="date" id="nowDate">----</div></div>
    </div>
  </div>
</header>

<main>
  <section class="section active" id="sec-att">
    <div class="grid">
      <div class="card">
        <h2>출근 / 퇴근 찍기</h2>
        <div class="split">
          <div><label>알바 코드 (자동 입력)</label><input id="attCode" inputmode="numeric" autocomplete="off" placeholder="버튼을 누르세요" maxlength="4" readonly /></div>
          <div><label>이름 (자동 표시)</label><input id="attName" disabled placeholder="-" /></div>
        </div>
        <div class="big-actions"><button class="btn good" id="btnIn">출근</button><button class="btn bad" id="btnOut">퇴근</button></div>
        <div class="row" style="margin-top:10px;">
          <span class="pill">상태: <strong id="attStatus">-</strong></span>
          <span class="pill">마지막 기록: <strong id="attLast">-</strong></span>
          <span class="spacer"></span>
          <button class="btn small" id="btnClearCode">지우기</button>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:12px;">
          <div style="flex:1 1 100%;">
            <div class="muted" style="font-size:13px; font-weight:900;">빠른 선택 (알바생 버튼)</div>
            <div id="quickButtons" style="margin-top:8px;"></div>
            <div class="note">
              • 알바생 버튼을 누르면 코드가 자동 입력됩니다.<br/>
              • 출퇴근 누락 시 <b>사장님께 말씀해주세요.</b>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>최근 기록 (최신 15개)</h2>
        <div style="overflow:auto; max-height: 520px;">
          <table>
            <thead><tr><th style="width:90px;">유형</th><th style="width:90px;">코드</th><th class="nameCell">이름</th><th style="width:200px;">시간</th></tr></thead>
            <tbody id="recentTable"></tbody>
          </table>
        </div>
        <div class="note">최근 기록은 누락 방지를 위한 참고용입니다.</div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-emp">
    <div class="card">
      <div class="row"><h2 style="margin:0;">알바생 관리 (관리자)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromEmp">← 출근/퇴근</button></div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card" style="box-shadow:none;">
          <h2>알바생 등록</h2>
          <div class="split">
            <div><label>이름</label><input id="empName" placeholder="예) 홍길동" maxlength="30" /></div>
            <div><label>메모 (선택)</label><input id="empMemo" placeholder="예) 주말만" maxlength="60" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>근무 구분</label><select id="empShiftType"><option value="MID">미들</option><option value="CLOSE">마감</option></select></div>
            <div><label>평일 시급</label><input id="empWage" type="number" placeholder="예) 10030" inputmode="numeric" /></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label style="color:var(--warn)">주말 시급 (토,일)</label><input id="empWageWeekend" type="number" placeholder="선택 (비워두면 평일동일)" inputmode="numeric" /></div>
            <div></div>
          </div>
          <div class="split" style="margin-top:10px;">
            <div><label>근무 시작 시간</label><input id="empWorkStart" type="time" value="17:00" /></div>
            <div><label>근무 종료 시간</label><input id="empWorkEnd" type="time" value="23:30" /></div>
          </div>
          <div class="row" style="margin-top:10px;"><button class="btn primary" id="btnAddEmp">등록</button><span class="muted" id="nextCodeHint"></span></div>
        </div>
        <div class="card" style="box-shadow:none;">
          <h2>알바생 조회 / 삭제</h2>
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1 1 260px;"><label>검색</label><input id="empSearch" placeholder="예) 0002 또는 길동" /></div>
            <div class="spacer"></div><button class="btn small" id="btnRefreshEmp">새로고침</button>
          </div>
          <div style="overflow:auto; max-height: 520px;">
            <table>
              <thead><tr><th style="width:90px;">코드</th><th class="nameCell" style="width:160px;">이름</th><th style="width:90px;">구분</th><th>시급(평/주)</th><th>근무시간</th><th style="width:110px;">삭제</th></tr></thead>
              <tbody id="empTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="sec-log">
    <div class="card">
      <div class="row"><h2 style="margin:0;">근태 조회 (관리자)</h2><div class="spacer"></div><button class="btn small" id="btnBackFromLog">← 출근/퇴근</button></div>
      <div class="hr"></div>
      <div class="row" style="margin-bottom:10px; gap:10px; flex-wrap:wrap;">
        <span class="pill">전체 기록: <strong id="logTotal">0</strong>건</span>
        <label class="muted" style="display:flex; align-items:center; gap:8px;">알바생 필터<select id="logFilterEmp" style="min-width:180px;"></select></label>
        <div class="spacer"></div>
        <button class="btn small" id="btnAddShift">근무 추가</button>
        <button class="btn small warn" id="btnExportCsv">CSV 내보내기</button>
      </div>
      <div class="hr"></div>
      
      <div class="totalWageBox">
        <div class="totalWageLabel" id="totalWageTitle">--월 예상 급여</div>
        <div class="totalWageValue" id="totalWageAmount">0원</div>
        <div class="totalWageDetail" id="totalWageDetail">(기본 0 + 주휴 0)</div>
      </div>

      <div class="calHeader">
        <button class="btn small" id="calPrevBtn">◀ 이전달</button>
        <h3 id="calTitle" style="margin:0; font-size:18px;">202X. XX</h3>
        <button class="btn small" id="calNextBtn">다음달 ▶</button>
      </div>
      <div class="calGrid" id="calendarView"></div>
      
      <div class="note" style="margin:14px 0;">• 일요일에 해당 주의 주휴수당(15시간↑)이 표시됩니다.</div>
      
      <div style="overflow:auto; max-height: 540px;">
        <table>
          <thead><tr><th style="width:110px;">유형</th><th style="width:90px;">코드</th><th class="nameCell" style="width:160px;">이름</th><th style="width:220px;">시간</th><th>비고</th><th style="width:90px;">수정</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">퇴근 특이사항 (체크리스트 제외)</div>
      <div style="overflow:auto; max-height: 360px;">
        <table>
          <thead><tr><th style="width:70px;">순번</th><th style="width:110px;">날짜</th><th style="width:90px;">코드</th><th style="width:140px;">작성자</th><th style="width:180px;">시간</th><th>내용</th></tr></thead>
          <tbody id="outNoteTable"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px; font-weight:900; margin-bottom:8px;">마감 체크리스트 기록</div>
      <div style="overflow:auto; max-height: 280px;">
        <table>
          <thead><tr><th style="width:70px;">순번</th><th style="width:110px;">날짜</th><th style="width:90px;">코드</th><th style="width:140px;">작성자</th><th style="width:180px;">시간</th><th>체크</th></tr></thead>
          <tbody id="closeCheckTable"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<div class="modalOverlay" id="noticeOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>오늘의 공지</h3>
    <div class="muted" id="noticeDateText">-</div>
    <div class="hr"></div>
    <div id="noticeText" style="white-space:pre-wrap; line-height:1.45;"></div>
    <div class="countWrap">
      <div class="ring"><svg viewBox="0 0 80 80"><circle class="bg" cx="40" cy="40" r="30"></circle><circle class="fg" id="noticeRing" cx="40" cy="40" r="30"></circle></svg><div class="num" id="noticeNum">5</div></div>
    </div>
    <div class="modalActions"><button class="btn primary" id="noticeOk" disabled>숙지하였습니다</button></div>
  </div>
</div>

<div class="modalOverlay" id="outNoteOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>오늘의 특이사항 (선택)</h3>
    <div class="muted" id="outNoteDesc">퇴근 저장 전에 특이사항을 남길 수 있어요.</div>
    <div class="hr"></div>
    <label>특이사항</label>
    <div class="row" style="gap:8px; margin:8px 0 10px;">
      <button class="btn small" type="button" data-cat="누락">누락</button>
      <button class="btn small" type="button" data-cat="환불">환불</button>
      <button class="btn small" type="button" data-cat="물품">물품</button>
      <button class="btn small" type="button" data-cat="기타">기타</button>
    </div>
    <textarea id="outNoteText" placeholder="예)&#10;[환불] 18:20 음료 누락 환불&#10;[재고] 고무장갑 없음&#10;[기타] 17:55 현금결제 or 건의사항&#10;&#10;근무 중 발생한 특이사항을 적어주세요.&#10;특이사항이 없다면 건너뛰기!"></textarea>
    <div class="modalActions">
      <button class="btn" id="outNoteSkip">건너뛰기</button>
      <button class="btn primary" id="outNoteSave">저장 후 퇴근</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="empEditOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>알바생 정보 수정</h3>
    <div class="muted">이름/구분/근무시간/시급/메모를 수정할 수 있습니다.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>코드</label><input id="empEditCode" readonly /></div>
      <div><label>이름</label><input id="empEditName" placeholder="예) 홍길동" maxlength="20" /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div>
        <label>근무 구분</label>
        <select id="empEditShiftType"><option value="MID">미들</option><option value="CLOSE">마감</option></select>
      </div>
      <div>
        <label>평일 시급</label>
        <input id="empEditWage" type="number" placeholder="숫자만 입력" />
      </div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label style="color:var(--warn)">주말 시급 (토,일)</label><input id="empEditWageWeekend" type="number" placeholder="선택" /></div>
      <div></div>
    </div>
    <label>메모</label>
    <input id="empEditMemo" placeholder="메모(선택)" maxlength="30" />
    <div class="split" style="margin-top:10px;">
      <div><label>근무 시작</label><input id="empEditWorkStart" type="time" /></div>
      <div><label>근무 종료</label><input id="empEditWorkEnd" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="empEditCancel">취소</button>
      <button class="btn primary" id="empEditSave">저장</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logAddOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>근무 추가</h3>
    <div class="muted">누락된 근무를 수동으로 추가합니다. (관리자)</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>알바생</label><select id="logAddEmp"></select></div>
      <div>
        <label>추가 유형</label>
        <select id="logAddMode"><option value="SHIFT">출근+퇴근</option><option value="IN">출근만</option><option value="OUT">퇴근만</option></select>
      </div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>날짜</label><input id="logAddDate" type="date" /></div>
      <div><label>비고</label><input id="logAddNote" placeholder="예) 누락 보정" maxlength="60" /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>출근 시간</label><input id="logAddInTime" type="time" /></div>
      <div><label>퇴근 시간</label><input id="logAddOutTime" type="time" /></div>
    </div>
    <div class="modalActions">
      <button class="btn" id="logAddCancel">취소</button>
      <button class="btn primary" id="logAddSave">추가</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="logEditOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>근무 기록 수정</h3>
    <div class="muted">시간/유형/비고를 수정하거나 삭제할 수 있습니다.</div>
    <div class="hr"></div>
    <div class="split" style="margin-top:10px;">
      <div><label>코드</label><input id="logEditCode" readonly /></div>
      <div><label>이름</label><input id="logEditName" readonly /></div>
    </div>
    <div class="split" style="margin-top:10px;">
      <div><label>유형</label><select id="logEditType"><option value="IN">출근</option><option value="OUT">퇴근</option></select></div>
      <div><label>시간</label><input id="logEditTs" type="datetime-local" /></div>
    </div>
    <label style="margin-top:10px;">비고</label>
    <textarea id="logEditNote" placeholder="예) 조퇴 / 병원 / 특이사항"></textarea>
    <div class="modalActions">
      <button class="btn" id="logEditCancel">취소</button>
      <button class="btn bad" id="logEditDelete">삭제</button>
      <button class="btn primary" id="logEditSave">저장</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="closeCheckOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>마감 체크리스트</h3>
    <div class="muted">마감 항목을 체크한 뒤 퇴근을 완료하세요.</div>
    <div class="hr"></div>
    <div id="closeCheckList" class="checkList"></div>
    <div class="modalActions" style="margin-top:20px;">
      <button class="btn primary" id="closeCheckDone" disabled>완료 후 퇴근</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="pinOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3 id="pinTitle">관리자 PIN</h3>
    <div class="muted" id="pinDesc">관리자 기능을 사용하려면 PIN을 입력하세요.</div>
    <div class="hr"></div>
    <div id="pinUnlockBlock">
      <label>PIN 입력</label><input id="pinInput" inputmode="numeric" autocomplete="off" placeholder="PIN" maxlength="8" />
      <div class="note">해제 후 <b>10분</b> 동안 관리자 기능이 열립니다.</div>
    </div>
    <div class="modalActions">
      <button class="btn" id="pinCancel">취소</button>
      <button class="btn primary" id="pinOk">확인</button>
    </div>
  </div>
</div>

<div class="modalOverlay" id="adminMenuOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>관리자 메뉴</h3>
    <div class="muted" id="adminStateText">-</div>
    <div class="menuGrid">
      <button class="btn primary" id="goEmp">알바생 관리</button>
      <button class="btn primary" id="goLog">근태 조회</button>
      <button class="btn warn" id="btnExportCsv2">CSV 내보내기</button>
      <button class="btn bad" id="btnResetAll">전체 초기화</button>
      <button class="btn" id="btnLockAdmin">관리자 잠금</button>
    </div>
    <div class="hr"></div><div class="hr"></div>
    <div class="muted" style="font-size:13px; font-weight:900;">마감 체크리스트 편집</div>
    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
      <div style="flex: 2 1 240px;"><label>항목 추가</label><input id="adminCloseNewItem" placeholder="예) 포스 마감 정산" maxlength="60" /></div>
      <div style="flex: 0 0 auto; align-self:flex-end; display:flex; gap:8px;">
        <button class="btn" id="btnAddCloseChecklistItem">추가</button>
        <button class="btn primary" id="btnSaveCloseChecklist">저장</button>
        <button class="btn" id="btnResetCloseChecklist">기본값</button>
      </div>
    </div>
    <div id="adminCloseChecklistList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
    <div class="muted" style="margin-top:10px; font-size:13px; font-weight:900;">오늘의 공지(출근 시 표시)</div>
    <label style="margin-top:8px;">공지 내용</label>
    <textarea id="adminNoticeInput"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="btnSaveTodayNotice">오늘 공지 저장</button>
      <button class="btn" id="btnClearTodayNotice">오늘 공지 비우기</button>
    </div>
    <div class="modalActions"><button class="btn" id="adminMenuClose">닫기</button></div>
  </div>
</div>

<input id="restoreInput" type="file" accept="application/json" style="display:none;" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbdEqVxEOcA3qFEcYEH9yuvNRx_CTMxhE",
    authDomain: "tamna-hr.firebaseapp.com",
    projectId: "tamna-hr",
    storageBucket: "tamna-hr.firebasestorage.app",
    messagingSenderId: "766306504997",
    appId: "1:766306504997:web:3e4e77bc14101cd6660acc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let SERVER_CACHE = {}; 
  
  // SunEditor 초기화 (안전장치 추가)
  let noticeEditor;
  document.addEventListener("DOMContentLoaded", () => {
    try {
      if (typeof SunEditor !== 'undefined') {
        noticeEditor = SunEditor.create('adminNoticeInput', {
            lang: SUNEDITOR_LANG ? SUNEDITOR_LANG['ko'] : null,
            buttonList: [
                ['font', 'fontSize', 'formatBlock'],
                ['bold', 'underline', 'italic', 'strike', 'fontColor', 'hiliteColor'],
                ['removeFormat'],
                ['outdent', 'indent', 'align', 'list', 'lineHeight'],
                ['fullScreen', 'showBlocks', 'codeView']
            ],
            width: '100%',
            height: '250px',
            placeholder: '공지사항을 입력하세요...'
        });
      } else {
        console.error("SunEditor library not loaded.");
      }
    } catch(e) { console.error("Editor init fail", e); }
  });

  onValue(ref(db, 'tamnaData'), (snapshot) => {
    const data = snapshot.val();
    if (data) {
      SERVER_CACHE = data;
      try {
        if(typeof renderAttendancePanel === 'function') renderAttendancePanel();
        if(typeof renderLogAll === 'function') {
          // 데이터 수신 시 필터 옵션과 로그를 모두 갱신
          renderLogFilterOptions();
          renderLogAll();
        }
        if(typeof renderEmployees === 'function') renderEmployees();
        
        let status = document.getElementById('syncStatus');
        if(!status) {
          status = document.createElement('div');
          status.id = 'syncStatus';
          status.style.cssText = "position:fixed; top:5px; right:5px; font-size:10px; color:#fff; z-index:9999; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px;";
          document.body.appendChild(status);
        }
        status.textContent = "● 서버 동기화됨";
      } catch(e) {}
    }
  });

  window.saveJSON = async function(key, val) {
    SERVER_CACHE[key] = val;
    await set(ref(db, 'tamnaData'), SERVER_CACHE);
  };

  window.loadJSON = function(key, fallback) {
    return SERVER_CACHE[key] ? SERVER_CACHE[key] : fallback;
  };

  const LS_KEYS = { DAILY_NOTICE: "ALBA_DAILY_NOTICE_V1", OUT_NOTES: "ALBA_OUT_NOTES_V1", CLOSE_CHECKLIST: "ALBA_CLOSE_CHECKLIST_V1", CLOSE_CHECK_LOGS: "ALBA_CLOSE_CHECK_LOGS_V1", EMPLOYEES: "ALBA_EMPLOYEES_V2", NEXT_ID: "ALBA_NEXT_EMP_ID_V2", ATT_LOGS: "ALBA_ATT_LOGS_V2", PIN_HASH: "ALBA_ADMIN_PIN_HASH_V1", PIN_SALT: "ALBA_ADMIN_PIN_SALT_V1" };
  const SS_KEYS = { UNLOCK_UNTIL: "ALBA_ADMIN_UNLOCK_UNTIL_V1" };

  function pad4(n){ return String(n).length>=4?String(n):("0000"+n).slice(-4); }
  function nowTS(){ return Date.now(); }
  function dateKey(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  function todayKey(){ return dateKey(Date.now()); }
  function fmtTS(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`; }
  function toast(msg,type){ const el=document.getElementById("toast"); el.textContent=msg; el.className="toast show "+(type==="danger"?"danger":""); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"),2200); }
  function escapeHtml(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
  function normalizeCodeInput(v){ return (v||"").replace(/\D/g,"").slice(0,4); }

  (function disableDoubleTapZoom(){ let lastTouchEnd=0; document.addEventListener('touchend',function(e){ const now=Date.now(); if(now-lastTouchEnd<=300)e.preventDefault(); lastTouchEnd=now; },{passive:false}); })();

  function getEmployees(){ return loadJSON(LS_KEYS.EMPLOYEES, []); }
  function setEmployees(list){ saveJSON(LS_KEYS.EMPLOYEES, list); }
  function getNextEmpId(){ const v=loadJSON(LS_KEYS.NEXT_ID, 1); const n=v?Number(v):1; return Number.isFinite(n)&&n>=1?Math.floor(n):1; }
  function setNextEmpId(n){ saveJSON(LS_KEYS.NEXT_ID, String(n)); }
  function getLogs(){ return loadJSON(LS_KEYS.ATT_LOGS, []); }
  function setLogs(list){ saveJSON(LS_KEYS.ATT_LOGS, list); }
  function findEmpByCode(code){ return getEmployees().find(e=>e.code===code)||null; }
  function getNoticeMap(){ return loadJSON(LS_KEYS.DAILY_NOTICE, {}); }
  function setNoticeMap(map){ saveJSON(LS_KEYS.DAILY_NOTICE, map); }
  function getTodayNotice(){ return getNoticeMap()[todayKey()]?.text || ""; }
  function setTodayNotice(text){ const m=getNoticeMap(); m[todayKey()]={text:String(text||""), updatedAt:nowTS()}; setNoticeMap(m); }
  function clearTodayNotice(){ const m=getNoticeMap(); delete m[todayKey()]; setNoticeMap(m); }
  function getOutNotes(){ return loadJSON(LS_KEYS.OUT_NOTES, []); }
  function setOutNotes(list){ saveJSON(LS_KEYS.OUT_NOTES, list); }
  function getCloseChecklist(){ const def=["가스/전기 확인","쓰레기/재활용 정리","냉장고 정리","매장 불/에어컨 OFF","오븐/토핑대/도우롤러 아래 바닥 쓸기"]; const list=loadJSON(LS_KEYS.CLOSE_CHECKLIST, null); return Array.isArray(list)&&list.length?list:def; }
  function setCloseChecklist(list){ saveJSON(LS_KEYS.CLOSE_CHECKLIST, list); }
  function getCloseCheckLogs(){ return loadJSON(LS_KEYS.CLOSE_CHECK_LOGS, []); }
  function setCloseCheckLogs(list){ saveJSON(LS_KEYS.CLOSE_CHECK_LOGS, list); }
  function addCloseCheckLog({code,name,items,extra}){ const list=getCloseCheckLogs(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,items:items||[],extra:String(extra||"").trim()}); setCloseCheckLogs(list); }
  function addOutNote({code,name,text}){ const list=getOutNotes(); const id=list.length?(list[list.length-1].id+1):1; list.push({id,date:dateKey(nowTS()),ts:nowTS(),code,name,text:String(text||"").trim()}); setOutNotes(list); }

  function hasPin(){ return true; } 
  function isAdminUnlocked(){ const u=sessionStorage.getItem(SS_KEYS.UNLOCK_UNTIL); return u && Date.now()<Number(u); }
  function setAdminUnlocked(m=10){ sessionStorage.setItem(SS_KEYS.UNLOCK_UNTIL, String(Date.now()+m*60*1000)); updateAdminStateText(); }
  function lockAdmin(){ sessionStorage.removeItem(SS_KEYS.UNLOCK_UNTIL); updateAdminStateText(); }
  function verifyPin(p){ return p === "0721"; } 

  const pinOverlay=document.getElementById("pinOverlay");
  let pinResolve=null;
  function showPinModal(mode,opts={}){
    document.getElementById("pinTitle").textContent=opts.title||"관리자 PIN";
    document.getElementById("pinDesc").textContent=opts.desc||"";
    document.getElementById("pinInput").value="";
    pinOverlay.classList.add("show"); setTimeout(()=>document.getElementById("pinInput")?.focus(),50);
    return new Promise(r=>{ pinResolve=r; });
  }
  function hidePinModal(res){ pinOverlay.classList.remove("show"); if(pinResolve){ pinResolve(res); pinResolve=null; } }
  document.getElementById("pinCancel").addEventListener("click",()=>hidePinModal({ok:false}));
  
  document.getElementById("pinOk").addEventListener("click",()=>{
    const p=(document.getElementById("pinInput").value||"").replace(/\D/g,"");
    if(verifyPin(p)){ setAdminUnlocked(); toast("해제됨"); hidePinModal({ok:true}); } else toast("PIN 오류 (0721)");
  });

  async function ensureAdmin(r="관리자 기능"){
    if(isAdminUnlocked()) return true;
    const res=await showPinModal("unlock",{desc:`${r}을(를) 위해 PIN 입력`}); return !!res.ok && isAdminUnlocked();
  }

  function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id)?.classList.add("active");
    if(id==="sec-att") renderAttendancePanel();
    if(id==="sec-emp") renderEmployees();
    if(id==="sec-log"){ renderLogFilterOptions(); renderLogAll(); }
  }
  function tickClock(){
    const d=new Date(); document.getElementById("nowTime").textContent=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    document.getElementById("nowDate").textContent=`${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${["일","월","화","수","목","금","토"][d.getDay()]})`;
  }
  setInterval(tickClock,250); tickClock();

  const adminMenuOverlay=document.getElementById("adminMenuOverlay");
  function updateAdminStateText(){
    if(!isAdminUnlocked()){ document.getElementById("adminStateText").textContent="상태: 잠금 (PIN 필요)"; return; }
    const ms=Math.max(0,Number(sessionStorage.getItem(SS_KEYS.UNLOCK_UNTIL)||0)-Date.now());
    document.getElementById("adminStateText").textContent=`상태: 해제됨 (${Math.floor(ms/60000)}m ${String(Math.floor((ms%60000)/1000)).padStart(2,"0")}s)`;
  }
  setInterval(updateAdminStateText,500); updateAdminStateText();
  function openAdminMenu(){
    // 에디터에 기존 공지 내용 로드
    const content = getTodayNotice();
    if(noticeEditor) {
        noticeEditor.setContents(content);
    }
    renderAdminCloseChecklist();
    adminMenuOverlay.classList.add("show"); updateAdminStateText();
  }
  document.getElementById("adminMenuClose").addEventListener("click",()=>adminMenuOverlay.classList.remove("show"));
  document.getElementById("btnLockAdmin").addEventListener("click",()=>{ lockAdmin(); toast("잠금 완료"); adminMenuOverlay.classList.remove("show"); showSection("sec-att"); });
  document.getElementById("goEmp").addEventListener("click",()=>{ if(isAdminUnlocked()){adminMenuOverlay.classList.remove("show"); showSection("sec-emp");}else toast("PIN 필요"); });
  document.getElementById("goLog").addEventListener("click",()=>{ if(isAdminUnlocked()){adminMenuOverlay.classList.remove("show"); showSection("sec-log");}else toast("PIN 필요"); });
  document.getElementById("btnBackFromEmp").addEventListener("click",()=>showSection("sec-att"));
  document.getElementById("btnBackFromLog").addEventListener("click",()=>showSection("sec-att"));
  
  // 공지 저장 (에디터 내용 가져오기)
  document.getElementById("btnSaveTodayNotice").addEventListener("click",async()=>{ 
      if(await ensureAdmin("공지 저장")){ 
          const content = noticeEditor ? noticeEditor.getContents() : "";
          setTodayNotice(content); 
          toast("저장됨"); 
      } 
  });
  
  // 공지 지우기 (에디터도 비우기)
  document.getElementById("btnClearTodayNotice").addEventListener("click",async()=>{ 
      if(await ensureAdmin("공지 지우기")){ 
          clearTodayNotice(); 
          if(noticeEditor) noticeEditor.setContents(""); 
          toast("지워짐"); 
      } 
  });
  
  let logoTap=0, logoT;
  document.getElementById("logoImg").addEventListener("click",async()=>{
    logoTap++; clearTimeout(logoT); logoT=setTimeout(()=>{logoTap=0},1300);
    if(logoTap>=2){ logoTap=0; if(await ensureAdmin("관리자 메뉴")) openAdminMenu(); }
  });

  const noticeOverlay=document.getElementById("noticeOverlay");
  function setRingProgress(p){ const c=2*Math.PI*30; document.getElementById("noticeRing").style.strokeDasharray=`${c}`; document.getElementById("noticeRing").style.strokeDashoffset=`${c*(1-p)}`; }
  async function showNoticeCountdownIfAny(){
    const t=getTodayNotice(); if(!t) return true;
    document.getElementById("noticeText").innerHTML=t; // innerHTML로 변경
    document.getElementById("noticeDateText").textContent=`${todayKey()} 공지`;
    const btn=document.getElementById("noticeOk"), num=document.getElementById("noticeNum");
    btn.disabled=true; noticeOverlay.classList.add("show"); num.textContent="2"; setRingProgress(0);
    return new Promise(r=>{
      let s=Date.now(), tm=setInterval(()=>{
        const e=(Date.now()-s)/1000, p=Math.min(1,e/5); setRingProgress(p);
        num.textContent=String(Math.max(0,5-Math.floor(e)));
        if(p>=1){ clearInterval(tm); btn.disabled=false; noticeOverlay.querySelector(".countWrap").style.display="none"; }
      },60);
      const done=()=>{ clearInterval(tm); noticeOverlay.classList.remove("show"); noticeOverlay.querySelector(".countWrap").style.display=""; btn.removeEventListener("click",done); r(true); };
      btn.addEventListener("click",done);
    });
  }

  const outNoteOverlay=document.getElementById("outNoteOverlay");
  function askOutNote(){
    document.getElementById("outNoteText").value=""; outNoteOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ document.getElementById("outNoteSkip").removeEventListener("click",s); document.getElementById("outNoteSave").removeEventListener("click",sv); /* outNoteOverlay.removeEventListener("click",bg); */ };
      const s=()=>{ c(); outNoteOverlay.classList.remove("show"); r(null); };
      const sv=()=>{ const t=document.getElementById("outNoteText").value; c(); outNoteOverlay.classList.remove("show"); r(t); };
      // const bg=e=>{ if(e.target===outNoteOverlay) s(); };
      document.getElementById("outNoteSkip").addEventListener("click",s); document.getElementById("outNoteSave").addEventListener("click",sv); 
      // outNoteOverlay.addEventListener("click",bg);
    });
  }
  document.querySelectorAll('#outNoteOverlay button[data-cat]').forEach(b=>{
    b.addEventListener("click",()=>{
      const t=document.getElementById("outNoteText"), cat=b.dataset.cat, pre=`[${cat}] `;
      b.classList.add("cat-active"); setTimeout(()=>b.classList.remove("cat-active"),500);
      const v=t.value||"", lines=v.split("\n"); if(lines[lines.length-1].trim()===pre.trim())return;
      t.value=(v.trim()?v.trim()+"\n":"")+pre; t.focus();
    });
  });

  const closeCheckOverlay=document.getElementById("closeCheckOverlay");
  function openCloseCheckModal(items){
    const lst=document.getElementById("closeCheckList"), done=document.getElementById("closeCheckDone");
    lst.innerHTML=items.map((t,i)=>`<label class="checkItem"><input type="checkbox" data-i="${i}" /><div><div class="t">${escapeHtml(t)}</div></div></label>`).join("");
    done.disabled=false; closeCheckOverlay.classList.add("show");
    return new Promise(r=>{
      const c=()=>{ done.removeEventListener("click",d); /* closeCheckOverlay.removeEventListener("click",bg); */ };
      const d=()=>{
        const boxes=lst.querySelectorAll('input[type="checkbox"]');
        if(!Array.from(boxes).every(b=>b.checked)) return toast("모두 체크해주세요","danger");
        c(); closeCheckOverlay.classList.remove("show");
        r({skip:false, items:Array.from(boxes).filter(b=>b.checked).map(b=>items[b.dataset.i]), extra:""});
      };
      // const bg=e=>{if(e.target===closeCheckOverlay){ c(); closeCheckOverlay.classList.remove("show"); r({skip:true,items:[],extra:""}); }};
      done.addEventListener("click",d); 
      // closeCheckOverlay.addEventListener("click",bg);
    });
  }

  const attCode=document.getElementById("attCode"), attName=document.getElementById("attName"), attStatus=document.getElementById("attStatus"), attLast=document.getElementById("attLast");
  function getLastEvent(code){ const logs=getLogs(); for(let i=logs.length-1;i>=0;i--)if(logs[i].code===code)return logs[i]; return null; }
  function canClockIn(code){ const l=getLastEvent(code); return !l||l.type!=="IN"; }
  function canClockOut(code){ const l=getLastEvent(code); return !!l&&l.type==="IN"; }
  function nextLogId(){ const logs=getLogs(); let m=0; for(const l of logs)if(Number(l.id)>m)m=Number(l.id); return m+1; }
  function addLog({code,name,type,note=""}){ const l=getLogs(); l.push({id:nextLogId(),code,name,type,ts:nowTS(),note}); setLogs(l); }
  function onCodeChanged(){
    const c=normalizeCodeInput(attCode.value);
    if(c.length!==4){ attName.value=""; attStatus.textContent="-"; attLast.textContent="-"; return; }
    const e=findEmpByCode(c); attName.value=e?e.name:"";
    if(!e){ attStatus.textContent="미등록 코드"; attLast.textContent="-"; return; }
    const l=getLastEvent(c);
    attStatus.textContent=l&&l.type==="IN"?"출근 상태":"퇴근 상태";
    attLast.textContent=l?`${l.type==="IN"?"출근":"퇴근"} · ${fmtTS(l.ts)}`:"기록 없음";
  }
  attCode.addEventListener("input",onCodeChanged);
  document.getElementById("btnClearCode").addEventListener("click",()=>{attCode.value="";onCodeChanged();});

  document.getElementById("btnIn").addEventListener("click",async()=>{
    const c=attCode.value; if(c.length!==4)return toast("알바생을 선택해주세요");
    const e=findEmpByCode(c); if(!e)return toast("미등록 코드");
    if(!canClockIn(c))return toast("이미 출근 상태");
    await showNoticeCountdownIfAny();
    addLog({code:c,name:e.name,type:"IN"}); toast(`${e.name} 출근`); renderAttendancePanel();
  });
  
  document.getElementById("btnOut").addEventListener("click",async()=>{
    const c=attCode.value; if(c.length!==4)return toast("알바생을 선택해주세요");
    const e=findEmpByCode(c); if(!e)return toast("미등록 코드");
    if(!canClockOut(c))return toast("출근 기록 없음");
    
    let manualNote = await askOutNote();
    let checklistLogStr = "";

    if(e.shiftType==="CLOSE"){
      const res=await openCloseCheckModal(getCloseChecklist());
      if(!res.skip){
        addCloseCheckLog({code:c,name:e.name,items:res.items,extra:res.extra});
        checklistLogStr = `[마감체크] ${res.items.join("/")}`;
      }
    }

    if(manualNote) addOutNote({code:c, name:e.name, text:manualNote});

    let combinedNote = "";
    if(manualNote && checklistLogStr) combinedNote = manualNote + "\n" + checklistLogStr;
    else if(manualNote) combinedNote = manualNote;
    else if(checklistLogStr) combinedNote = checklistLogStr;

    addLog({code:c, name:e.name, type:"OUT", note:combinedNote}); 
    toast(`${e.name} 퇴근`); renderAttendancePanel();
  });

  function renderRecent(){
    document.getElementById("recentTable").innerHTML=getLogs().slice(-15).reverse().map(l=>`<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"출근":"퇴근"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name)}</td><td>${fmtTS(l.ts)}</td></tr>`).join("")||`<tr><td colspan="4" class="muted">기록 없음</td></tr>`;
  }
  function renderQuickButtons(){
    const div=document.getElementById("quickButtons"), emps=getEmployees();
    if(!emps.length) div.innerHTML=`<span class="muted">관리자 메뉴에서 알바생을 등록하세요.</span>`;
    else{
      div.innerHTML=emps.map(e=>`<button class="btn" data-c="${e.code}">${escapeHtml(e.name)} <span class="muted">${e.code}</span></button>`).join("");
      div.querySelectorAll("button").forEach(b=>b.addEventListener("click",()=>{ attCode.value=b.dataset.c; onCodeChanged(); }));
    }
  }
  function renderAttendancePanel(){ renderRecent(); renderQuickButtons(); onCodeChanged(); }

  /* Employee */
  function nextAvailableCode(){ const s=new Set(getEmployees().map(e=>Number(e.code))); for(let i=1;i<=9999;i++)if(!s.has(i))return pad4(i); return pad4(getNextEmpId()); }
  function addEmployee(name,memo,ws,we,st,wage,wageW){
    const emps=getEmployees(), code=nextAvailableCode();
    emps.push({code, name, memo, workStart:ws, workEnd:we, shiftType:st, wage:Number(wage)||0, wageWeekend:Number(wageW)||0, createdAt:nowTS()});
    setEmployees(emps); setNextEmpId(Math.max(getNextEmpId(),Number(code)+1));
  }
  function updateEmployee(code,patch){ const emps=getEmployees(), idx=emps.findIndex(e=>e.code===code); if(idx>=0){ emps[idx]={...emps[idx],...patch}; setEmployees(emps); } }
  document.getElementById("btnAddEmp").addEventListener("click",async()=>{
    if(!await ensureAdmin("등록"))return toast("PIN 필요");
    try{
      const nm=document.getElementById("empName").value.trim(); if(!nm) throw new Error("이름 입력");
      addEmployee(nm, document.getElementById("empMemo").value, document.getElementById("empWorkStart").value, document.getElementById("empWorkEnd").value, document.getElementById("empShiftType").value, document.getElementById("empWage").value, document.getElementById("empWageWeekend").value);
      document.getElementById("empName").value=""; document.getElementById("empMemo").value=""; document.getElementById("empWage").value=""; document.getElementById("empWageWeekend").value="";
      toast("등록 완료"); renderEmployees(); renderQuickButtons();
    }catch(e){ toast(e.message); }
  });
  document.getElementById("btnRefreshEmp").addEventListener("click",renderEmployees);
  document.getElementById("empSearch").addEventListener("input",renderEmployees);
  function renderEmployees(){
    document.getElementById("nextCodeHint").textContent=`다음 코드: ${nextAvailableCode()}`;
    const q=document.getElementById("empSearch").value.toLowerCase(), emps=getEmployees().filter(e=>e.code.includes(q)||e.name.toLowerCase().includes(q));
    document.getElementById("empTable").innerHTML=emps.length?emps.map(e=>`<tr><td><span class="tag open">${e.code}</span></td><td>${escapeHtml(e.name)}</td><td class="muted typeCell">${e.shiftType==="CLOSE"?"마감":"미들"}</td><td class="muted">${(e.wage||0).toLocaleString()} / ${e.wageWeekend ? e.wageWeekend.toLocaleString() : '-'}</td><td class="muted timeCell">${e.workStart}~${e.workEnd}</td><td style="text-align:right;"><button class="btn small" onclick="window.editEmp('${e.code}')">수정</button> <button class="btn small bad" onclick="window.delEmp('${e.code}')">삭제</button></td></tr>`).join("") : `<tr><td colspan="6" class="muted">없음</td></tr>`;
  }
  window.delEmp=async(c)=>{ if(await ensureAdmin("삭제") && confirm("이 알바생의 '모든 출퇴근 기록'도 함께 삭제할까요?\n(테스트용 알바생이었다면 '확인'을 누르세요.)")){ 
    const l=getEmployees().filter(e=>e.code!==c); 
    setEmployees(l); 
    const allLogs = getLogs().filter(log => log.code !== c);
    setLogs(allLogs);
    toast("삭제됨"); renderEmployees(); renderQuickButtons(); renderAttendancePanel(); renderLogAll();
  } else if(await ensureAdmin("삭제")) {
    const l=getEmployees().filter(e=>e.code!==c); 
    setEmployees(l); 
    toast("삭제됨"); renderEmployees(); renderQuickButtons();
  }};
  window.editEmp=async(c)=>{
    if(!await ensureAdmin("수정"))return;
    const e=findEmpByCode(c); if(!e)return;
    document.getElementById("empEditCode").value=e.code; document.getElementById("empEditName").value=e.name;
    document.getElementById("empEditShiftType").value=e.shiftType||"MID"; document.getElementById("empEditWage").value=e.wage||"";
    document.getElementById("empEditWageWeekend").value=e.wageWeekend||"";
    document.getElementById("empEditMemo").value=e.memo||""; document.getElementById("empEditWorkStart").value=e.workStart||"17:00"; document.getElementById("empEditWorkEnd").value=e.workEnd||"23:30";
    document.getElementById("empEditOverlay").classList.add("show");
  };
  document.getElementById("empEditSave").addEventListener("click",()=>{
    const c=document.getElementById("empEditCode").value, n=document.getElementById("empEditName").value.trim();
    if(!n)return toast("이름 입력");
    updateEmployee(c,{
      name:n, shiftType:document.getElementById("empEditShiftType").value,
      wage:Number(document.getElementById("empEditWage").value)||0,
      wageWeekend:Number(document.getElementById("empEditWageWeekend").value)||0,
      memo:document.getElementById("empEditMemo").value,
      workStart:document.getElementById("empEditWorkStart").value, workEnd:document.getElementById("empEditWorkEnd").value
    });
    document.getElementById("empEditOverlay").classList.remove("show"); toast("수정 완료"); renderEmployees(); renderQuickButtons(); renderLogAll();
  });
  document.getElementById("empEditCancel").addEventListener("click",()=>document.getElementById("empEditOverlay").classList.remove("show"));

  /* Logs & Calendar & Wage Logic */
  let calYear=new Date().getFullYear(), calMonth=new Date().getMonth()+1;
  function getDayKey(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
  
  function getAdjustedStartTime(emp, inTs) {
    if (!emp.workStart) return inTs;
    const d = new Date(inTs);
    const [h, m] = emp.workStart.split(':').map(Number);
    const scheduledStart = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    if (inTs < scheduledStart) return scheduledStart; 
    return inTs;
  }

  function getAdjustedWorkTime(emp, inTs, outTs) {
    // shiftType에 상관없이 workEnd가 있으면 적용
    if (!emp.workEnd) return outTs;
    const d = new Date(inTs);
    const [h, m] = emp.workEnd.split(':').map(Number);
    let scheduledEnd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0).getTime();
    if (scheduledEnd < inTs) { scheduledEnd += 24 * 60 * 60 * 1000; }
    
    const safetyMs = 60 * 60 * 1000; 
    if (outTs < scheduledEnd) {
      if (scheduledEnd - outTs > safetyMs) return outTs;
      return scheduledEnd;
    } else {
      const diff = outTs - scheduledEnd;
      const tenMins = 10 * 60 * 1000;
      const extra = Math.floor(diff / tenMins) * tenMins;
      return scheduledEnd + extra;
    }
  }

  function calcDayStats(dk, tCode){
    const logs=getLogs().filter(l=>dateKey(l.ts)===dk && (!tCode||l.code===tCode)).sort((a,b)=>a.ts-b.ts);
    let ms=0, pay=0, codeMap={};
    logs.forEach(l=>{ if(!codeMap[l.code])codeMap[l.code]=[]; codeMap[l.code].push(l); });
    Object.keys(codeMap).forEach(c=>{
      const e=findEmpByCode(c);
      let inTs=null;
      const evts=codeMap[c];
      const dateObj = new Date(dk);
      const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
      const wage = (e && isWeekend && e.wageWeekend) ? e.wageWeekend : (e ? e.wage : 0);

      evts.forEach(ev=>{
        if(ev.type==="IN") inTs=ev.ts;
        else if(ev.type==="OUT" && inTs){
          const adjInTs = getAdjustedStartTime(e, inTs);
          const adjOutTs = getAdjustedWorkTime(e, inTs, ev.ts);
          if(adjOutTs > adjInTs) {
             const d=adjOutTs-adjInTs; ms+=d;
             pay+=Math.floor((d/3600000)*wage);
          }
          inTs=null;
        }
      });
    });
    return { h:Math.floor(ms/3600000), m:Math.floor((ms%3600000)/60000), pay, has:logs.length>0 };
  }

  function getWeeklyJuhyuSum(sundayDate, filterCode){
     const endTs = new Date(sundayDate).setHours(23,59,59,999);
     const startDate = new Date(sundayDate); startDate.setDate(startDate.getDate() - 6);
     const startTs = startDate.setHours(0,0,0,0);
     const allLogs = getLogs();
     const employees = getEmployees().filter(e => !filterCode || e.code === filterCode);
     let totalJuhyu = 0;
     employees.forEach(emp => {
       const logs = allLogs.filter(l => l.code === emp.code && l.ts >= startTs && l.ts <= endTs).sort((a,b)=>a.ts-b.ts);
       let ms = 0;
       logs.forEach(l => {
         if(l.type==='IN') l._tIn = l.ts;
         else if(l.type==='OUT') {
           const prevIn = logs.find(x => x.type === 'IN' && x.ts < l.ts && !x._used);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) ms += (adjOutTs - adjInTs); 
             prevIn._used = true; 
           }
         }
       });
       logs.forEach(l => delete l._used);
       const hours = ms / 3600000;
       if(hours >= 15) {
          const juhyuHours = (Math.min(hours, 40) / 40) * 8;
          totalJuhyu += Math.floor(juhyuHours * emp.wage);
       }
     });
     return totalJuhyu;
  }

  function renderCalendar(){
    const g=document.getElementById("calendarView"); if(!g)return;
    document.getElementById("calTitle").textContent=`${calYear}. ${String(calMonth).padStart(2,"0")}`;
    while(g.children.length>7) g.removeChild(g.lastChild);
    const start=new Date(calYear,calMonth-1,1).getDay(), end=new Date(calYear,calMonth,0).getDate(), tFilter=document.getElementById("logFilterEmp").value;
    for(let i=0;i<start;i++){ const d=document.createElement("div"); d.className="calDay empty"; g.appendChild(d); }
    for(let d=1;d<=end;d++){
      const div=document.createElement("div"); div.className="calDay";
      const dateObj = new Date(calYear, calMonth-1, d);
      const k=getDayKey(calYear,calMonth,d); if(k===todayKey())div.classList.add("today");
      const st=calcDayStats(k, tFilter);
      let inner = `<div class="calNum">${d}</div>`;
      if(dateObj.getDay() === 0) { 
         const juhyu = getWeeklyJuhyuSum(dateObj, tFilter);
         if(juhyu > 0) inner += `<span class="tag juhyu">주휴💰 +${juhyu.toLocaleString()}</span>`;
      }
      if(st.has) inner += `<div class="calData"><span class="calTime">${st.h>0?st.h+'h ':''}${st.m}m</span>${st.pay>0?`<span class="calPay">${st.pay.toLocaleString()}원</span>`:''}</div>`;
      div.innerHTML = inner;
      g.appendChild(div);
    }
    updateMonthlyWageEstimate(); 
  }
  document.getElementById("calPrevBtn").addEventListener("click",()=>{ calMonth--; if(calMonth<1){calMonth=12;calYear--;} renderCalendar(); });
  document.getElementById("calNextBtn").addEventListener("click",()=>{ calMonth++; if(calMonth>12){calMonth=1;calYear++;} renderCalendar(); });

  function updateMonthlyWageEstimate() {
    const tEmp = document.getElementById("logFilterEmp").value;
    document.getElementById("totalWageTitle").textContent = `${calMonth}월 예상 급여 ${tEmp ? '(선택된 알바생)' : '(전체)'}`;
    const targetPrefix = `${calYear}-${String(calMonth).padStart(2,"0")}`;
    const allLogs = getLogs();
    const currentMonthLogs = allLogs.filter(l => dateKey(l.ts).startsWith(targetPrefix));
    const employees = getEmployees().filter(e => !tEmp || e.code === tEmp);
    let totalBase = 0;
    let totalJuhyu = 0;
    employees.forEach(emp => {
      const empLogs = currentMonthLogs.filter(l => l.code === emp.code).sort((a,b)=>a.ts-b.ts);
      let empBaseMs = 0;
      empLogs.forEach(l => {
        if(l.type === 'IN') l._tempIn = l.ts;
        else if(l.type === 'OUT') {
           const prevIn = empLogs.find(xx => xx.type === 'IN' && xx.ts < l.ts && !x._usedBase);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) {
               const ms = adjOutTs - adjInTs;
               const dt = new Date(l.ts);
               const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;
               const wage = (isWeekend && emp.wageWeekend) ? emp.wageWeekend : emp.wage;
               totalBase += Math.floor((ms / 3600000) * wage);
             }
             prevIn._usedBase = true; 
           }
        }
      });
      empLogs.forEach(l => delete l._usedBase);
      const allEmpLogs = allLogs.filter(l => l.code === emp.code).sort((a,b)=>a.ts-b.ts);
      const weeks = {};
      allEmpLogs.forEach(l => {
        const d = new Date(l.ts);
        const day = d.getDay(); 
        const dist = day === 0 ? 0 : 7 - day;
        const sundayDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + dist);
        const sundayKey = `${sundayDate.getFullYear()}-${String(sundayDate.getMonth()+1).padStart(2,"0")}-${String(sundayDate.getDate()).padStart(2,"0")}`;
        if (!weeks[sundayKey]) weeks[sundayKey] = { ms: 0 };
        if(l.type === 'IN') l._tempIn = l.ts;
        else if(l.type === 'OUT') {
           const prevIn = allEmpLogs.find(xx => xx.type === 'IN' && xx.ts < l.ts && !xx._usedJuhyu);
           if(prevIn) { 
             const adjInTs = getAdjustedStartTime(emp, prevIn.ts);
             const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
             if(adjOutTs > adjInTs) weeks[sundayKey].ms += (adjOutTs - adjInTs); 
             prevIn._usedJuhyu = true; 
           }
        }
      });
      allEmpLogs.forEach(l => delete l._usedJuhyu);
      Object.keys(weeks).forEach(sundayKey => {
        if (sundayKey.startsWith(targetPrefix)) {
          const hours = weeks[sundayKey].ms / 3600000;
          if(hours >= 15) {
            const juhyu = Math.floor( ((Math.min(hours, 40)/40)*8) * emp.wage );
            totalJuhyu += juhyu;
          }
        }
      });
    });
    document.getElementById("totalWageAmount").textContent = (totalBase + totalJuhyu).toLocaleString() + "원";
    document.getElementById("totalWageDetail").textContent = `(기본 ${totalBase.toLocaleString()} + 주휴 ${totalJuhyu.toLocaleString()})`;
  }

  function renderLogFilterOptions(){
    const sel=document.getElementById("logFilterEmp"), old=sel.value;
    sel.innerHTML=`<option value="">전체 알바생</option>`+getEmployees().map(e=>`<option value="${e.code}">${e.code} ${escapeHtml(e.name)}</option>`).join("");
    sel.value=old;
  }
  document.getElementById("logFilterEmp").addEventListener("change",renderLogAll);

  function renderLogAll(){
    const f=document.getElementById("logFilterEmp").value, all=getLogs(), list=f?all.filter(l=>l.code===f):all;
    document.getElementById("logTotal").textContent=list.length;
    const makeNoteTag = (note) => {
      if(!note) return "";
      let tags = "";
      if(note.includes("[마감체크]")) tags += `<span class="tag good" style="margin-right:4px;">마감✅</span>`;
      if(note.includes("[누락]") || note.includes("[환불]") || note.includes("[물품]") || note.includes("[기타]")) tags += `<span class="tag warn" style="margin-right:4px;">특이📝</span>`;
      if(note.includes("수동추가")) tags += `<span class="tag" style="background:#eee; color:#888;">수동</span>`;
      if(!tags) return note.length > 10 ? note.slice(0,10)+"..." : note;
      return tags;
    };
    
    document.getElementById("logTable").innerHTML=list.slice().reverse().map(l=> {
        let timeDisplay = fmtTS(l.ts);
        const emp = findEmpByCode(l.code);
        
        // 출근 시간 보정 표시
        if(l.type === "IN" && emp) {
            const adjInTs = getAdjustedStartTime(emp, l.ts);
            if(adjInTs !== l.ts) {
                const d = new Date(adjInTs);
                const adjStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
                timeDisplay += `<br><span class="tag adj">급여시작: ${adjStr}</span>`;
            }
        }
        
        // 퇴근 시간 보정 표시
        if(l.type === "OUT" && emp) {
            const prevIn = list.find(x => x.type === "IN" && x.ts < l.ts && x.code === l.code);
            if(prevIn) {
                const adjOutTs = getAdjustedWorkTime(emp, prevIn.ts, l.ts);
                if(adjOutTs !== l.ts) {
                    const d = new Date(adjOutTs);
                    const adjStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
                    timeDisplay += `<br><span class="tag adj">급여종료: ${adjStr}</span>`;
                }
            }
        }
        return `<tr><td><span class="tag ${l.type.toLowerCase()}">${l.type==="IN"?"출근":"퇴근"}</span></td><td>${l.code}</td><td class="nameCell">${escapeHtml(l.name||"")}</td><td>${timeDisplay}</td><td>${makeNoteTag(l.note)}</td><td><button class="btn small" onclick="window.editLog(${l.id})">수정</button></td></tr>`;
    }).join("")||`<tr><td colspan="6" class="muted">기록 없음</td></tr>`;
    
    const ons=getOutNotes().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("outNoteTable").innerHTML=ons.map((x,i)=>`<tr><td>${ons.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml(x.text)}</td></tr>`).join("");
    const cls=getCloseCheckLogs().slice().reverse().filter(x=>!f||x.code===f);
    document.getElementById("closeCheckTable").innerHTML=cls.map((x,i)=>`<tr><td>${cls.length-i}</td><td>${x.date}</td><td>${x.code}</td><td>${escapeHtml(x.name)}</td><td>${fmtTS(x.ts)}</td><td>${escapeHtml((x.items||[]).join("/"))}</td></tr>`).join("");
    renderCalendar();
  }

  window.editLog=async(id)=>{ if(!await ensureAdmin("수정"))return; const l=getLogs().find(x=>x.id===id); if(!l)return; document.getElementById("logEditCode").value=l.code; document.getElementById("logEditName").value=l.name||""; document.getElementById("logEditType").value=l.type; const d=new Date(l.ts); document.getElementById("logEditTs").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}T${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; document.getElementById("logEditNote").value=l.note||""; document.getElementById("logEditSave").onclick=()=>{ const ts=new Date(document.getElementById("logEditTs").value).getTime(); if(!ts)return toast("시간 확인"); const logs=getLogs(), idx=logs.findIndex(x=>x.id===id); if(idx>=0){ logs[idx]={...logs[idx], type:document.getElementById("logEditType").value, ts, note:document.getElementById("logEditNote").value}; setLogs(logs); } document.getElementById("logEditOverlay").classList.remove("show"); toast("수정됨"); renderLogAll(); renderAttendancePanel(); }; document.getElementById("logEditDelete").onclick=()=>{ if(confirm("삭제?")){ setLogs(getLogs().filter(x=>x.id!==id)); document.getElementById("logEditOverlay").classList.remove("show"); toast("삭제됨"); renderLogAll(); renderAttendancePanel(); } }; document.getElementById("logEditOverlay").classList.add("show"); };
  document.getElementById("logEditCancel").addEventListener("click",()=>document.getElementById("logEditOverlay").classList.remove("show"));

  document.getElementById("btnAddShift").addEventListener("click",async()=>{ if(!await ensureAdmin("추가"))return; const emps=getEmployees(); if(!emps.length)return toast("알바생 없음"); document.getElementById("logAddEmp").innerHTML=emps.map(e=>`<option value="${e.code}">${e.code} ${e.name}</option>`).join(""); const t=new Date(); document.getElementById("logAddDate").value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`; document.getElementById("logAddOverlay").classList.add("show"); });
  document.getElementById("logAddSave").addEventListener("click",()=>{ const c=document.getElementById("logAddEmp").value, e=findEmpByCode(c), dt=document.getElementById("logAddDate").value, md=document.getElementById("logAddMode").value, inT=document.getElementById("logAddInTime").value, outT=document.getElementById("logAddOutTime").value, mkTs=(t)=>new Date(`${dt}T${t}`).getTime(); if(md==="SHIFT"){ addLog({code:c,name:e.name,type:"IN",note:"수동추가"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); addLog({code:c,name:e.name,type:"OUT",note:"수동추가"}); const l2=getLogs(); l2[l2.length-1].ts=mkTs(outT); setLogs(l2); } else if(md==="IN"){ addLog({code:c,name:e.name,type:"IN",note:"수동추가"}); const l=getLogs(); l[l.length-1].ts=mkTs(inT); setLogs(l); } else{ addLog({code:c,name:e.name,type:"OUT",note:"수동추가"}); const l=getLogs(); l[l.length-1].ts=mkTs(outT); setLogs(l); } document.getElementById("logAddOverlay").classList.remove("show"); toast("추가됨"); renderLogAll(); renderAttendancePanel(); });
  document.getElementById("logAddCancel").addEventListener("click",()=>document.getElementById("logAddOverlay").classList.remove("show"));

  function downloadFile(fn,txt,mime){ const b=new Blob([txt],{type:mime}), a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=fn; document.body.appendChild(a); a.click(); a.remove(); }
  function exportCsv(){ const f=document.getElementById("logFilterEmp").value, l=getLogs().filter(x=>!f||x.code===f); const csv="id,type,code,name,ts,time,note\n"+l.map(x=>`${x.id},${x.type},${x.code},"${x.name}",${x.ts},"${fmtTS(x.ts)}","${(x.note||"").replace(/"/g,'""')}"`).join("\n"); downloadFile(`근태_${todayKey()}.csv`,csv,"text/csv;charset=utf-8"); }
  document.getElementById("btnExportCsv").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  document.getElementById("btnExportCsv2").addEventListener("click",async()=>{ if(await ensureAdmin())exportCsv(); });
  
  // 백업/복원 이벤트 제거됨

  document.getElementById("btnResetAll").addEventListener("click",async()=>{
    if(!await ensureAdmin("전체 초기화")) return;
    
    // 1. 확인 입력 요구
    const answer = prompt("⚠️ 경고: 모든 데이터가 영구 삭제됩니다.\n동의하시면 '전체삭제' 라고 입력하세요.");
    if(answer !== "전체삭제") return toast("취소되었습니다.");

    // 2. 비상용 자동 백업
    try {
      const d = { ver: 1, at: nowTS(), emps: getEmployees(), logs: getLogs(), notices: getNoticeMap(), out: getOutNotes(), closeLogs: getCloseCheckLogs() };
      downloadFile(`비상백업_초기화전_${todayKey()}.json`, JSON.stringify(d, null, 2), "application/json");
      toast("비상 백업 파일이 다운로드되었습니다.");
    } catch(e) {
      if(!confirm("백업 다운로드에 실패했습니다. 그래도 삭제할까요?")) return;
    }

    // 3. 실제 삭제
    localStorage.clear();
    await set(ref(db, 'tamnaData'), null);
    alert("초기화 완료.");
    location.reload();
  });

  function renderAdminCloseChecklist(){ const lst=document.getElementById("adminCloseChecklistList"), items=getCloseChecklist(); lst.innerHTML=items.map((t,i)=>`<div class="admCLRow"><div class="idx">${i+1}</div><input class="admCLInput" value="${escapeHtml(t)}" /><button class="btn small" onclick="delCLItem(${i})">삭제</button></div>`).join(""); }
  window.delCLItem=async(i)=>{ const l=getCloseChecklist(); l.splice(i,1); setCloseChecklist(l); renderAdminCloseChecklist(); };
  document.getElementById("btnAddCloseChecklistItem").addEventListener("click",()=>{ const v=document.getElementById("adminCloseNewItem").value.trim(); if(!v)return; const l=getCloseChecklist(); l.push(v); setCloseChecklist(l); document.getElementById("adminCloseNewItem").value=""; renderAdminCloseChecklist(); });
  document.getElementById("btnSaveCloseChecklist").addEventListener("click",()=>{ const l=Array.from(document.querySelectorAll(".admCLInput")).map(i=>i.value.trim()).filter(Boolean); setCloseChecklist(l); toast("저장됨"); renderAdminCloseChecklist(); });
  document.getElementById("btnResetCloseChecklist").addEventListener("click",()=>{ localStorage.removeItem(LS_KEYS.CLOSE_CHECKLIST); renderAdminCloseChecklist(); });

  (async()=>{ renderAttendancePanel(); updateAdminStateText(); })();
</script>
</body>
</html>
